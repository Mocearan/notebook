# H264

---

​		相对于静态的JPEG编码，ISO针对视频也指定了标准：Motion JPEG即MPEG。

​		MPEG算法是适用于动态视频的压缩算法，它除了对单幅图像进行编码外，还利用图像序列中的相关原则去除冗余，这样可以大大提高视频的压缩比。

>  		Mpeg1（用于VCD）、Mpeg2（用于DVD）、Mpeg4 AVC（现在流媒体使用最多的就是它了）

​		H264是一种视频压缩的标准，与H265、SVAC等压缩方式一样，主要目的是对视频流进行压缩，以便减少网络传输对网络带宽的占用.

> [视频编解码_取次花丛懒回顾的博客-CSDN博客](https://yinwenjie.blog.csdn.net/category_1914693.html)
>
> [先进视频压缩编码(Advanced Video Coding, H.264/AVC)_取次花丛懒回顾的博客-CSDN博客](https://blog.csdn.net/shaqoneal/category_9267755.html)

​		H.264，同时也是MPEG-4第十部分，是由ITU-T视频编码专家组（VCEG）和ISO/IEC动态图像专家组（MPEG）联合组成的联合视频组（JVT，Joint Video Team）提出的高度压缩数字视频编解码器标准。这个标准通常被称之为H.264/AVC（或者AVC/H.264或者H.264/MPEG-4 AVC或MPEG-4/H.264 AVC）而明确的说明它两方面的开发者。

​		H.264创造了多参考帧、多块类型、整数变换、帧内预测等新的压缩技术，使用了更精细的分像素运动矢量（1/4、1/8）和新一代的环路滤波器，这使得压缩性能得到大大提高，系统也变得更加完善。

## 组件

​	H.264标准各主要部分有

- Access Unit delimiter（访问单元分割符），SEI（附加增强信息）
- primary coded picture（基本图像编码）
- Redundant Coded Picture（冗余图像编码）
- 还有Instantaneous Decoding Refresh（IDR，即时解码刷新）
- Hypothetical Reference Decoder（HRD，假想参考解码）
- Hypothetical Stream Scheduler（HSS，假想码流调度器）



## 帧类型

- I帧，为关键帧
  - 采用帧内压缩技术。
  - 通过H264压缩算法解对完整帧数据进行压缩，不依赖其前后帧数据，直接可以解压成raw数据
- P帧，为向前参考帧
  - 采用帧间压缩技术
  - P帧解码不能单独解析，需要参考前面的I帧或P帧
  - 如果其前面帧有丢失，会导致花屏。
- B帧，为双向参考帧
  - 采用帧间压缩技术
  - 解码是需要前面帧及后面帧同时参与

​		在baseline编码规格下，无B帧；在main profile规格下一般有B帧，通常来说B帧参与编码会提高压缩率，降低帧大小，但是会增加编解码复杂性。

## 帧结构

- IDR（instantaneous Decoding Refresh），即时刷新帧

  ​		I帧和IDR帧都是使用帧内预测的，是同一个东西，在编码和解码中为了方便。首个I帧和其他I帧区别开，所以才把首个I帧叫IDR帧，方便控制编码和解码的流程。

  ​		![在这里插入图片描述](https://img-blog.csdnimg.cn/dd2f694073544d74931dd4b9839b324a.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/52b2b2e01e314ced9dd9dd5ccaf9f06b.png)



## 码流组成

​		H264分层能够分成两层：

- VCL层(视频编码层)

  - 包含的是具体的H264视频内容

- NAL层(网络提取层)

  - 负责把网络视频流进行打包和传送

  > 对于开发来说，VCL层不怎么需要去关心

​		通常来说，一个原始的H.264 NALU 单元常由` [StartCode] [NALU Header] [NALU Payload]`。三部分组成，其中 Start Code 用于标示这是一个NALU 单元的开始，必须是"00 00 00 01" 或"00 00 01"

> **00 00 00 01 06 05 SEI数据**：是视频的附加增强信息，它包含了一些用户自定义的数据，如时间戳，字幕，弹幕等信息。SEI信息一般放在编码图像之前，很多时候SEI可以被忽略。
>
> **00 00 00 01 67 SPS数据**：指的是序列参数集，它保存了一组编码视频序列的全局参数。编码视频序列指的是原始数据经过编码后组成的一系列序号集。
>
> **00 00 00 01 68 PPS数据**：指的是图像参数集，主要用于保存图像序列集中一个或者多个独立的图像。一般情况下，配合SPS和PPS都是H264开头的两个NALU头。
>
> **00 00 00 01 65 IDR数据**：IDR指的是H264的一帧完整的图像数据，也就是我们经常说的关键帧。

**SODB(String ofData Bits)数据比特串**：最原始的编码数据，即VCL数据，没有任何附加数据。

**RBSP(Raw ByteSequence Payload)原始字节序列载荷**：在SODB的后面填加了结尾比特（RBSP trailing bits），一个bit“1”，若干bit “0”，以便字节对齐；

**EBSP(EncapsulationByte Sequence Packets)扩展字节序列载荷**：在RBSP基础上填加了仿校验字节（0X03）。它的原因是：在NALU加到Annexb上时，需要添加每组NALU之前的开始码StartCodePrefix，如果该NALU对应的slice为一帧的开始则用4位字节表示，ox00000001，否则用3位字节表示ox000001（是一帧的一部分）。解码器检测每个起始码，作为一个NAL的起始标识，当检测到下一个起始码时，当前NAL结束。对于NAL中数据出现0x000001或0x000000时，H.264引入了防止竞争机制，如果编码器遇到两个字节连续为0，就插入一个字节的0x03。解码时将0x03去掉，也称为脱壳操作。

## NALU

​		H264编码后的码流由NAL（网络抽象层）和VCL（视频编码层）构成。VCL数据传输或者存储之前，会被映射到一个NALU中。		H.264的编码帧序列包括一系列的NAL单元，每个NAL单元包含一个RBSP，单元的信息头定义了RBSP单元的类型，NAL单元其余部分为RBSP数据。

### 结构

​		NALU头前通常包含一个 StartCode，StartCode 必须是` 0x00 00 00 01` 或者 `0x00 00 01`，紧接着就是一个字节的`nalu header`

```c
/*
0 1   3			8
-----------------
|F|NRI|  Type	|
-----------------
*/
```

- `F (forbidden_zero_bit)`， 屏蔽位，1bit

  - 正常状态下应该为0
  - 如果1应该舍弃

- `NRI (nal_ref_idc)`， 标识当前NALU的重要性等级，2比特

  - 取值 0-3
  - 值越大标识当前NALU越重要，如果取 00则可以丢弃
  - 如果当前NALU属于参考帧的数据，或者是序列参数集，图像参数集等重要信息，则该值必须大于0

- `Type`，数据类型，5bit

  - 取值 0 ~ 31

  - ```c
    0x67 (0 11 00111) SPS		非常重要     		type = 7
    0x68 (0 11 01000) PPS		非常重要     		type = 8
    0x65 (0 11 00101) IDR  		关键帧  非常重要	  type = 5
    0x61 (0 10 00001) I帧      	重要             	 type = 1
    0x41 (0 10 00001) P帧      	重要             	 type = 1
    0x01 (0 00 00001) B帧      	不重要           	type = 1
    0x06 (0 00 00110) SEI      	不重要           	 type = 6
    ```

![在这里插入图片描述](https://img-blog.csdnimg.cn/24108af7d6274f40a70c81715a52246d.png)



### 实例

![IDR](https://raw.githubusercontent.com/Mocearan/picgo-server/main/241d2a02f0b9601233f143be3da2fa19.png)

- `00 00 00 01 09`，其中00000001是帧起始位标识，09是nalu header，二进制为00001001，F(7位）为0标识非禁止，NRI（56位）为0标识可丢弃帧，type（04位）为9，表示分隔符，此帧可丢弃，表示分隔符
- `00000001 67`，同上面的分析，NALU头为67，二进制为01100111，F=0，NRI=3，type=7，帧类型为SPS帧，非常重要不可丢弃
- `00000001 68`，NALU头为68，二进制为01101000，F=0，NRI=3，type=8，帧类型为PPS帧，非常重要不可丢弃
- `00000001 06`，NALU头为06，二进制为00000110，F=0，NRI=0，type=6，帧类型为SEI，可丢弃
- `00000001 65`，NALU头为65，二进制为01100101，F=0，NRI=3，type=5，帧类型为I帧，非常重要不可丢弃

> 从上面的分析可以看出，IDR（SPS/PPS/I)帧通常一起出现，极少数编码单独出现I帧，但是IDR与I帧单独出现也符合规范。

### 分片NALU

​	`7C`开头是分片NALU，后面一般为`85/05/45`

- `7C 85`，转化为65并加入包头
- `7C 45`，直接去除
- `7C 05`，直接去除