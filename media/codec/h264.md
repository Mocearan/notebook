# H264

---

​		H264是一种视频压缩的标准，与H265、SVAC等压缩方式一样，主要目的是对视频流进行压缩，以便减少网络传输对网络带宽的占用，H264压缩后的帧类型分为I帧/P帧/B帧。

- I帧，为关键帧
  - 采用帧内压缩技术。
  - 通过H264压缩算法解对完整帧数据进行压缩，不依赖其前后帧数据，直接可以解压成raw数据
- P帧，为向前参考帧
  - 采用帧间压缩技术
  - P帧解码不能单独解析，需要参考前面的I帧或P帧
  - 如果其前面帧有丢失，会导致花屏。
- B帧，为双向参考帧
  - 采用帧间压缩技术
  - 解码是需要前面帧及后面帧同时参与

​		在baseline编码规格下，无B帧；在main profile规格下一般有B帧，通常来说B帧参与编码会提高压缩率，降低帧大小，但是会增加编解码复杂性。

## 帧结构

- IDR（instantaneous Decoding Refresh），即时刷新帧

  ​		I帧和IDR帧都是使用帧内预测的，是同一个东西，在编码和解码中为了方便。首个I帧和其他I帧区别开，所以才把首个I帧叫IDR帧，方便控制编码和解码的流程。

  ​		![在这里插入图片描述](https://img-blog.csdnimg.cn/dd2f694073544d74931dd4b9839b324a.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/52b2b2e01e314ced9dd9dd5ccaf9f06b.png)



## NALU

​		H264编码后的码流由NAL（网络抽象层）和VCL（视频编码层）构成。VCL数据传输或者存储之前，会被映射到一个NALU中。		H.264的编码帧序列包括一系列的NAL单元，每个NAL单元包含一个RBSP，单元的信息头定义了RBSP单元的类型，NAL单元其余部分为RBSP数据。

### 结构

​		NALU头前通常包含一个 StartCode，StartCode 必须是` 0x00 00 00 01` 或者 `0x00 00 01`，紧接着就是一个字节的`nalu header`

```c
/*
0 1   3			8
-----------------
|F|NRI|  Type	|
-----------------
*/
```

- `F (forbidden_zero_bit)`， 屏蔽位，1bit

  - 正常状态下应该为0
  - 如果1应该舍弃

- `NRI (nal_ref_idc)`， 标识当前NALU的重要性等级，2比特

  - 取值 0-3
  - 值越大标识当前NALU越重要，如果取 00则可以丢弃
  - 如果当前NALU属于参考帧的数据，或者是序列参数集，图像参数集等重要信息，则该值必须大于0

- `Type`，数据类型，5bit

  - 取值 0 ~ 31

  - ```c
    0x67 (0 11 00111) SPS		非常重要     		type = 7
    0x68 (0 11 01000) PPS		非常重要     		type = 8
    0x65 (0 11 00101) IDR  		关键帧  非常重要	  type = 5
    0x61 (0 10 00001) I帧      	重要             	 type = 1
    0x41 (0 10 00001) P帧      	重要             	 type = 1
    0x01 (0 00 00001) B帧      	不重要           	type = 1
    0x06 (0 00 00110) SEI      	不重要           	 type = 6
    ```

![在这里插入图片描述](https://img-blog.csdnimg.cn/24108af7d6274f40a70c81715a52246d.png)



### 实例

![IDR](https://raw.githubusercontent.com/Mocearan/picgo-server/main/241d2a02f0b9601233f143be3da2fa19.png)

- `00 00 00 01 09`，其中00000001是帧起始位标识，09是nalu header，二进制为00001001，F(7位）为0标识非禁止，NRI（56位）为0标识可丢弃帧，type（04位）为9，表示分隔符，此帧可丢弃，表示分隔符
- `00000001 67`，同上面的分析，NALU头为67，二进制为01100111，F=0，NRI=3，type=7，帧类型为SPS帧，非常重要不可丢弃
- `00000001 68`，NALU头为68，二进制为01101000，F=0，NRI=3，type=8，帧类型为PPS帧，非常重要不可丢弃
- `00000001 06`，NALU头为06，二进制为00000110，F=0，NRI=0，type=6，帧类型为SEI，可丢弃
- `00000001 65`，NALU头为65，二进制为01100101，F=0，NRI=3，type=5，帧类型为I帧，非常重要不可丢弃

> 从上面的分析可以看出，IDR（SPS/PPS/I)帧通常一起出现，极少数编码单独出现I帧，但是IDR与I帧单独出现也符合规范。

### 分片NALU

​	`7C`开头是分片NALU，后面一般为`85/05/45`

- `7C 85`，转化为65并加入包头
- `7C 45`，直接去除
- `7C 05`，直接去除