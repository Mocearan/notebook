# H265

---

​		H265作为新的视频编码标准，应用越来越广发，相较于H264，其在高压缩率、高鲁棒性和错误恢复能力、低延时等方面有很更好的表现，因此H265（HEVC）也在越来越多的场景下逐步替代H264。



## NALU

​		与h264的nal层相比，h265的nal unit header有两个字节构成

- hevc加入了`nal`所在的时间层的TID 
- 去除了`nal_ref_idc`

![HEVC](https://raw.githubusercontent.com/Mocearan/picgo-server/main/7c869c74299a5f4660c91def74316d83.png)

- F:禁止位，1bit(最高位：15位),必须是0，为1标识无效帧

- Type: 帧类型，6bits(9~14位)

  - 0-31是vcl nal单元

    - VCL是指携带编码数据的数据流

  - 32-63，是非vcl nal单元

    - 而non-VCL则是控制数据流。

  - ![image-20240623190747684](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20240623190747684.png)

  - ```c++
     enum NalUnitType
    {
      NAL_UNIT_CODED_SLICE_TRAIL_N = 0,   // 0
      NAL_UNIT_CODED_SLICE_TRAIL_R,   // 1
      
      NAL_UNIT_CODED_SLICE_TSA_N,     // 2
      NAL_UNIT_CODED_SLICE_TLA,       // 3   // Current name in the spec: TSA_R
      
      NAL_UNIT_CODED_SLICE_STSA_N,    // 4
      NAL_UNIT_CODED_SLICE_STSA_R,    // 5
     
      NAL_UNIT_CODED_SLICE_RADL_N,    // 6
      NAL_UNIT_CODED_SLICE_DLP,       // 7 // Current name in the spec: RADL_R
      
      NAL_UNIT_CODED_SLICE_RASL_N,    // 8
      NAL_UNIT_CODED_SLICE_TFD,       // 9 // Current name in the spec: RASL_R
     
      NAL_UNIT_RESERVED_10,
      NAL_UNIT_RESERVED_11,
      NAL_UNIT_RESERVED_12,
      NAL_UNIT_RESERVED_13,
      NAL_UNIT_RESERVED_14,
      NAL_UNIT_RESERVED_15, NAL_UNIT_CODED_SLICE_BLA,       // 16   // Current name in the spec: BLA_W_LP
    NAL_UNIT_CODED_SLICE_BLA,       // 16   // Current name in the spec: BLA_W_LP
      NAL_UNIT_CODED_SLICE_BLANT,     // 17   // Current name in the spec: BLA_W_DLP
      NAL_UNIT_CODED_SLICE_BLA_N_LP,  // 18
      NAL_UNIT_CODED_SLICE_IDR,       // 19  // Current name in the spec: IDR_W_DLP
      NAL_UNIT_CODED_SLICE_IDR_N_LP,  // 20
      NAL_UNIT_CODED_SLICE_CRA,       // 21
      NAL_UNIT_RESERVED_22,
      NAL_UNIT_RESERVED_23,
     
      NAL_UNIT_RESERVED_24,
      NAL_UNIT_RESERVED_25,
      NAL_UNIT_RESERVED_26,
      NAL_UNIT_RESERVED_27,
      NAL_UNIT_RESERVED_28,
      NAL_UNIT_RESERVED_29,
      NAL_UNIT_RESERVED_30,
      NAL_UNIT_RESERVED_31,
     
      NAL_UNIT_VPS,                   // 32
      NAL_UNIT_SPS,                   // 33
      NAL_UNIT_PPS,                   // 34
      NAL_UNIT_ACCESS_UNIT_DELIMITER, // 35
      NAL_UNIT_EOS,                   // 36
      NAL_UNIT_EOB,                   // 37
      NAL_UNIT_FILLER_DATA,           // 38
      NAL_UNIT_SEI,                   // 39 Prefix SEI
      NAL_UNIT_SEI_SUFFIX,            // 40 Suffix SEI
      NAL_UNIT_RESERVED_41,
      NAL_UNIT_RESERVED_42,
      NAL_UNIT_RESERVED_43,
      NAL_UNIT_RESERVED_44,
      NAL_UNIT_RESERVED_45,
      NAL_UNIT_RESERVED_46,
      NAL_UNIT_RESERVED_47,
      NAL_UNIT_UNSPECIFIED_48,
      NAL_UNIT_UNSPECIFIED_49,
      NAL_UNIT_UNSPECIFIED_50,
      NAL_UNIT_UNSPECIFIED_51,
      NAL_UNIT_UNSPECIFIED_52,
      NAL_UNIT_UNSPECIFIED_53,
      NAL_UNIT_UNSPECIFIED_54,
      NAL_UNIT_UNSPECIFIED_55,
      NAL_UNIT_UNSPECIFIED_56,
      NAL_UNIT_UNSPECIFIED_57,
      NAL_UNIT_UNSPECIFIED_58,
      NAL_UNIT_UNSPECIFIED_59,
      NAL_UNIT_UNSPECIFIED_60,
      NAL_UNIT_UNSPECIFIED_61,
      NAL_UNIT_UNSPECIFIED_62,
      NAL_UNIT_UNSPECIFIED_63,
      NAL_UNIT_INVALID,
    };
    ```

  - 以下帧类型在性能不足时可以丢弃：

    - HEVC_NAL_TRAIL_N
    - HEVC_NAL_TSA_N
    - HEVC_NAL_STSA_N
    - HEVC_NAL_RADL_N
    - HEVC_NAL_RASL_N

- LayerID：6 bits，表示NAL所在的Access unit所属的层，该字段是为了HEVC的继续扩展设置，一般为0

- TID：3bits，一般为1，此字段指定nal单元加1的时间标识符。

  - 时间id的值等于tid-1
  - tid的值为0是非法的，以确保nal单元报头中至少只有一个比特等于1
    - 以便能够在nal单元头和nal单元有效负载数据中独立考虑启动代码仿真。

> 通常情况下F为0，layerid为0,TID为1。

> H265帧类型与H264不一样，其位置在第一个字节的1~6位(buf[0]&0x7E>>1)，起始标识位00000001；常见的NALU类型：
>
> 40 01，type=32,VPS(视频参数集)
> 42 01，type=33,SPS(序列参数集)
> 44 01，type=34,PPS(图像参数及)
> 4E 01, type=39,SEI(补充增强信息)
> 26 01，type=19,可能有RADL图像的IDR图像的SS编码数据 IDR
> 02 01, type=01,被参考的后置图像，且非TSA、非STSA的SS编码数据
>
> ![s](https://raw.githubusercontent.com/Mocearan/picgo-server/main/2b3c87cf93e64191a8f93fcfa51e407a.png)
>
> 具体VPS/SPS/PPS介绍可参照：
> https://blog.csdn.net/z373248439/article/details/114264841



