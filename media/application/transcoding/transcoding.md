# 转码

---

​		将已编码的媒体从一种格式转换为另一种格式的过程。这可能涉及更改编解码器、分辨率、码率或文件格式。

​		转码确保媒体文件与不同的设备、平台和网络条件兼容



## 工具

### ffmpeg

​		`FFmpeg `是一个强大的开源命令行工具，用于处理多媒体数据。它支持编码、解码、转码、复用、解复用等。

​		**关键特性**：

- 广泛的编解码器支持：支持大量的编解码器和格式。
- 灵活性：高度可配置，有许多选项可供微调。
- 跨平台：适用于 Windows、macOS 和 Linux。

```shell
ffmpeg -i input.mov -c:v libx265 -crf 28 -preset fast -c:a aac -b:a 128k output.mp4
# 该命令将 input.mov 转换为 output.mp4，使用 H.265 编解码器对视频进行编码，CRF（恒定速率因子）为 28（平衡质量和文件大小），音频使用 AAC 编解码器，码率为 128 kbps。
ffmpeg -i input.mkv -c:v libx264 -c:a copy output.mp4
# 将 input.mkv 转换为 output.mp4，将视频重新编码为 H.264，同时复制音频流而不重新编码。
```



### handbrake

​		`HandBrake `是一个带有用户友好界面的开源视频转码器，适用于将几乎所有格式的视频转换为现代、广泛支持的编解码器。

​		**关键特性**：

- 预设配置文件：为各种设备和平台提供内置预设。
- 高级设置：允许微调编码参数。
- 批量编码：支持一次处理多个文件。



### 其他工具

- **Adobe Media Encoder**：Adobe 的 Creative Cloud 套件的一部分，提供专业级的编码和转码。
- **VLC Media Player**：一个多功能媒体播放器，具有内置的转码功能。
- **MediaCoder**：一个免费的媒体转码工具，支持各种格式和编解码器。



## 实践

- **选择合适的编解码器**：使用` H.264` 以获得广泛的兼容性，使用` H.265` 或 `VP9 `以获得更好的压缩效率，使用 `AV1 `以适应未来的发展。
- **优化码率**：通过选择合适的码率来平衡质量和带宽。使用 `FFmpeg `的 `CRF `模式等工具来调整质量。
- **保持宽高比**：确保输出视频保持原始宽高比，以避免失真。
- **批量处理**：使用脚本自动化编码任务，提高效率，尤其是在处理大量文件时。
- **跨设备测试**：验证编码后的视频能否在所有目标设备和平台上正确播放。



### ABS中的应用

​		自适应码率流式传输（ABS）是一种通过互联网传输视频的技术，它可以根据观众的网络条件动态调整视频流的质量。即使在网络连接不稳定的情况下，也能确保流畅的观看体验。

- **编码多个码率**：视频以多个码率和分辨率进行编码。例如，一个视频可能会被编码为 240p、480p、720p 和 1080p。
- **清单文件**：清单文件（如 HLS 的 M3U8 或 DASH 的 MPD）列出了可用的视频流及其码率。
- **动态切换**：流式传输客户端会监控网络条件，并在不同码率的流之间切换，以保持最佳播放效果。例如，如果网络速度下降，客户端可能会从 1080p 切换到 720p。
- **提升用户体验**：通过以多种码率对视频进行编码和转码，ABS 确保观众获得尽可能高的质量，同时避免中断。

```shell
# 为 HLS 生成多个码率的流
ffmpeg -i input.mp4 -filter_complex "[0:v]split=3[v1][v2][v3];[v1]scale=w=1280:h=720[v1out];[v2]scale=w=854:h=480[v2out];[v3]scale=w=640:h=360[v3out]" 
  -map "[v1out]" -c:v:0 libx264 -b:v:0 3000k 
  -map "[v2out]" -c:v:1 libx264 -b:v:1 1500k 
  -map "[v3out]" -c:v:2 libx264 -b:v:2 800k 
  -map a -c:a aac -b:a 128k 
  -f hls -hls_time 10 -hls_playlist_type vod 
  -hls_segment_filename "output_%v/segment_%03d.ts" 
  -master_pl_name "output.m3u8" 
  "output_%v/output.m3u8"
  
  # 该命令将输入视频分为三个分辨率（720p、480p、360p），以不同的码率（3000k、1500k、800k）对它们进行编码，并生成 HLS 段和播放列表。
```





