# live

---

​		直播的原理是在基础的流媒体转码之外，加上网络相关的协议处理。协议依据处理流媒体的主动与被动分拉流和推流。流媒体服务器的主要作用是进行媒体源的广播分发。

​		直播的业务一般包括：推流，拉流/播放，回源，录制，时移，转码。



- 推流：一般由媒体源将流媒体资源主动推流到流媒体服务器
- 拉流：由中心信令控制系统向媒体源下发拉流请求，媒体源将媒体资源推流到流媒体服务器
  - 实际上可以将媒体源看做一个独立的媒体服务，视为两个系统的媒体推送

![img](https://pics0.baidu.com/feed/cc11728b4710b912f87b6cc52344f50f9345229c.jpeg@f_auto?token=017d2901513d612cc46ede56e71b8d5b)

![img](https://pics3.baidu.com/feed/7a899e510fb30f24c0cbaf8a2e2cd84fac4b032f.jpeg@f_auto?token=2a42dabdb2f9c893e9c45c1f860c9c18)



## 参考

[直播相关讲解 -- 视频直播技术大全、直播架构、技术原理和实现思路方案整理(转载)-CSDN博客](https://blog.csdn.net/weixin_46932303/article/details/121581351)

[HLS直播协议在B站的实践 - 哔哩哔哩 (bilibili.com)](https://www.bilibili.com/read/cv18179472/)

[「网站架构」Nginx 4层、7层代理配置，正向代理、反向代理详解 (baidu.com)](https://baijiahao.baidu.com/s?id=1764793906954532912)



## 场景

### 直播

​		媒体源主动将媒体资源推送到流媒体直播平台，流媒体直播平台进行资源分发。

​		流媒体直播平台在资源分发的功能之外，可能还具有其它的功能：

- 直播转码：
  - 水印
  - 高清、流畅转换
  - 码率限制
  - 直播录像

​		如果不需要任何转码处理，且没有安全权限等设置的话，可以直接从流媒体服务中拉取视频观流看的，且推流和观看地址一般是一样。

​		**研发直播转码程序的意义在于一些高级功能**，如直播倒计时、信号中断自动补帧、导播/轮播、画中画等等。这部分正是一个直播系统的技术核心，毕竟流媒体服务器一般是协议兼容且现成的。

![img](https://pics0.baidu.com/feed/2f738bd4b31c870138ea0ae3c3c697230608ff99.jpeg@f_auto?token=ae68825e6ccf47125eacca1ed5178fa7)





### 转发

​		向另一流媒体平台拉取媒体资源。

### 录播

​		录播即文件直播，不是Real Time的实录实播，而是将已经准备好的媒体资源文件进行分发。可以不需要特定的流媒体服务参与，只需要一般的资源分发服务即可。



## 直播概念

​		从主播启动直播，到用户进行播放，中间发生事：

- 推流段：
  - 主播发起直播请求，APP启动音视频采集，采集的数据编码成H264 、 AAC，封装成推流协议的数据格式，把数据推动到边缘服务器
  - 采集：一般通过手机摄像头或者采集卡采集到视频数据，院士数据是一幅幅的图片，通过硬件编码，编码成H264/H265格式的视频数据；音频通过麦克风采集，通过硬件编码，编码成AAC格式的音频数据
  - 推流协议封装：APP通过使用的推流协议，把编码后的视频数据和音频数据封装成推流协议需要的格式
  - 推流：APP通过推流域名获取到最优的推流服务器，使用推流协议连接上推流服务器，把封装好的数据推送到服务器
    - 一般云厂商会做DNS负载调度，根据访问DNS服务器的IP，选择相同的运营商，距离最近，复杂最轻的服务器
    - 原则合适的推流协议，选择合适的推流服务器，解决第一公里的问题
- 推流服务器
  - 解封装：根据推流协议，跟直播APP建立连接，接收推送过来的数据，并且解开封装，得到音频和视频数据，以及Meta信息
  - 通过索引服务器：带上流的各种信息，通知索引服务器。索引服务器收到后，记录这种流，以便其他服务器过来查询时返回正确的推流服务器地址
  - 索引服务器也可以通知业务服务器，新增加了一路直播流，直播APP就可以舒心看到这路新的流
    - 索引服务器可以理解为路由服务器，或网关服务器
- 播放端
  - 播放：
    - 直播APP出现新推上来的直播流，点击播放，直播APP通过直播流的域名，获取到最优的播放服务器。
    - 直播APP根据获取到的播放服务器地址，使用播放协议（HLS/RTMP/HTTP-FLV）建立连接，接收数据。
    - 播放器接收到数据后，进行解封装，解编码格式，渲染输出画面，用户就能看到界面
  - 最后一公里：播放服务器到用户端的过程
    - 直播APP根据播放域名，从DNS服务器获取最优的播放服务器地址（也有可能是通过访问负载均衡服务器）进行播放；而DNS服务器（或负载均衡服务器）需要从运营商银行，IP距离，负载情况等多方面考虑，选择最优的一个服务器
    - 直播APP要根据业务需求，用户网络环境等选择合适的播放协议进行播放
    - 最后一公里需要直播系统和直播APP，业务设计等多方面共同参与优化，给用户最好的体验。
- CDN
  - 回源：直播APP想边缘节点（DNS范湖的播放服务器）请求这个直播流时，边缘节点会先检测本地有没有这个流；如果没有找到，需要向回源服务器请求数据
    - 边缘节点收到回源数据卮，马上会返回给直播APP，这样用户就可以及时看到画面
  - 中转：边缘服务器的运营商，可能跟推流服务器的运营商不一样，这时候就需要中转服务器来处理
    - 首先，中转服务器都是多线服务器，即中转服务器有多个网卡，每个网卡接一个运营商
    - 其次，边缘节点向中转服务器请求，是从边缘节点相同的运营商的线路发起请求
    - 最后，中转服务器推流服务器拉流时，是从推流服务器相同的运营商线路发起拉流请求
    - 所以，通过中转服务器处理后，边缘节点和推流服务器的运营商差异就被屏蔽了，用户是无感的

> 一个直播，从终端到CDN，再从CDN到终端，每个环节都涉及很多技术，都是必不可少的。
> 直播系统在这个过程中，提供了推流功能，CDN分发，CDN加速功能，以及播放功能。
> 如果主播还需要录视频，CDN还需要启动录制功能。
> 直播平台需要对内容进行审查，则需要时移及其他定制的功能。
> 用户播放这个主播的流，手机屏幕不一样，手机芯片不一样，可能需要不一样的分辨率，不一样的编码格式，这时候直播
> CDN就需要为这个流提供转码的能力。
> 直播系统是一个庞大的分布式系统，虽然功能很多，很复杂，但是都是推流，拉流的基础上扩展的。
>
> 首先会实现推流，然后再实现拉流，最后扩展出其他的功能。

### 推流

​		通过推流协议，把音视频数据推动到`CDN`服务器（或直接推送到客户端）。

​		推流协议主要是`RTMP`，也可以使用`webRTC`。

​		推流段需要把音视频数据封装成`FLV`格式或者`RTP`格式的数据。

​		推流段需要选择最近的一个节点推送数据。



### 拉流 / 播放

​		拉流： 服务器之间读取实时流数据进行回源

​		播放：客户端读取实时流数据进行播放

​		拉流/播放可以使用服务器支持的不同的协议，服务器根据使用的协议返回相应的数据。	

​		拉流/ 播放段需要选择最优的节点读取实时数据。



### 回源

​		客户端向一个服务器请求某个流时，服务器有这个流就马上返回数据；服务器没有这个流，就需要去中心服务器请求这个流的数据，这就是回源。

​		回源可以是多级的，也可以是多协议支持的。



### 录制

​		在直播过程中，可以把直播产生的音视频数据保存下来，这个过程就是录制。

​		录制完成后，可以回放直播过程。

​		录制文件格式有`hls / flv / mp4`



### 时移

​		在直播过程中，可能需要查看前面一段时间的数据，或者从前面几秒开始查看直播，这个就是时移的功能。

​		时移是通过录制产生的切片信息实现的，所以时移使用的事HLS协议。

​		时移一般有两种播放方式：

- 播放过去的一段时间
- 从过去的某个时间点一直往后播放，直到结束



### 转码

​		在拉流、播放过程中，服务器遇到不支持的编码请求或者不同的分辨率，或者其他情况就会触发转码。

​		转码就是通过程序，把不符合要求的流，转码成符合要求的流。

​		转码一般使用`ffmpeg`进行，同时也可以使用显卡进行硬件加速。







## 直播 `CDN`

​		用户直接拉取流媒体服务的视频流是可以观看的，但在流媒体资源用户并发较高的情况下，中心媒体服务器的性能压力和带宽压力较高。

​		此时应用`CDN`技术，将分发压力向边缘节点分散。直播CDN实际上也可以看作是流媒体服务。

​		使用直播`CDN`可以由媒体源直接将媒体资源推送到直播CDN，一般是通过RTMP协议推送到CDN服务；也有主动拉取的CDN服务。

> ​		但主动拉取的CDN服务不建议使用，因为主动拉取的CDN服务可能会同时存在多个CDN回源，这样就很难准确预估带宽的需要

​		**直播CDN一般提供自动转观看协议的功能**，一般会提供RTMP、HTTP-FLV、WEBRTC、HLS等协议的观看地址。

​		一般直播CDN是不提供转码服务的，如高清、流畅转换等。

> 因为协议转换并不需要太多的性能，但转码非常耗费性能。

![img](https://pics7.baidu.com/feed/314e251f95cad1c8d53e9e9e98876e05cb3d51c3.jpeg@f_auto?token=e11d986ce40cd0b27000c7fd5db9790f)



- CDN分发： 主播推流，一般只推送到一个服务器，而播放却是在全国各地，需要使用CDN把流传输到各地的服务器。CDN服务器一般是被动的，有访问需求才进行回源，也可以主动下发进行预热。
- CDN加速：客户端的网络环境差异很大，为了优化播放端的体验，CDN需要把播放引导到离客户最近的，网速最快的服务器，相当于CDN给客户端提升了速度，这就是CDN加速。
  - CDN加速主要是通过减少访问服务器的距离，提供了大带宽的服务，选择相同的运营商，选择延时低的流媒体协议等手段来实现内容的加速。



## 协议选型

### `RTMP/HTTP-FLV`

​		RTMP和HTTP-FLV二者都建立在FLV封装之上。

- `RTMP`一般用作直播源在直播系统内部的推流传递
  - 推流到流媒体服务器：
  - 推流到直播`CDN`
- `HTTP-FLV`一般用于向客户端推流观看

![img](https://pics2.baidu.com/feed/79f0f736afc37931d93673e7a7b7ad4942a91125.jpeg@f_auto?token=5769d0830d1dc1ab0599e1b1ab775b74)

​		对比：

#### `RTMP`

- 可以推流和拉流
- `rtmp://`，推流地址和播放地址一致
- 一般只用作直播源推流到流媒体、推流到CDN
  - 客户端浏览器摒弃`Flash`
  - 高并发下不稳定
- 需要支持`RTMP`的流媒体服务器
  - `SRS`
  -  `ZLMediaServer `
  - `Red5`
  - `Nginx-rtmp`
    - 加入了RTMP插件的Nginx
- 延迟是比较低的，大概在1-3秒左右
- 是建立在TCP长连接通道上的，在封装音视频数据时会强制切片，限制每个数据包的大小
  - 强制切片也一定程度保证了实时性
  - 有一定的弱网抵抗能力
    - 因为每个数据包都不会太大，所以当某个数据包校验失败时，重新发送的成本不会太大
  - 由于合并数据包会加大CPU压力，所以是有一定的性能消耗的
- RTMP协议还有一些变种协议，如RTMPT、RTMPS等

![img](https://pics5.baidu.com/feed/54fbb2fb43166d22464ce8c40b5013fb9052d222.jpeg@f_auto?token=37f1815829b008477c522b823d5d6e59)

#### `http-flv`

- 一般只能用作拉流

- `http://`，基于HTTP协议的HTTP-FLV可以简单地理解为RTMP的HTTP协议版本

  - 功能和工作原理上是相似
  - 切片数据

-  HTTP-FLV延迟会略高于RTMP，但是HTTP-FLV相对RTMP适配更多的播放场景

- 一般需要需加入插件才能播放，如网页需要引入`flv.js`

  - > B站开源的`flv.js`

- 需要特定的流媒体服务器

  - 加入了HTTP-FLV插件的Nginx

  - > Nginx的HTTP-FLV插件是包含RTMP功能的，所以一般HTTP-FLV的流媒体服务，推流是以RTMP协议，拉流是用HTTP-FLV协议

- 现在比较流行的方案是，直播源推流是RTMP协议，直播拉流观看是HTTP-FLV协议。

![img](https://pics6.baidu.com/feed/267f9e2f070828386bbed00eeaeab30d4d08f1fc.jpeg@f_auto?token=d62fca0268226ecc560fea58b2bf37ea)



### `HLS`

- 一般只用作拉流观看
- 从严格意义上讲，HLS协议并不是流式协议
  - 通过HTTP协议批量下载静态文件
  - 这些静态文件都是直接写入磁盘的
  - 多个只有几秒长度的**.ts碎片视频文件**
  - 记录视频文件地址的**.m3u8索引文件**
- `http://****.m3u8`
  - 实际上这个地址就是索引文件的地址
  - 客户端获取到索引文件后，就可以下载对应的碎片视频文件并开始播放了
  - 实际上是通过HTTP协议请求文件
- 不需要特殊的流媒体服务器
  - HLS相关文件是直接写入磁盘的，使用Nginx等HTTP服务就可以
- 适配多种播放场景，一般加入插件就可以播放
  - 网页加入HLS的js插件就可以播放了，苹果设备是原生支持HLS协议的
- HLS协议可以用于点播和直播
- **HLS协议的.m3u8索引文件支持二级索**引
  - 就是高清、标清、流畅等多个观看地址可以整合到一个索引文件
  - 播放器可以根据当前带宽自动切换不同的观看地址
- **HLS协议**的视频文件、索引文件都是直接写入磁盘的，长时间且多个直播流同时处理，**会造成磁盘写入压力过大**，机械磁盘可能会磁道会损坏，固态硬盘的寿命会加速衰减。
  - 最好挂载一段内存空间作为HLS相关文件的写入位置，则不会造成磁盘写入压力过大的问题。
- HLS协议是苹果推出的标准，MPEG-DASH是国际标准协议
  - 二者相差不多

![img](https://pics2.baidu.com/feed/359b033b5bb5c9ea6e695895814aac0c3bf3b3a9.jpeg@f_auto?token=2585fbb963d7a88cdc7dbb5e8f83cba8)

#### 点播

​		.m3u8索引文件会记录所有的碎片视频文件地址，HLS在**点播**的场景下，**优势是更加明显的。**

​		HLS的相关文件是无状态的静态文件，且每个文件的大小是有限的，所以负载均衡、CDN加速的效果更佳明显。

​		HLS协议的点播视频，会比.mp4、.flv的视频更快地播放出来，且在加载中跳转视频也会更加顺滑。

![img](https://pics2.baidu.com/feed/c2fdfc039245d688f5aec1d2e9b16712d31b2492.jpeg@f_auto?token=65b0a49c18a3d557d4e66495147101c1)



#### 直播

- 转码软件可以直接生成HLS相关文件到磁盘，客户端通过HTTP服务下载文件即可。
- 也可以在Nginx加入RTMP插件，转码软件以RTMP协议推流到Nginx，再由Nginx生成HLS相关文件。

> **后一种方案更加推荐**，因为它对于前期研发和后期对接直播CDN的过度更加顺滑。

![img](https://pics6.baidu.com/feed/060828381f30e92477ce4c77017b740a1c95f78a.jpeg@f_auto?token=a04df1fb3ca087bd4c29948fac83f972)

​		直播场景下的HLS相关文件与点播是有不同

- 视频流数据每几秒会打包成一个以.ts为后缀的碎片视频文件，每生成一个新的视频文件都会同步更新.m3u8索引文件。
- 碎片视频文件的个数是有**上限的**，当达到上限后，默认会将最旧的视频文件删除且更新.m3u8索引文件
- 所以在直播的场景下，客户端也需要不断定时重新获取.m3u8索引文件
- HLS协议在直播的场景下是没什么优势的
  - 虽然HLS协议的直播流可以适配很多播放场景
  - 但是由于需要生成静态文件，**直播延迟很大**，**大概在5-30秒左右**
  - 使用直播CDN的话，由于边缘节点同步等问题，直播延迟甚至可能会达到1分钟左右
- HLS协议在直播切换时一定的优势
  - 在直播时移（直播转点播，点播转直播）的场景， 理论上只需要修改索引文件就可以了
  - 不需要重新进行耗费性能的编解码



### `webRTC`

​		WebRTC协议其实并不是为了直播场景而设计的，WebRTC是一种点对点的视频/语音通话协议。

- 基于UDP的，建立通信后，不断以流式发送数据，**所以延迟会比RTMP还要低**
- **交互性较高的直播场景**，如直播带货等场景，会使用WebRTC作为推流和观看协议
- 支持推流和拉流
- `webrtc://`
  - 推流和拉流地址一般是一样的
- 点对点的协议
  - 通过搭建`p2p`信令服务器，通过信令服务器调度直播源直接向某个播放端推流
    - 播放端作为一个推流端，经信令服务器调度向另一个播放端推流
    - 从而进行分布式推流
  - 在直播场景的话，可以通过**搭建WebRTC服务器**进行集中式推流
    - 流媒体服务软件可以使用`SRS/ mediasoup / janus`等

![img](https://pics1.baidu.com/feed/e7cd7b899e510fb3b40786889440d299d1430c16.jpeg@f_auto?token=84be192ef736cc225d81efb111eb526b)



### `rtsp`

​		**RTSP一般不用作直播场景**，`RTSP`一般用作摄像头、监控等硬件设备的实时视频流观看与推送上。

​		`RTSP`协议也支持推流/拉流，且支持`TCP`、`UDP`切换以及其他诸多优点。

​		但是泛用性不足，特别是现在的浏览器都不支持`RTSP`的播放。



## 典型直播流程

1. **摄取**：视频流由摄像机或编码软件捕获并发送到 `RTMP `服务器。这是第一步，直播视频被摄取到流式传输基础设施中。
2. **处理**：`RTMP `服务器处理传入的流，并使其可用于进一步的编码和分发。
3. **队列**：然后将流发送到消息队列（例如，`Kafka`、`RabbitMQ`）以进行可扩展处理。
4. **编码**：工作进程从队列中消费流，并使用 `FFmpeg `将其转码为不同的格式和码率。
5. **分段和打包**：编码后的流被分段为适合` HTTP Live Streaming（HLS）`的小块。
6. **分发**：然后通过 `CDN `将这些分段分发给最终用户。

​		**延迟**：在此工作流程中，典型的玻璃到玻璃延迟（从摄像机捕获到在用户设备上播放的时间）约为 10 秒。

### 低延迟流式传输：SRT、LL-HLS、WHIP 和 WHEP

1. **SRT/WHIP 源**：视频流从 SRT 或 WHIP 源（摄像机/编码器）开始。
2. **媒体服务器**：流被媒体服务器摄取，该服务器针对低延迟进行了优化。
3. **消息队列**：将流放置在消息队列中以进行低延迟处理。
4. **工作节点**：工作节点从队列中拉取流，并使用 FFmpeg 或类似工具以低延迟设置进行转码。
5. **分发（WHEP 或 LL-HLS）**：通过 `WebRTC `或低延迟 `HLS（LL-HLS）`将流传递给最终用户。



## 延迟优化

​		造成延迟的原因：

- 协议传输的通信延迟
- 推流延迟
- 转码延迟
- 拉流延迟

​		延迟优化：

- 协议优化
- 禁止`B`帧
- `GPU`硬件加速
- 流媒体服务缓存`I`帧
- 码率限制