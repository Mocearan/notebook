# ops

---

​		场景、优化、问题



## 首开优化

​		客户端的首帧秒开，本质上就是不做同步先把第一帧显示出来。这个功能不能降低延迟。



## 画面异常

​		黑屏、花屏、闪屏等问题，可能是推流端的问题，也可能是拉流端播放器的问题。

- 先用别的播放器（如 VLC，ffplay）试试，如果都出现同样的问题，那么多半是流本身的问题了
- 反之，则很可能是播放器的问题

[【视频花屏问题】解码天书：深入理解视频流花屏现象及其解决方案 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/661663550)

[视频常见问题（四）：视频花屏和绿屏 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/670575280)

### 黑屏

- 推流端摄像头权限不足
  - 无论 Android 还是 iOS，App 使用摄像头都是需要申请授权
  - 推出的流可能只有音频
- 推流端编码失败
  - 参数配置或者某些机型的硬编兼容性问题
  - 一般推流 SDK 都会统计推流的实时[视频帧率](https://zhida.zhihu.com/search?q=视频帧率&zhida_source=entity&is_preview=1)，CDN 服务端也会有一些帧率监控
  - 推流帧率为 0，同时又确定不是没有采集到数据，则推流端编码失败
- 拉流端解码失败
  - 播放器遇到不支持的[视频格式](https://zhida.zhihu.com/search?q=视频格式&zhida_source=entity&is_preview=1)，或者数据内容/格式异常
  - 播放器本身遇到的硬解或者软解失败，应该有日志报错
  - 分析码流文件本身，常见的数据内容错误导致的解码失败有如下几种：
    - 送入[解码器](https://zhida.zhihu.com/search?q=解码器&zhida_source=entity&is_preview=1)的帧数据不完整
    - H.264 的视频码流，缺失了 SPS，PPS 等必要的信息头
    - iOS 的 VideoToolbox 解码，只支持 avcc 方式打包的 H.264 数据
    - 部分 Android 机型硬编出来的数据有额外的 naul 头
    - 其他等等
- 码流的前半段只有音频没有视频
  - 多半出自 HLS 切片产生的码流
  - 用同一个地址推流，前半段只推了音频（可能是摄像头权限被禁用，也可能是选择了纯音频推流等等
  - 接着又同时推了音视频流，那么，服务端 HLS 切片产生的文件，就会出现这样的情况。
  - 基于 ffmpeg 的播放器，会在解析完视频头后初始化解码器，因此，对于这种码流，往往会出现仅有音频或者仅有视频播放的情况
  - 从 App 端尽可能避免出现这种使用姿势，修改播放器的代码，对这种码流进行兼容处理





### 视频花屏

![img](https://pic1.zhimg.com/80/v2-f72cce384112b40727aeda279a6823f8_720w.webp)

​		花屏主要分为整个画面都花屏或局部花屏两种情况。

- 码率特别低的时候出现的大面积马赛克

  - 全屏花屏

  > 告诉[视频编码器](https://zhida.zhihu.com/search?q=视频编码器&zhida_source=entity&is_preview=1)要输出1280 720高清分辨率的画面，但同时要求它只用 200 kbps的码率*（码率是指编码器每秒产生的视频数据大小 ），编码器此时能做的事情就是无底线地降低画质，就会导致大面积的马赛克。

- 视频源修改过视频参数(如从720P修改1080P)，需要重新获取SPS和PPS

  - 没有重新获取的话，就会出现整个画面花屏的现象。这种花屏的现象会一直持续下去，不会随着时间而恢复正常画面
  - 全屏花屏或绿屏

- 媒体服务`SO_SNDBUF`的`Buffer`太小，在网络环境不好时，导致部分直播数据丢失(比如丢失P帧)

  - 局部花屏

  >  **增加SO_SNDBUF的Buffer大小**
  >
  > ```c
  > SOCKET sSocket = ... ... ;
  > int nRcvBufferLen = 1024*1024;
  > int nSndBufferLen = 4*1024*1024; 
  > int nLen = sizeof(int); 
  > setsockopt(sSocket, SOL_SOCKET, SO_SNDBUF, (char*)&nSndBufferLen, nLen); 
  > setsockopt(sSocket, SOL_SOCKET, SO_RCVBUF, (char*)&nRcvBufferLen, nLen);
  > ```

​		

​		播放流媒体的过程中花屏大多说是由于解码前后存在丢帧，存在丢帧的原因就可能有很多了

- 文件本身就是不完整的，存在很多丢帧或者错误帧的情况；
- 直播流媒体，第一帧不是I帧，会扔掉所有开头的这些帧，直到等到第一个I帧过来
- 流媒体通过RTP等封装格式在网络上传输过程中存在丢包，或者包延迟时间太长
- 解码器解码能力限制或者解码器的其他因素导致的丢帧

[RTSP流媒体花屏_wrong sequence number-CSDN博客](https://blog.csdn.net/u011703477/article/details/52246088)



### 绿屏

​		播放画面出现图像紊乱，大面积的异常颜色的方块图，或者绿屏现象

​		无法渲染的画面有些用黑色填充，有些用绿色填充，有些用上一帧画面填充。

​		视频参数改变， 而解码端的SPS&PPS信息未及时重新获取更新，会导致画面无法正常渲染，继而导致绿屏的现象出现。	

- 丢失参考帧
  - 丢弃编码后、解码前的视频帧数据
  - 网络不好，编码后的数据发不出去
  - 系统低内存，队列里面无法承受更多的帧数据
  - 不得不丢帧的话，最合理的策略就应该是一次丢一整个 GOP，即：一旦开始丢了一个 I 帧，那么在遇到下一个 I 帧之前的所有视频帧，均丢弃掉，这样即可有效避免播放器端产生解码花屏
- 播放器没有从关键帧开始解码
  - 如果不从关键帧开始解码，则必然会由于丢失了参考信息而导致解码花屏
  - 无论是首播，还是断网重连后，都应该判断第一帧视频是否是关键帧，如果不是，则应该等到第一个关键帧到达之后再送入解码器
  - 基于 ffmpeg 的播放器，如何判断关键帧：[FFMPEG Tips (3) 如何读取每一帧的信息 - DoubleLi - 博客园 (cnblogs.com)](https://www.cnblogs.com/lidabo/p/15071232.html)
- 视频尺寸发生变化
  - 很多直播 App，横屏直播和竖屏直播，使用的是不同的推流尺寸 
  - 当主播由竖屏推流改为横屏推流，同时又不改变推流地址的话，观众端拉到的流就会出现中间发生了视频尺寸的变化
  - 播放器需要实时检测，如果发现视频尺寸发生了变化，则需要重置解码器以及相关逻辑，否则容易出现解码花屏或者出现内存越界等异常
- 硬编硬解的兼容性问题
  - 如果使用的是 Android 硬编硬解，一些比较坑爹的手机，硬编硬解没有失败报错，但是输出的图像确实异常的情况
  - Android 硬编硬解的兼容性问题，代码上小心仔细，充分考虑机型的兼容性，不轻易写死任何参数，剩下能做的就是靠白名单/黑名单了
- 推流端图像尺寸和格式处理不当
  - 图像的格式和尺寸，都是非常重要的参数，一定要严格配置正确
  - 采集到的视频是 NV21 ，编码器只支持 I420，那么编码出来的图像自然会出现颜色问题
  - 一些场景切换的过程中，前后摄像头切换，视频的尺寸可能发生了变化，但是剪裁、处理、编码模块没有相应的修改尺寸，那么，也会出现各种视频错乱的现象



### 闪屏

​		播放的过程中，出现了两种不同的画面来回切换，从而看起来像 「闪屏」，比如，黑白两张图片交替渲染。

- 播放器缓冲机制
  - 网络不好的时候，播放器会频繁缓冲
  - 在缓冲的时候，使用一张缓冲图片，在某种极端弱网情况下，由于频繁缓冲，导致真实的播放画面和缓冲图片来回快速切换
  - 可以从播放器的缓冲策略上避免
    - 每次缓冲后，不要收到一帧后就立即渲染，而是适当地多缓冲一些数据，再发送缓冲结束的消息
    - 避免频繁 ms 级别的缓冲切换产生的闪屏
- 推流端的原因
  - 往往发生在有画面合成的代码模块，比如：叠加水印、摄像头/图片切换推流、连麦合流等等。
  - 任何情况下，都要避免出现合成和没有合成两种画面的交替



## 拉流端异常

​		推流没有问题时，如果拉流不能正常播放：

- 没有声音：dump rtmp拉流后的数据是否可以正常播放
- 声音异常：是否有解码错误报告，重采样前的pcm数据是否正常
- 没有图像： dump rtmp拉流后的数据是否可以正常播放
- 画面异常：是否有解码错误报告，scale前的数据是否正常



