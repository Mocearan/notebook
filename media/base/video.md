# video

​		视频是由一幅幅图像组成的。

---

## 视频概念

- 帧率：构成每秒视频的图片数

  - 25fps表示一秒有25张图片
  - 由于视觉图像在视网膜的暂时停留，一般图像帧率能达到24帧，我们就认为图像是连续动态的。
  - 电影帧率一般是24fps，电视剧是25fps，监控行业常用25fps，音视频通话常用15fps。
- 码率：构成每秒视频的数据量
  - 1Mbps表示一秒有1Mbit的数据量
  - 因为构成视频单元的图片有帧间编码和帧内编码，所以帧率和码率衡量的视频质量并不相同
  - 大多数情况下码率越高，分辨率越高，也就越清晰。
    - 但模糊的视频文件大小（码率）也可以很大
    - 分辨率小的视频文件可能也比分辨率大的视频文件清晰。
    - 对于同一个原始图像源的时候，同样的编码算法，则码率越高，图像的失真就会越小，视频画面就会越清晰。

- 分辨率：视频分辨率与图片的分辨率概念一致
  - 720P与720i
    - i 表示隔行扫描
      - 相邻两帧分别渲染奇、偶行
      - 理论上人眼是察觉不出来画面不连续，反而是由于视觉残留，能自动将两帧叠加在一起。

    - p 则表示逐行扫描
      - 每一线都同时表现在画面上，因此比隔行扫描电视更加的平滑。




​	分辨率、帧率和码率三者之间的关系，我们以不同的基准来看一下。

- 当我们以码率为中心时：

  > 如果码率为变量，那么帧率就会影响视频的体积，帧率越高，每秒钟经过的画面越多，编码器每秒编出的数据也就越大，那么视频体积也就越大。分辨率则影响图像大小，分辨率越高，像素越多，则图像越大；反之图像越小。
  > 而当码率不变时，分辨率与清晰度成反比关系：分辨率越高，需要的码率就会变高，但是此时码率不变，就会导致图像越不清晰。反之分辨率越低，图像越清晰，但是图像也会越小。

- 如果以分辨率为中心：

  > 当分辨率不变时，码率与清晰度成正比关系：码率越高，图像越清晰；反之码率越低，图像越不清晰。

- ​		所以，一个好的画质并不是盲选最高的分辨率就可以，而是需要平衡好分辨率、帧率以及码率，某一个值偏高都会让画质受收到影响。

  > ​		然而这就带来了一个问题，如果一个视频的分辨率达到 720p、1080p 甚至更高，同时完美平衡了码率、帧数，我们会发现，视频的体积会变得相当大，这让视频在网络传输中对网速的要求迅速提升，甚至不进行处理会出现无法正常播放的情况。



## 视频编码原理

​		连续画面中大量信息是重复冗余的，在组织视频的时候，并不是将每张图片的全部数据都全部保留。视频通过帧间编码技术去除冗余信息进行数据量的压缩。

> ​		相较于音频数据，视频数据有极强的相关性，也就是说有大量的冗余信息，包括空间上的冗余信息和时间上的冗余信息。

- 相对于静态的JPEG编码，ISO针对视频也指定了标准：Motion JPEG即MPEG。

  > ​		MPEG算法是适用于动态视频的压缩算法，它除了对单幅图像进行编码外，还利用图像序列中的相关原则去除冗余，这样可以大大提高视频的压缩比。
  >
  > ​		Mpeg1（用于VCD）、Mpeg2（用于DVD）、Mpeg4 AVC（现在流媒体使用最多的就是它了）
  >
  > ​		H.264创造了多参考帧、多块类型、整数变换、帧内预测等新的压缩技术，使用了更精细的分像素运动矢量（1/4、1/8）和新一代的环路滤波器，这使得压缩性能得到大大提高，系统也变得更加完善。

![image-20220821235406691](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20220821235406691.png)



### GOP

​		GOP（Group Of Picture），表示视频中一个独立播放的图片组。

​		通常在为编码器设置参数的时候，必须要设置`gop_size`的值，其代表的是两个I帧之间的帧数目。

- 一个GOP中容量最大的帧就是I帧
  - `gop_size`设置得越大，整个画面的质量就会越好。
- 解码端必须从接收到的第一个I帧开始才可以正确解码出原始图像，否则会无法正确解码。
- 根据不同的业务场景，适当地设置gop_size的大小，以得到更高质量的视频。



### 帧编码

- **帧间编码**技术可以去除时间上的冗余信息

  - 运动补偿：运动补偿是通过先前的局部图像来预测、补偿当前的局部图像，它是减少帧序列冗余信息的有效方法。

  - 运动表示：不同区域的图像需要使用不同的运动矢量来描述运动信息。

  - 运动估计：运动估计是从视频序列中抽取运动信息的一整套技术。


- **帧内编码**技术可以去除空间上的冗余信息



### 帧类型

​		不同的帧类型，有着不同的编码技术，共同达到去除冗余信息的目的。



#### I帧：关键帧

- 帧内编码，数据量大
- 周期性插入图像序列中，频率可由编码器指定
- I帧不需要考虑运动矢量
  - I帧压缩可去掉视频的空间冗余信息
  - P帧和B帧是为了去掉时间冗余信息。
- 通常是每个GOP的第一个帧
  - GOP，MPEG所使用的一种视频压缩技术，表示组成一段视频的一组图片
  - 经过适度地压缩，作为随机访问的参考点，可以当成静态图像
    - I帧压缩可以得到6:1的压缩比而不会产生任何可觉察的模糊现象。
  - I帧可以单独解码出一张完整的图片
    - 质量直接影响到同组中以后各帧的质量
  - 参考帧可以参考I帧的信息来解码出一张完整的图片

#### P帧

​		前向预测编码帧（predictive-frame）。需要参考其前面的一个I帧或者P帧来解码成一张完整的视频画面。

​		充分去除图像序列中此帧之前已编码帧的时间冗余信息，压缩编码图像。

#### B帧

​		双向预测内插编码帧（bi-directional interpolated prediction frame），B帧则需要参考其前一个I帧或者P帧及其后面的一个P帧来生成一张完整的视频画面。

​		既考虑源图像序列前面的已编码帧，又顾及源图像序列后面的已编码帧之间的时间冗余信息，来压缩传输数据量的编码图像，也称为双向预测帧。



#### IDR帧

​		在H264的概念中有一个帧称为IDR帧。

​		因为H264采用了多帧预测，所以I帧之后的P帧有可能会参考I帧之前的帧。这就使得在随机访问的时候不能以找到I帧作为参考条件清理缓冲区。因为即便找到I帧，I帧之后的帧还是有可能因为参考I帧之前的帧而解析不出来。

​		IDR帧就是一种特殊的I帧，即这一帧之后的所有参考帧只会参考到这个IDR帧，而不会再参考前面的帧。

​		在解码器中，一旦收到一个IDR帧，就会立即清理参考帧缓冲区，并将IDR帧作为被参考的帧。



#### tips

​		在提高视频质量的技巧中，还有个技巧是多使用B帧。

​		一般来说，I的压缩率是7（与JPEG差不多）, P是20, B可以达到50，可见使用B帧能节省大量空间，节省出来的空间可以用来更多地保存I帧，这样就能在相同的码率下提供更好的画质。



### PTS / DTS

​		DTS（Decoding Time Stamp），解码时间戳，主要用于视频的解码。

> 表示该压缩包应该在什么时候被解码

​		PTS（Presentation Time Stamp），显示（表示）时间戳，主要用于在解码阶段进行视频的同步和输出。

> 视频的一帧图像什么时候显示给用户，取决于它的PTS

​		在没有B帧的情况下，DTS和PTS的输出顺序是一样的。因为B帧打乱了解码和显示的顺序，所以一旦存在B帧，PTS与DTS势必就会不同。

> 如果视频里各帧的编码是按输入顺序（显示顺序）依次进行的，那么解码和显示时间应该是一致的，但是事实上，在大多数编解码标准（如H.264或HEVC）中，编码顺序和输入顺序并不一致，于是才会需要PTS和DTS这两种不同的时间戳。
