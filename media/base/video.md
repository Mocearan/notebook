# video

​		视频是由一幅幅图像组成的。

#### 视频编码

​		同音频编码相似，视频的帧间编码也是通过去除冗余信息的方式来进行数据量的压缩。

​		相较于音频数据，视频数据有极强的相关性，也就是说有大量的冗余信息，包括空间上的冗余信息和时间上的冗余信息。

![image-20220821235406691](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20220821235406691.png)

**帧间编码**技术可以去除时间上的冗余信息

- 运动补偿：运动补偿是通过先前的局部图像来预测、补偿当前的局部图像，它是减少帧序列冗余信息的有效方法。
- 运动表示：不同区域的图像需要使用不同的运动矢量来描述运动信息。
- 运动估计：运动估计是从视频序列中抽取运动信息的一整套技术。

**帧内编码**技术可以去除空间上的冗余信息

​		相对于静态的JPEG编码，ISO针对视频也指定了标准：Motion JPEG即MPEG。

​		MPEG算法是适用于动态视频的压缩算法，它除了对单幅图像进行编码外，还利用图像序列中的相关原则去除冗余，这样可以大大提高视频的压缩比。

> 截至目前，MPEG的版本一直在不断更新中，主要包括这样几个版本：Mpeg1（用于VCD）、Mpeg2（用于DVD）、Mpeg4 AVC（现在流媒体使用最多的就是它了）

​		ITU-T制定的H.261、H.262、H.263、H.264一系列视频编码标准是一套单独的体系。

​		H.264集中了以往标准的所有优点，并吸取了以往标准的经验，采用的是简洁设计，这使得它比Mpeg4更容易推广。现在使用最多的就是H.264标准，H.264创造了多参考帧、多块类型、整数变换、帧内预测等新的压缩技术，使用了更精细的分像素运动矢量（1/4、1/8）和新一代的环路滤波器，这使得压缩性能得到大大提高，系统也变得更加完善。



##### IPB帧

​		视频压缩中，每帧都代表着一幅静止的图像。而在进行实际压缩时，会采取各种算法以减少数据的容量，其中IPB帧就是最常见的一种。

- I帧：帧内编码帧（intra picture）

  I帧通常是每个GOP的第一个帧，经过适度地压缩，作为随机访问的参考点，可以当成静态图像。

  > GOP（MPEG所使用的一种视频压缩技术）

  I帧可以看作一个图像经过压缩后的产物，I帧压缩可以得到6:1的压缩比而不会产生任何可觉察的模糊现象。

  I帧压缩可去掉视频的空间冗余信息，P帧和B帧是为了去掉时间冗余信息。

  > I帧自身可以通过视频解压算法解压成一张单独的完整视频画面，所以I帧去掉的是视频帧在空间维度上的冗余信息。

- P帧：前向预测编码帧（predictive-frame）

  通过将图像序列中前面已编码帧的时间冗余信息充分去除来压缩传输数据量的编码图像，也称为预测帧。

  > P帧需要参考其前面的一个I帧或者P帧来解码成一张完整的视频画面。

- B帧：双向预测内插编码帧（bi-directional interpolated prediction frame）

  既考虑源图像序列前面的已编码帧，又顾及源图像序列后面的已编码帧之间的时间冗余信息，来压缩传输数据量的编码图像，也称为双向预测帧。

  > B帧则需要参考其前一个I帧或者P帧及其后面的一个P帧来生成一张完整的视频画面，所以P帧与B帧去掉的是视频帧在时间维度上的冗余信息。

##### IDR帧

​		在H264的概念中有一个帧称为IDR帧（在H264的概念中有一个帧称为IDR帧）。

​		因为H264采用了多帧预测，所以I帧之后的P帧有可能会参考I帧之前的帧，这就使得在随机访问的时候不能以找到I帧作为参考条件，因为即使找到I帧，I帧之后的帧还是有可能解析不出来，而IDR帧就是一种特殊的I帧，即这一帧之后的所有参考帧只会参考到这个IDR帧，而不会再参考前面的帧。在解码器中，一旦收到一个IDR帧，就会立即清理参考帧缓冲区，并将IDR帧作为被参考的帧。



##### PTS / DTS

​		DTS（Decoding Time Stamp），解码时间戳，主要用于视频的解码。

> 表示该压缩包应该在什么时候被解码

​		PTS（Presentation Time Stamp），显示（表示）时间戳，主要用于在解码阶段进行视频的同步和输出。

> 视频的一帧图像什么时候显示给用户，取决于它的PTS

​		在没有B帧的情况下，DTS和PTS的输出顺序是一样的。因为B帧打乱了解码和显示的顺序，所以一旦存在B帧，PTS与DTS势必就会不同。

> 如果视频里各帧的编码是按输入顺序（显示顺序）依次进行的，那么解码和显示时间应该是一致的，但是事实上，在大多数编解码标准（如H.264或HEVC）中，编码顺序和输入顺序并不一致，于是才会需要PTS和DTS这两种不同的时间戳。



##### GOP

​		GOP（Group Of Picture），两个I帧之间形成的一组图片。

​		通常在为编码器设置参数的时候，必须要设置gop_size的值，其代表的是两个I帧之间的帧数目。

> ​		一个GOP中容量最大的帧就是I帧，所以相对来讲，gop_size设置得越大，整个画面的质量就会越好。
>
> ​		但是在解码端必须从接收到的第一个I帧开始才可以正确解码出原始图像，否则会无法正确解码。

​		在提高视频质量的技巧中，还有个技巧是多使用B帧，一般来说，I的压缩率是7（与JPEG差不多）, P是20, B可以达到50，可见使用B帧能节省大量空间，节省出来的空间可以用来更多地保存I帧，这样就能在相同的码率下提供更好的画质。

> 根据不同的业务场景，适当地设置gop_size的大小，以得到更高质量的视频。

##### 帧率

​		每秒处理的图片帧数，如25fps，即每秒处理25张图片。

​		帧率越高，视频越流畅，需要的设备性能越高。

​		人眼的视觉暂留使得图像帧率达到24帧就可以认为图像是连续的。

> 电影帧率一般是24fps，电视剧是25fps，监控行业常用25fps，音视频通话常用15fps。

##### 码率

​		单位时间的视频数据大小，如1Mbps，即每秒有1Mb的数据量。

​		码率越大，视频越清晰。但不是线性的关系，而是对数的关系。



##### Stride

​		内存中每行像素所占的空间，为了实现内存对齐，每行像素在内存中所占的空间并不一定是图像的宽度。

![image-20220908221919639](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20220908221919639.png)

![image-20220908222150926](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20220908222150926.png)

![image-20220908222203828](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20220908222203828.png)

