

# MPEG-container

---

​		MPEG 全称 Moving Picture Experts Group （动态影像专家小组），该专家组是联合技术委员会（Joint Technical Committee， JTC1）的一部分，JTC1 是由 ISO（国际标准化组织）和 IEC（国际电工委员会）建立的。JTC1 负责信息技术，在 JTC1 中，下设有负责**“音频、图像编码以及多媒体和 超媒体信息”**的子组 SG29。在 SG29 子组中，又设有 多个工作小组，其中就包括 JPEG（联合图片专家组）和 负责活动图像压缩的工作组 WG11 。因此，可以认为 MPEG 是 ISO/IEC JTC1/SG29/WG11，成立于1988年。

​		把 MPEG 理解成一个组织就行。MPEG 主要制定影音压缩及传输的规格标准。MPEG 组织制定的标准目前一共有五个 ，MPEG-1、MPEG-2、MPEG-4、MPEG-7及MPEG-21，而 **MPEG-TS** 封装格式 的定义在 **MPEG-2** 标准 里面。

​		 早期主要是用在 **数字电视** 领域，我国数字电视标准用的是 DVB，全称是 Digital Video Broadcasting（数字视频广播）。

​		MPEG标准中，有两种不同的码流封装格式:

- 一种是节目码流（PS: Program Stream），适用于没有传输误差的场景；
  - 节目流设计用于合理可靠的媒体，如光盘（如DVD），
- 一种是传输流（TS：Transport Stream)，适用于有信道噪声的传输场景
  - 而传输流设计用于不太可靠的传输，即地面或卫星广播。此外，传输流可以携带多个节目。

![image-20240623113447966](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20240623113447966.png)



## 标准

### MPEG-2

​		MPEG-2 目前广泛用于互联网传输协议，以及早期的有线数字电视，无线数字电视，卫星电视， DVB，DVD，等等。

​		MPEG-2 标准目前分为10个部分，统称为 ISO/IEC 13818 国际标准，标题 是 “GENERIC CODING OF MOVING PICTURES AND ASSOCIATED AUDIO”。

| 编码    | 标题                     | 描述                                                         |
| ------- | ------------------------ | ------------------------------------------------------------ |
| 13818-1 | System（系统）重点       | 描述多个 音频码流，视频码流 和 基础数据码流，合成传输码流和节目码流的方式。 |
| 13818-2 | Video（视频）            | 描述视频编码的方法                                           |
| 13818-3 | Audio（音频）            | 描述与MPEG-1音频标准反向兼容的 音频编码方法                  |
| 13818-4 | Compliance（符合性测试） | 描述如何判断一个编码码流是否符合MPEG-2码流                   |
| 13818-5 | Software（软件实现）     | 描述了MPEG-2标准的第一、二、三部分的软件实现方法             |
| 13818-6 | DSM-CC （命令与控制）    | 描述交互式多媒体网络中服务器与用户间的会话信令集             |

​		MPEG-2标准 剩余的四个部分，因为没有广泛使用，就不列举了。

​		从上图的表格可以看出，MPEG-TS 封装格式的定义在 **13818-1** （System）里面。1990年 ATM视频编码专家组 跟 MPEG 组织合作，把 ISO/IEC 13818标准的 13818-1 搞成 ITU-TRec.H.220（System），把 13818-2 搞成 ITU-TRec.H.262 （Video）， ITU-TRec.H.220 跟 ITU-TRec.H.262 都是 **ITU-T** 标准的一部分。

​		其实各个组织之间是有合作的，对一些标准文档 做 扩展，衍生，单独提取之类的工作。



## 流编码结构

### MPEG4流的结构



![在这里插入图片描述](https://img-blog.csdnimg.cn/img_convert/7afd4879bf0f2888314624299b908d4d.png#pic_center)

#### 起始码

​		以`0x00 00 01`起始码为标志分割成若干处理单元。

#### 流ID

​		进行PS封装时，最基本的处理单元是VOP视频帧。I帧之前的参数集数据与I帧合并到一个单元处理。

- `Visual Object Sequence`，简称VOS，起始码`0x00 00 01 b0`
- `Visual Object`，简称VO，起始码 `0x00 00 01 b5`
- `MPEG4 Video Header Object`，简称MVHO，起始码` 0x00 00 01 00`
- `Video Object Layer`，简称VOL，起始码` 0x00 00 01 20`
- `MPEG4 Header UD`，简称MHUD，起始码 `0x00 00 01 b2`
- `Video Object Plane – I Frame`，简称VOP，起始码 `0x00 00 01 b6`
- `Video Object Plane – other Frame`，简称VOP，起始码` 0x00 00 01 b6`
- ...



### H264

​		标准 H.264 流以` 0x00 00 00 01 `起始码为标志分割成若干单元，称之为`Network Abstraction Layer unit`，缩写`NALu`。

​		H.264标准可以将一帧图像分成多个Slice进行编码，每个Slice会输出一个NALu，例如对一幅图像进行两场编码，则有两个NALu。

- (如果出现) `Access Unit Delimiter ` ，简称AUD ， 起始码 `0x00 00 01 09`
- `Sequence Parameter Set`，简称PPS，起始码 `0x00 00 01 67`
- `Picture Parameter Set`，简称，SPS起始码 `0x00 00 01 00`
- `Slice 0 of IDR Picture`，起始码，` 0x00 00 01 65`
- `Slice 1 of IDR Picture`，起始码， `0x00 00 01 05或01`

### H265

​		标准 H265 同 H264 多数语法，在 I 帧前后多一种 VPS 参数集。



### 定长帧音频及其他流式私有数据的结构

​		定长音频帧和其他流式私有数据的结构不做具体规定，但要求其中不出现 `0x000001` 形式的伪起始码。视为流式私有数据传输。流式私有数据结构在智能数据交换文档中规定。



## 流类型

### ES

​		Elementary Stream，基础码流。不分段的音频、视频或其他信息的连续码流。

​		 直接从编码器出来的数据流，可以是编码过的视频数据流（H.264、MJPEG等），音频数据流（AAC），或其他编码数据流的统称。ES流经过PES打包器之后，被转换成PES包。

```shell
video:
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  |   start code    | nalu header |          h264 data            |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         4 byte          1 byte               x byte
audio:
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  | adts header |                     aac data                    |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      7 byte                           x byte
```



### PES

​		Packetized Elementary Stream， ES形成的分组称为PES分组，是用来传递ES的一种数据结构。往ES包上面封装一层 加上 PTS 跟 DTS 等头部信息。

​		PES流是ES流经过PES打包器处理后形成的数据流，在这个过程中完成了将ES流分组、打包、加入包头信息（主要加入了PTS/DTS信息）等操作（对ES流的第一次打包）。

​		PES流的基本单位是PES包，PES包由包头和payload组成。每个PES包的PID是一致的，一个PES包可能由若干个TS包组成。

​		每个 pes packet 都包含一个完整的视频帧或音频帧，pes packet 结构如下：

```c
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
  | pes header |   optional pes header    |      pes payload    |
  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
      6 Byte           3~259 Byte              max 65526 Byte
```

- 6 Bytes 固定的 PES Header 

| 字段                     | 大小   | 描述                                                         |
| ------------------------ | ------ | ------------------------------------------------------------ |
| packet_start_code_prefix | 3 比特 | 起始码，固定为 0x000001                                      |
| stream_id                | 1 比特 | PES 包中的负载流类型。音频取值（0xc0-0xdf），通常为0xc0；视频取值（0xe0-0xef），通常为0xe0 |
| PES_packet_length        | 2 比特 | PES 包长度，包括此字段后的可选包头和负载的长度。0表示长度不限制，只有视频数据长度会超过0xffff |

- optional pes header 可选包头中的控制信息有很多，这里我们只给出与 pts、dts 有关的结构：

| 字段          | 大小   | 描述                                                         |
| ------------- | ------ | ------------------------------------------------------------ |
| PTS_DTS_flags | 2 bit  | 10 表示 PES 头部有 PTS 字段，11 表示有 PTS 和 DTS 字段，00 表示都没有，10 被禁止 |
| pts           | 40 bit | 实际 pts 长度占用 33 bit                                     |
| dts           | 40 bit | 实际 dts 长度占用 33 bit                                     |

> ​		PTS（显示时间戳）和 DTS（解码时间戳），是用来音视频同步的。DTS/PTS是相对SCR（系统参考）的时间戳，是以 90000 为单位，PTS/DTS 到 ms 的转换公式是 PTS/90，系统时钟频率为 90Khz，所以转换到秒为 PTS/90000。

![在这里插入图片描述](https://img-blog.csdnimg.cn/img_convert/f655dba61708ecf066e06bac9330eea5.png#pic_center)

### PS

​		Program Stream，节目流。将具有共同时间基准的一个或多个PES组合而成的单一数据流。用于播放或编辑系统的存储格式。



### TS

​		Transport Stream，传输流，用于数据传输的格式。将具有**共同时间基准或独立时间基准**的一个或多个PES组合而成的单一数据流。

> ​	TS在PES层上加入了数据流识别和传输的必要信息，是对PES的重新封装。TS含有独立的一个或者多个program，一个program又可以包含多个视频，音频和文字信息的ES流。

​		固定188个字节，一个大的 PES 包 会拆成多个 小的 块，封装进去 TS 包进行传输。

​		

### ps vs. ts

​		TS流的包结构是固定长度188字节的，而PS流的包结构是可变长度的。这导致了TS流的***\*抵抗传输误码\****的能力强于PS流。

> ​		误码的产生是由于在信号传输中，衰变改变了信号的电压,致使信号在传输中遭到破坏，产生误码。噪音、交流电或闪电造成的脉冲、传输设备故障及其他因素都会导致误码（比如传送的信号是1，而接收到的是0；反之亦然）。由于种种原因,数字信号在传输过程中不可避免地会产生差错。-- 百度百科

​		TCP ，UDP 协议有一个 **checksum** （校验和）字段 ，发生误码，底层直接丢弃数据包，不会丢上去给应用层。

​		实际上，对于 UDP 或者 TCP 来说，用 TS 封装格式还是 PS 封装格式 ，抵抗**传输误码**的能力是一样的，因为UDP ，TCP 这些协议帮你处理了误码情况。但是 TS 跟 PS 的标准不只是给 UDP 跟 TCP 用，录像机，DVD机，这些数字视频领域的设备，也会用到 PS 跟TS。

​		TS码流由于采用了固定长度的包结构，当传输误码破坏了某一TS包的同步信息时，接收机可在固定的位置检测它后面包中的同步信息，从而恢复同步，避免了信息丢失。而PS包由于长度是变化的，一旦某一 PS包的同步信息丢失，接收机无法确定下一包的同步位置，就会造成失步，导致严重的信息丢失。因此，在信道环境较为恶劣，传输误码较高时，一般采用TS码流；而在信道环境较好，传输误码较低时，一般采用PS码流。

​		由于TS码流具有较强的抵抗传输误码的能力，因此目前在传输媒体中进行传输的MPEG-2码流基本上都采用了TS码流的包格。
