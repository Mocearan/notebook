# Container 

---

​		 封装格式定义了如何存储音频、视频和其他数据（如字幕）的结构。封装格式不压缩数据，但它们包含的编码数据可能是压缩的。

​		所以封装格式一般指按一定规则编排音视频及其他媒体信息的多媒体结构的容器。但也经常将单一的音频或视频编码数据封装后进行传输或存储。

​		不同的封装格式在不同的场景下有不同的表现，如`FLV/HLS`在网络传输环境下要比`mp4`封装格式表现优秀。

> `HLS`实际上是协议而不是封装格式，通过引入`.m3u8`索引文件对媒体资源进行`TS`切片从而实现流式传输和更好的播放跳转。



## mp4

​		`mp4`是常见的封装格式，以`.mp4`作为文件后缀。可以通过`http://xxx.mp4`来访问`web`上的`mp4`文件资源。几乎所有的播放器都支持`mp4`封装格式。

​		`mp4`文件是一个数据块相互嵌套的树状结构，数据块一般称为`BOX`，不同数据块负责存储不同功能的信息，使用`mp4info / mp4Explorer`等工具进行查看。

​		`mp4`文件中重要的三种`box`是`ftyb / mdat / moov`三种：

- `ftyb`存放编码格式、标准等信息
  - 播放器根据这些信息选择对应的解码器
- `mdat`存放的是具体的音视频数据
  - 不包含时间戳
  - 依赖`moov`信息推算每帧播放时间
- `moov`存放元数据
  - 包括`mdat`数据的映射关系
  - 播放器根据`moov`的数据推算音视频帧的播放时间戳

​		很常见的一种网络上播放`.mp4`文件的情况是，需要一段时间才能播放出来，往往是因为还没有收到`moov`数据块。

> - 在线播放时，`moov`通常放在`mdat`数据之前
> - `ffmpeg -i x.mp4 -movflags faststart -c copy new.mp4`

​		如果视频文件很大的情况下，`mp4`文件并不适合网络传输，文件信息过多而且CDN加速效果不佳，长时间在线播放出现播放终端等不良情况。



## FLV

​		一般用作在线流媒体传输，网页上加入`flv.js`插件就可以播放。`FLV`格式文件每个音视频数据块都有播放时间戳，适合进行流式播放。

​		大文件、长时间播放比`mp4`更加稳定，但大文件`CDN`加速效果不佳，适合短视频为主、文件不大的网站系统。

​		未加载跳转失败大概率是因为没建立关键帧索引。

> 追歼关键帧索引：`ffmpeg -i old.flv -c copy -f flv -flvflags add_keyframe_index new.flv`



## HLS

​		`.m3u8`索引文件+`TS`封装流媒体文件。

- `.m3u8`支持二级索引，可以将多档清晰度的观看地址整合到一个所以文件中
  - 播放器可以根据单签带宽自动切换不同的观看地址
- 一个完整的视频会被`HLS`服务切分成很多段的`TS`分片文件
  - 适合长视频、大文件场景
  - 未加载跳转、CDN加速、多线程预加载等方面更加优秀
  - 短视频场景下优势不明显
- `TS`本身是完整的视频封装格式，能够单独播放
  - 由额外的文件信息冗余，产生不必要的流量
  - 需要在流媒体服务之外进行额外的转码（转封装）

