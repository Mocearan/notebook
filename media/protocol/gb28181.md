# GB28181

---

​		GB/T 28181： 由公安部科技信息化局提出的公共安全视频监控联网系统信息传输、交换、控制技术要求，由全国安全防范报警系统标准化技术委员会（SAC/TC100）归口，公安部一所等多家单位共同起草的一部国家标准。

​		标准规定了公共安全视频监控联网系统(以下简称联网系统) 的互联结构、通信协议结构， 传输、 交换、 控制的基本要求和安全性要求,，以及控制、 传输流程和协议接口等技术要求。使得来自不同厂商的设备可以实现统一的通信协议，并在同一平台上实现集成和管理。

- `GB28181`协议信令层面使用的是`SIP（Session Initiation Protocol）`协议
- 流媒体传输层面使用的是实时传输协议`RTP（Real-time Transport Protocol）`协议
  - 视音频编解码标准及封装格式规定了系统联网时媒体中
    - 视频支持的格式为SVAC、H.264、**H.265**、MPEG-4
    - 音频支持的格式为G.711、G.722.1、G723.1、G.729、SVAC、**AAC**

> 可以理解为GB28181是在国际通用标准的基础之上进行了私有化定制以满足视频监控联网系统互联传输的标准化需求。



   ![image-20240928173713389](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20240928173713389.png)

## 参考

[nvr(包含GB28181)推拉流测试:基于ubuntu:WVP+ZLMediaKit+MediaServerUI_wvp pro gb28181 模拟测试-CSDN博客](https://blog.csdn.net/m0_73191258/article/details/132478344)

[Linux平台下搭建GB28181服务器(WVP+ZLMediakit)_gb28181服务器搭建-CSDN博客](https://blog.csdn.net/yang1fei2/article/details/132223894?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~PaidSort-1-132223894-blog-132478344.235^v43^pc_blog_bottom_relevance_base7&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~BlogCommendFromBaidu~PaidSort-1-132223894-blog-132478344.235^v43^pc_blog_bottom_relevance_base7&utm_relevant_index=1)

[wvp-GB28181-pro 编译部署ubuntu系统【详细教程】_wvp gb28181 pro-CSDN博客](https://blog.csdn.net/KIDfengKID/article/details/127894376?ops_request_misc=%7B%22request%5Fid%22%3A%22169235127916777224455138%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=169235127916777224455138&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2allsobaiduend~default-1-127894376-null-null.142v93insert_down1&utm_term=ubuntu 部署wvp&spm=1018.2226.3001.4187)

优秀项目学习：GB2818.Solution ， ZLMediaKit 等



[智能安防系统开发_lcyw的博客-CSDN博客](https://machh.blog.csdn.net/category_9592385_2.html)

https://blog.csdn.net/haibindev?type=blog

[GB28181_却道天凉_好个秋的博客-CSDN博客](https://blog.csdn.net/www_dong/category_12422526.html)



[全网最全GB/T 28181网络基础-TCP协议](https://juejin.cn/post/7412502916644077580)

[全网最全GB/T 28181网络基础-UDP协议](https://juejin.cn/post/7411211646914674729)

[全网最全GB/T 28181网络基础-Rust实现TCP/UDP服务端](https://juejin.cn/post/7416499669637103657)

[全网最全GB/T 28181剖析4️⃣RTP包封装音视频流](https://juejin.cn/post/7418367857018290230)

## 版本

- 2011年起，我国推出了GB/T 28181-2011版本
  - 为安防行业的前端设备、平台服务器、平台客户端等安防产品的建设部署提供了基础标准
-  2016年，GB/T 28181标准进行了升级，推出了GB/T 28181-2016版本
  - 进一步细化和完善了视频监控设备之间的通信协议规范
  - 使得不同厂商的设备能够更好地在同一平台上协同工作
- 2022年，推出了GB/T 28181-2022版本
  - 于2023年7月正式发布，同时废止了2016版本

[GB/T 28181-2011、2016、2022变更对比](https://blog.csdn.net/byxdaz/article/details/130462816)

## 概念

​		`GB28181`协议会话通道实际上使用的是SIP协议，并且在SIP协议的基础之上做了些定制化扩展。

> ​		SIP协议会与许多其它的协议协同工作，如SIP报文内容发送会话描述协议（Session Description Protocol，SDP）4，SDP协议描述了会话所使用流媒体细节，如：使用哪个IP端口，采用哪种编解码器等等

​		在`GB28181`协议中，联网系统在进行视音频传输及控制时应建立两个传输通道: 会话通道和媒体流通道。

- 会话通道用于在设备之间建立会话并传输系统控制命令;
  - **注册与认证**：设备通过SIP协议向平台注册，实现身份验证与接入。
  - **会话控制**：利用INVITE、ACK等SIP消息建立、控制及终止媒体会话。
  - **命令交互**：设备控制命令（如云台操作）通过SIP MESSAGE传递。

- 媒体流通道用于传输视音频数据， 经过压缩编码的视音频流采用流媒体协议RTP/RTCP传输
  - **流传输**：媒体数据通过RTP协议传输，RTCP负责质量控制。
  - **适应性**：自动调整适应网络状况，支持跨NAT传输。


![img](https://raw.githubusercontent.com/Mocearan/picgo-server/main/b853a9a7eaa9af140e7740b36e6fc88e.png)

### 基本概念

- 信令：用于控制和管理通信会话的一系列指令或消息
  - 信令在视频监控系统中用于建立、维护和终止视频、音频和其他数据的传输
  - `GB/T 28181`标准中的信令交互主要基于SIP进行扩展
    - SIP是一种用于建立、修改和终止多媒体会话（如视频通话、音频通话等）的通信协议
    - `GB/T 28181`中，设备间通过SIP信令建立通信会话和传输控制信息
    - 常用的SIP消息包括注册、设备搜索、设备状态查询、设备控制等

- 流媒体：音视频流，在传输层面使用RTP
  - `GB/T 28181`协议中，RTP主要用于传输高清流畅的视频图像
  - RTP支持多种音视频编码格式，不同厂商、不同型号的视频监控设备能够集成到同一个系统
  - RTP协议还提供了时间戳和序列号机制，用于保持音视频数据的同步和连续性
    - 确保用户能够观看到连续、稳定的监控画面

- `SIP client`：符合 IETF   RFC   3261 规定的，具有注册登记、建立/终止会话连接、接收和播放视音频流等功能的实体
  - 主要包括用户界面、用户代理(UA) 、媒体解码模块和媒体通信模块。

- `sip`监控域：支持`gb28181`协议规定的设备组成的监控网络
  - 前端设备、用户终端、SIP服务器和网络等组成的监控系统
  - 每个SIP监控域就是一个基础的28181通信模型，包括：
    - 前端SIP设备：摄像机、NVR、下级平台等
    - 信令安全路由网关
    - 中心信令控制服务器
    - 流媒体服务器
    - 展示层面的SIP客户端

- 非`sip`监控域：不支持`gb28181`协议规定的监控网络，不支持本标准规定的通信协议的监控资源、用户终端、网络等构成的监控网络
  -  模拟接入设备
  - 不支持本标准规定的通信协议的数字接入设备
  - 模数混合型监控系统
  - 不支持本标准规定的SIP协议的数字型监控系统



### SIP中的概念

​		

- 中心信令控制服务器：具有向SIP客户端、SIP设备、媒体服务器和网关提供注册、路由选择以及逻辑控制功能，并且提供接口与应用服务器通信的服务器。
  - 逻辑实体包括代理服务器、注册服务器、重定向服务器、 背靠背用户代理等的一种或者几种
  - 是负责核心SIP信令应用处理的SIP服务器
- 媒体服务器：提供实时媒体流的转发服务,提供媒体的存储、历史媒体信息的检索和点播服务的服务器
  - 媒体服务器接收 来自SIP设备、网关或其他媒体服务器等设备的媒体数据
  - 并根据指令,将这些数据转发到其他单个或 者多个SIP客户端和媒体服务器
- 信令安全路由网关：具有接收或转发域内外 SIP 信令功能，实现 SIP 域间路由信息传递以及路由信令、信令身份标识的添加和鉴别等功能的实体
- 注册服务器：SIP逻辑实体，是具有接收注册请求、将请求中携带的信息进行保存并提供本域内位置服务的功能服务器
- 重定向服务器：SIP逻辑实体，负责规划SIP呼叫路由
  - 它将获得的呼叫下一跳地址信息告诉呼叫方
  - 请求方根据此地址直接向下一跳发出请求，此后重定向服务器退出呼叫过程
  - 2022版本中新增
- 用户代理（SIPUA）：指的是一个SIP逻辑网络端点，用于创建、发送、接收SIP消息并管理一个SIP会话。
  - SIP用户代理又可分为用户代理客户端UAC（User Agent Client）和用户代理服务端UAS（User Agent Server）
  - UAC创建并发送SIP请求，UAS接收处理SIP请求，发送SIP响应
- 代理服务器：SIP逻辑实体
  - 通过它把来自用户代理客户端(UAC)的请求转发到用户代理服务端(UAS)并把UAS的响应消息转发回 UAC
  - 一个请求消息有可能通过若干个代理服务器来传送
    - 每一个代理服务器独立地确定路由
    - 响应消息 沿着请求消息相反的方向传递
- 背靠背用户代理：SIP逻辑实体
  - 作为用户代理服务端(UAS)接收请求消息并处理该消息
  - 同时作为用户代理客户端(UAC)来发送请求消息



### 基于SIP的好处

- 多媒体会话控制能力
  - SIP在多媒体会话控制方面表现出色，‌能够支持音频、‌视频等多种媒体类型的会话建立、‌修改和终止
  - GB/T 28181协议借鉴SIP的会话控制能力，‌可以方便地实现视频监控系统的多媒体会话管理，‌提高系统的兼容性和灵活性。‌
- 用户定位和移动性支持
  - SIP的用户定位和移动性支持功能
    - 通过SIP终端在注册服务器上的注册信息，‌SIP可以确保在任何网络中都能发起和接收多媒体会话
  - 前端监控设备可以灵活地部署，通过SIP协议与监控中心建立连接，‌实现实时监控和数据传输
- 开放的协议标准和广泛的应用基础
  - SIP开放标准协议，‌被广泛应用
  - SIP协议具有成熟的技术实现和丰富的应用案例
  - 借鉴SIP标准，‌可以充分利用SIP协议的成熟技术和应用经验，‌提高视频监控联网系统的技术水平和应用效果
- 易于扩展和集成
  - SIP协议具有易于扩展和集成
  - 通过添加新的扩展头和方法，‌SIP协议可以不断扩展其功能，‌满足不同的应用需求
  - 借鉴SIP的这些特点，‌可以方便地与其他系统（‌如公安、‌交通、‌应急等部门系统）‌进行对接和集成
- SIP支持复杂的通信场景，包括用户定位、会话管理、代理与重定向服务等
  - 为GB28181提供了处理大规模视频监控网络中 设备注册、呼叫建立、状态传递 等功能所需的技术基础
- 成熟的技术生态
  - SIP在通信行业有广泛的应用基础，相关的开发工具、测试环境和专业人才较为丰富
  - GB28181协议借助这一生态，可以降低开发难度，加速产品的上市时间，并且便于维护和升级



### gb28181在SIP上的拓展

- 安全性
  - SIP消息可以使用TLS加密
  - 媒体流SRTP（Secure Real-time Transport Protocol）加密传输
  - 敏感信息的数据保护，如视频内容、位置信息等，确保信息处理过程中的隐私安全
- 视频监控特定功能
  - 设备注册流程：详细流程，注册信息，身份认证标识
  - 目录服务：明确规范了目录查询命令的格式和内容
  - 实时流控制：对RTP进行了特定的扩展和规范
    - 定义了特定的会话描述协议（SDP）属性，支持安防监控中多码流选择、码率自适应、按需传输等
    - 增加了对实时视频流的控制命令，如播放、暂停、快进等，以满足监控画面的实时操控需求
  - 事件与告警：运动检测、越界报警等
  - 音视频编码：规定了音视频编码解码器标准
- 互操作性规范
  - 统一信令格式
  - 媒体传输协议规范整合
  - 故障恢复和重传机制
- 大规模组网支持
  - 多级级联
  - 负载均衡：信令路由优化，支持负载均衡策略
- 规范化信息格式
  - 要求设备和平台支持特定格式的XML配置文件，确保不同厂商设备的互操作性
  - 定义了统一的事件通知消息格式，如报警事件、设备状态变更等，在消息体中使用XML格式描述事件详情
- 国际化与标准化
  - 与国际标准兼容
  - 加入中文字符支持，网内网络特殊配置
  - 预留ONVIF等系统对接能力



### GB28181功能

- 注册和注销；
- 实时视音频点播；
- 控制；
- 报警事件通知与分发；
- 网络设备信息查询；
- 状态信息报送；
- 设备视音频文件检索；
- 历史视音频回放；
- 视音频文件下载；
- 校时；
- 订阅与通知；
- 语音广播与语音对讲；
- 设备软件升级；
- 图像抓拍；



### 优缺点

​		优势

- **互联互通** 确保多厂商视频监控设备无缝连接，增强系统互操作兼容性。
- **实时传输** 保障视频、音频流实时无误传输。
- **设备管控** 涵盖设备注册至故障诊断的全面管理，维系系统稳定性。
- **信息交换** 促进设备间视频、音频及报警信息的共享与互通。
- **安全防护** 内置用户认证、数据加密等多重安全措施，加固系统安全。
- **标准扩展** 基于开放标准设计，易于系统集成与未来扩展。

​		缺陷与挑战。为了持续改进，需要采用有效的工程策略去应对这些不足。

- **兼容性** 存在厂商间互操作障碍，对28181协议的描述理解存在歧义，视频流传输解码效果不一等，需定制开发适配。
- **技术融合** 初期设计未充分融合新兴技术，限制智能化扩展。
- **安全风险** 面临网络安全挑战，需增强防护措施。
- **实施难度** 配置复杂，资源不同步问题明显，增加小企业成本负担。
- **资源需求** 占用带宽和计算资源较多，影响性能。



## 网络结构





![sip监控域是什么 监控区域什么意思_字段](https://s2.51cto.com/images/blog/202403/20192523_65fac7a3d539b63210.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

![image-20240928172938412](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20240928172938412.png)

![image-20240928172919381](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20240928172919381.png)

### 平级互联

​		信令安全路由网关之间是平级关系。

- 共享对方SIP监控域的监控资源
  - 由信令安全路由网关 向 目的信令安全路由网关发起
  - 目的信令安全路由网关鉴权认证
  - 进行平级系统间通信

![sip监控域是什么 监控区域什么意思_sip监控域是什么_02](https://s2.51cto.com/images/blog/202403/20192524_65fac7a4030cd35511.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

![sip监控域是什么 监控区域什么意思_sip监控域是什么_03](https://s2.51cto.com/images/blog/202403/20192524_65fac7a41e45985023.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

### 上下级联

​		信令安全路由网关之间是上下级关系。

- 下级信令安全路由网关主动向上级信令安全路由网关 发起注册
- 经上级信令安全路由网关鉴权认证后才能进行上下级系统间通信

![sip监控域是什么 监控区域什么意思_sip监控域是什么_04](https://s2.51cto.com/images/blog/202403/20192524_65fac7a43b24063250.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

![sip监控域是什么 监控区域什么意思_sip监控域是什么_04](https://s2.51cto.com/images/blog/202403/20192524_65fac7a43b24063250.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)



![image-20240928173227643](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20240928173227643.png)

- IPC设备利用GB/T 28181协议无缝融入视频监控平台或NVR设备中
- NVR设备不仅可直接下联IPC采集视频，还能向上与监控平台对接，形成**上下贯通**的链路
- 协议允许**多层级联**，便利了不同层级的视频监控平台间通过级联方式实现协议交互与视频流的高效传送
- 从而构筑了一个全方位、互联互通的监控网络

### 域和非域互联

​		通过融合网关在多个层次上对协议和媒体数据进行转换，分为控制协议网关和媒体网关。

![sip监控域是什么 监控区域什么意思_字段_05](https://s2.51cto.com/images/blog/202403/20192524_65fac7a451dea63486.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

- 控制协议网关：网络传输协议、控制协议、设备地址的转换
  -  代理非SIP监控域设备在SIP监控域的SIP服务器上进行注册
  - 将非SIP监控域的网络传输协议与GB28181中规定的网络传输协议（IP，TCP和UDP）进行双向协议转换
  - 非SIP监控域的设备控制协议与GB28181中规定的会话初始协议（SIP【注册，预览，回放】）、会话描述协议（SDP）、控制描述协议（MANSCDP，采用SIP Message消息体携带，负责设备控制、报警控制等命令）和媒体回放控制协议（MANSRTSP，采用SIP Info消息体携带，负责回放控制命令）进行双向协议转换
  - 非SIP监控域的设备地址与GB28181中规定的设备地址（SIP用户ID、URL编码规则）进行双向地址转换

- 媒体网关：媒体传输协议、媒体数据编码格式的转换
  -  将非SIP监控域的媒体传输协议和数据封装格式与GB28181规定的媒体传输协议（RTP/RTCP）和数据封装格式（PS） 进行双向协议转换
  - 将非SIP监控域的媒体数据与GB28181中规定的媒体数据压缩编码（视频H.264、 MPEG-4，音频G.711、G.723.1、G.729、SVAC）进行双向转码



## 协议结构

![img](https://pics6.baidu.com/feed/b21c8701a18b87d66f7b9d2837fcb2321e30fdce.jpeg@f_auto?token=ce3151a0db5870a9899594abd1d4e67e)

​		连网系统视频监控在进行视频、音频传输及控制时，应建立两个传输通道：会话通道和媒体流通道。会话通道用于在设备之间建立会话，并传输系统控制命令；媒体流通道用于传输视频、音频数据，经过压缩编码的视频、音频流（采用流媒体协议RTP/RTCP传输）。

- 会话初始协议。安全注册、实时媒体点播、历史媒体回放等应用的会话控制采用SIP规定的注册、发起等请求和响应方法实现，历史媒体回放控制采用S1P扩展协议RFC2976规定的INFO方法实现，前端设备控制、信息查询、报警事件通知和转发等应用的会话控制采用SIP扩展协议RFC3428规定的消息方法实现。SIP消息应支持基于UDP和TCP的传输。
- 会话描述协议。连网系统有关设备之间会话建立过程的会话协商和媒体协商应采用SDP协议描述，主要内容包括会话描述、媒体信息描述、时间信息描述。会话协商和媒体协商信息应采用S1P消息的消息体携带传输。
- 控制描述协议。连网系统有关前端设备控制、报警信息、设备目录信息等控制命令，应采用监控报警连网系统控制描述协议（MANSCDP）描述。连网系统控制命令，应采用SIP消息的消息体携带传输。
- 媒体回放控制协议。历史媒体的回放控制命令，应修改采用MANSRTSP协议描述，实现设备端到端之间对视/音频流的正常播放、快速、暂停、停止、随机拖动播放等远程控制。历史媒体的回放控制命令，采用S1P消息INFO的消息体携带传输。
- 媒体传输与媒体编/解码协议。
  - 媒体流在连网系统IP网络上传输时，应支持基于UDP的RTP传输
    - 媒体流的传输应采用RTP协议，提供实时数据传输中的时间戳信息及各数据流的同步
    - 采用RTCP协议，为按序传输数据包提供可靠保证，提供流量控制和拥塞控制
  - GB28181协议中规定了两种方式传输媒体流
    - 将音视频数据打包成`MPEG2-PS`流然后再通过`RTP`协议传输，实际应用中主要使用这种方式
      - 基于`RTP`的`PS`封装首先按照`ISO/IEC13818-1:20008`将视音频流封装成PES包
      - 然后再将`PES`包封装成`PS`包
        - 每个视频帧独立封装为一个`PS`包
        - 每个关键帧的PS包中应包含系统头(`System Header`)和`PSM(Program Stream Map)`
          - 系统头和PSM放置于`PS Header`之后、第一个`PES`包之前
          - `PS Header | PS system header | PSM | PES v | PES a | ...`
        - 视频非关键帧的PS包结构中一般不包含系统头和PSM
        - PS包中各部分的具体数据结构参见`ISO/IEC13818-1:2000`中的相关描述
      - 再将PS包以负载的方式封装成RTP包
        - `PS`包的`RTP`封装格式参照`IETF RFC2250`
        - RTP的主要参数设置如下
          - 负载类型(payloadtype):96
          - 编码名称(encoding_name):PS
          - 时钟频率(clockrate):90 kHz
          - SDP描述中“m”字段的“media”项:video
    - 直接使用RTP传输裸的音视频流



## 国标ID编码

​		国标ID（国标编号或国标设备ID），是指按照`GB/T 28181`协议中定义的ID编码规则，为设备分配的唯一标识符。用于在公共安全视频监控联网系统中标识和区分不同的设备。

​		对每个设备来说，除了设备ID，还有通道ID（包括视频通道ID，音频通道ID，报警通道ID等）。理论上在整个国标系统中，全部ID都必须保持唯一。不能出现不同设备下的通道ID相同的情况。

​		国标ID共20位，由多个部分组成：

### 中心编码

​		`8`位，设备所属监控中心的身份识别标识。

​		中心编码严格依照 GB/T 2260-2007 所规定的行政区划代码来予以确定，充分保障了编码所具备的地域性显著特征。当设备不属于基层单位时，空余位以 0 进行填充，进一步精细化了编码的层次结构体系。

![img](https://pics7.baidu.com/feed/a1ec08fa513d26978c078cc478a0cdf54216d839.jpeg@f_auto?token=53e5af3663385316bc41304afdd72ac0)

### 行业编码

​		`2`位，区分不同行业领域的设备或者系统。

​		借助特定的编码数值，达成了行业之间的有效区分辨别。

![img](https://pics0.baidu.com/feed/5882b2b7d0a20cf4ffd03d5e58523438adaf995d.jpeg@f_auto?token=647a51d05f9c151681686e7faa15a184)

![img](https://pics4.baidu.com/feed/50da81cb39dbb6fda20fee6f277fd416962b3788.jpeg@f_auto?token=6978661485b4c2d3a47bea89aae7a7ea)



### 类型编码

​		`3`位，设备或者系统的具体类型。

​		类型编码能够反映出设备的种类类别，便于在系统内部进行快速准确的识别以及分类管理操作。

> ​		如中心服务器、DVR（数字视频录像机）、NVR（网络视频录像机）以及摄像机等，都拥有专属的类型编码。

![img](https://pics6.baidu.com/feed/6a63f6246b600c33d12dad8934172e01d8f9a180.jpeg@f_auto?token=175281ba73dbbe2b1832ba37cf88371d)

![img](https://pics0.baidu.com/feed/b64543a98226cffc664551d5975a359ef703ead0.jpeg@f_auto?token=c4cf831ff368e9e2ea312bfa90232e46)



### 网络标识

​		`1`位，用于标识设备接入的网络类型，如公网、专网等。

![img](https://pics3.baidu.com/feed/91529822720e0cf383cb3b39271d8d11bf09aa99.jpeg@f_auto?token=3ff9c2f0eef69e50ddf6e64c4b25103c)

### 序号

​		`7`位，同一中心、行业和类型之下，设备或者系统的唯一身份标识。

​		序号确保了每个设备或者系统都具备独一无二的身份特质。通过序号的合理编排，能够清晰明了地知晓设备在系统当中的位置分布以及排列顺序，为设备的维护保养与管理运作提供了极大的便捷性。

![img](https://pics3.baidu.com/feed/91529822720e0cf383cb3b39271d8d11bf09aa99.jpeg@f_auto?token=3ff9c2f0eef69e50ddf6e64c4b25103c)



### 实例

​		摄像机的 20 位编码为：11000000011320000001

- **中心编码：**11000000（北京市行政区划代码，后两位为 0 表明非基层单位）
- **行业编码：**01（公安系统）
- **类型编码：**132（摄像机）
- **序号：**0000001（假设为该公安系统中的第一台摄像机）



## 消息结构

### REGISTER

#### 请求

```http
REGISTER sip:34020000002000000001@3402000000 SIP/2.0       
Via: SIP/2.0/UDP 192.168.137.11:5060;rport;branch=z9hG4bK1371463273						   				
From: <sip: SIP设备编码@源域名>;tag=185326220    // From: sip:34020000001320000003@3402000000;tag=2043466181
To: <sip: SIP设备编码@源域名>                    // To: sip:34020000001320000003@3402000000
Call-ID: ms1214-322164710-681262131542511620107-0@172.18.16.3
CSeq: 1 Register
Contact: <sip: SIP设备编码@源IP地址端口>         // sip:34020000001320000003@192.168.137.11:5060
Authorization: Capability algorithm = "A: RSA/ECB/PKCS1, RSA/CBC/PKCS1; H: SHA1, MD5, SHA256; S: DES/ECB/PKCS5, DES/CBC/PKCS5, 3DES/ECB/PKCS5, 3DES/CBC/PKCS5, SCB2"
Max-Forwards: 70
User-Agent: IP Camera
Expires: 3600
Content-Length: 0
```

- `REGISTER`中`sip:`后跟 SIP服务器的国标ID@SIP服务器的域国标ID

- `Via`中 

  - 传输协议可以使用`tcp/udp`

  - 必须包含`branch`参数，具体值是一个在整个SIP通信过程中不重复的数值。

    > ​		branch是一个事务ID（Transaction ID），用于区分同一个UA所发起的不同Transaction，它不会对未来的request或者是response造成影响，对于遵循IETF RFC3261规范的实现。
    >
    > ​		这个branch参数的值必须用”z9hG4bK”打头， 其它部分是对To， From, Call-ID头域和Request-URI按一定的算法加密后得到。

  - `rport`字段表示使用`rport`机制路由响应

    > ​		即`Via`中有`rport`时，响应按照`rport`给出的端口发送SIP响应，也就是说IP和端口均完全遵照从哪里来的，发回哪里去的原则。
    >
    > ​		如果没有rport字段时，服务端的策略是IP使用UDP包中的地址，但是端口使用的是via中的端口，详情见IETF RFC35818。

- `from`中包含了请求发送方的逻辑标识，在GB28181协议中是发送请求的设备国标ID和域国标ID信息

  - tag`参数`是为了身份认证的，值为随机数字字符

- `to`标明请求接收方的逻辑标识的，在GB28181协议中填写的是发送请求的设备国标ID和域国标ID信息

- `Call-ID`头是全局唯一的，在同一个`session`中保持一致，在不同`session`中不同

- `CSeq`头又叫`Command Seqence`命令序列，用于标识命令顺序

  - 值为 `sequence Method`

    - sequence 部分为无符号整数，最大值为2^31
    - 序号起始值是随机的，后续在同一个session中依次递增

    > 比如发1 REGISTER没返回--->再发2 REGISTER--->没返回--->再发3 REGISTER--->这时返回了2 REGISTER就知道是第2个请求得到了响应

  - 对于`ACK`和`CANCLE`中的`CSeq`与`INVITE`中的`Cseq`保持一致

- `Contact`，包含源的URI信息，用来给响应消息直接和源建立连接用。在GB28181协议中为SIP设备编码@源IP地址端口。

- `Max-Forwards`头用于设置包最大中转次数，默认是70

- `User-Agent`头用于设置关于UA的信息，用户可以自定义

- `Expires`头表示超时时间

- `Content-Length`头表示`SDP`消息的长度，因为`REGISTER`消息不需要`SDP`，因此为`0`

-  `Authorization`头字段用于增加安全认证

#### 响应

```http
SIP/2.0 200 OK
Via:To: sip: SIP设备编码@源域名
Content-Length: 0
CSeq: 1 Register
Call-ID: ms1214-322164710-681262131542511620107-0@172.18.16.3
From: <sip: SIP 设备编码@源域名>;tag=185326220
Via: SIP/2.0/UDP 源域名或IP 地址端口
WWW-Authenticate: Asymmetric nonce="EUiG7xqPhJwSyD71BgMGCUtzp2 AObEdeRVn0cao0JaWPC8VcVBrrHif4+n0mXsHBXFnDGJ43DYWPnPx9XjwEHfl6iN+5SFu0JMa/cQ/VV8Quf8GE3hK7m5c6rGN+Mi61blTwhkI40+vI7ifFnRXbZM5iKynPz7XA1gr91Wd/7hY=&CXUUHOL6RctO..." algorithm="A:RSA/ECB/PKCS1&SHA1"
```

- 在响应的消息头 `WWW-Authenticate`字段中给出适合 `SIP UA`的认证模式和参数
  - `WWW-Authenticate`取值为 `Asymmetric`
  - 参数`nonce`分为a和b两部分
  - `algorithm `的值取`SIPUA `安全能力中的 算法



### MESSAGE

#### 请求

```http
MESSAGE sip:34020000002000000001@3402000000 SIP/2.0
Via: SIP/2.0/UDP 192.168.137.11:5060;rport;branch=z9hG4bK1066375804
From: sip:34020000001320000003@3402000000;tag=1925919231
To: sip:34020000002000000001@3402000000
Call-ID: 1185236415
CSeq: 20 MESSAGE
Content-Type: Application/MANSCDP+xml
Max-Forwards: 70
User-Agent: IP Camera
Content-Length: 175

<?xml version="1.0" encoding="UTF-8"?>
<Notify>
    <CmdType>Keepalive
    <SN>1
    <DeviceID>34020000001320000003
    <Status>OK
    <Info></Info>
</Notify>
```

#### 响应

​		`Message`消息的成功和错误应答均无消息体

```http
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.137.11:5060;rport;branch=z9hG4bK1066375804
From: sip:34020000001320000003@3402000000
To: sip:34020000002000000001@3402000000
CSeq: 20 MESSAGE
Call-ID: 1185236415
User-Agent: FFmpeg GB28181 v1.0
Content-Length: 0
```



### INVITE

#### 请求

```http
INVITE sip:34020000001320000003@3402000000 SIP/2.0
Via: SIP/2.0/UDP 39.100.155.146:15063;rport;branch=z9hG4bK34208805
From: sip:34020000002000000001@39.100.155.146:15063;tag=512358805
To: sip:34020000001320000003@3402000000
Call-ID: 200008805
CSeq: 20 INVITE
Content-Type: Application/SDP
Contact: sip:34020000001320000003@3402000000
Max-Forwards: 70
User-Agent: FFmpeg GB28181 v1.0
Subject: 34020000001320000003:630886,34020000002000000001:0
Content-Length: 164

v=0
o=34020000001320000003 0 0 IN IP4 39.100.155.146 
s=Play
c=IN IP4 39.100.155.146
t=0 0
m=video 9000 RTP/AVP 96
a=setup:passive
a=recvonly
a=rtpmap:96 PS/90000
y=630886
```

- `INVITE sip:34020000001320000003@3402000000 SIP/2.0`

  - **sip:62010201001320000108@10.18.34.1:5060**: 指定了被邀请方的SIP统一资源定位符（URI），其中包括用户名（`62010201001320000108`）、SIP服务器的IP地址（`10.18.34.1`）和端口号（`5060`），这是设备或用户接收呼叫的位置

  - `sip:34020000001320000003@3402000000`，SIP服务器的IP地址和端口号由SIP域代理

- 消息头域中携带 `Subject  `字段，包含点播媒体源的参数：

  - **媒体流发送者ID**: 为符合附录E定义的媒体流发送者的编码。

  - **发送方媒体流序列号**: 发送方媒体流序列号为不超过20位的字符串;当请求为实时视频时,首位取值为0,对于相同的实时视频取值唯一;当请求的媒体流为历史视频时,首位取值为1,对于每一路历史视频取值唯一。
  - **媒体流接收者ID**: 为符合附录E定义的媒体流接收者的ID编码。
  - **接收方媒体流序列号**: 为媒体流接收端的标识序列号,在同一时刻该序列号在媒体流接收者端为不重复的字符串。当接收者为客户端时,可以作为窗口的标识符。

- `Contact`: 提供了发送此INVITE请求的设备或用户的联系信息。

  - `Contact: <sip:51000000002000000001@10.18.104.201:5060>`，发送方的SIP URI是`51000000002000000001`，位于IP地址`10.18.104.201`的`5060`端口上，可以直接回复

  - `Contact: sip:34020000001320000003@3402000000`，发送方的SIP URI是`34020000001320000003`，位于`3402000000`域，需要代理转换

- `s=` ，`Play`代表实时点播， `Playback`标识回播请求，`Download`代表文件下载，`Talk` 代表语音对讲。

- `o=`，`INVITE`发起者的相关信息，后面的内容依次为设备国标ID、session ID、session版本、网络类型（IN/OUT）、地址类型（IPV4/IPV6）、发起者IP

- `c=`，连接数据，依次是网络类型（IN/OUT）、地址类型（IPV4/IPV6）、发起者IP

- `t=`，表示起始时间和终止时间，由于是实时点播，没有起始时间和终止时间，因此均为0.

- `m=`，媒体流参数，m字段描述媒体的媒体类型、端口、传输层协议、负载类型等内容

  - 媒体类型
    - 采用`video`标识传输视频或视音频混合内容
    - 采用`audio`标识传输音频内容

  - 传输方式
    - `RTP/AVP`，输层协议为`RTP over UDP`
    - `TCP/RTP/AVP`，传输层协议为R`TP over TCP`
  - 负载类型为客户端支持的类型，可能有多个，由服务器进行选择

  > `m=video 6000 RTP/AVP 96`：媒体类型为视频或视音频，传输端口为6000，采用RTP over UDP传输方式，负载类型为96
  >
  > `m=video 6000 TCP/RTP/AVP 96`：媒体类型为视频或视音频，传输端口为6000，采用RTP over TCP传输方式，负载类型为96

- `a=`，媒体相关的参数，用IETF RFC 4566

  - `a=rtpmap:<payload type> <encoding name>/<clock rate>  [/<encoding parameters>]`

    - `<encoding name>`，利用该属性携带编码器厂商名称，或编码标准（PS等）

    - `clock rate`，时钟频率或者说时间戳单位，每秒多少个时间戳单位，意味着媒体流中的时间戳增量应按照此频率进行计算。

      > ```
      > a=rtpmap:96 DAHUA/90000
      > a=rtpmap:96 HIKVISION/90000
      > ```

    - 该属性表明该流为某厂商编码器编码且是不符合本标准规定的媒体流， 符合本标准规定的媒体流无需该属性

  - `recvonly`表示仅接收媒体流，`sendonly`表示仅发送

  - `setup`：TCP连接方式(表示本SDP发送者在RTP over TCP连接建立时是主动还是被动发起TCP连接）

    - "`active`”为主动，"`passive`”为被动

  - `a=connection:new`，表示采用`RTP over TCP`传输时，新建或重用原来的TCP连接,可固定采用新建TCP连接的方式

  - `a=stream:main`

  - `a=streamnumber:0`，主辅码流的定义，生产中2022版本有说明，其他版本为厂商私有定义

- `y=`，表示SSRC，可以在端口复用模式情况下区分不同路的媒体流，SSRC值全局唯一，用户可以自定义。

  - 第1位为历史或实时媒体流的标识位,0为实时,1为历史
  - 第2位至第6位取20位SIP监控域ID之中的4到8位作为域标识，例如“13010000002000000001”中取数字“10000”
  - 第7位至第10位作为域内媒体流标识,是一个与 当前域内产生的媒体流SSRC值后4位不重复的四位十进制整数。




#### 响应

```http
SIP/2.0 200 OK     // or SIP/2.0 100 Trying
Via: SIP/2.0/UDP39.100.155.146:15063;rport=15063;branch=z9hG4bK34208805
From: sip:34020000002000000001@39.100.155.146:15063;tag=512358805
To: sip:34020000001320000003@3402000000;tag=1083111311
Call-ID: 200008805
CSeq: 20 INVITE
Contact: sip:34020000001320000003@192.168.137.11:5060
Content-Type: application/sdp
User-Agent: IP Camera
Content-Length: 263

v=0
o=34020000001320000003 1073 1073 IN IP4 192.168.137.11
s=Play
c=IN IP4 192.168.137.1115t=0 0      //192.168.40.66:音视频流源地址    注：视音频源与目的地址不局限于级联服务器本身
m=video 15060 RTP/AVP 96        // 96:服务端所选择的码流格式   音视频端口统一使用偶数端口   port+1为rtcp端口
a=setup:active
a=sendonly
a=rtpmap:96 PS/90000
y=0000630886
```



### INFO

#### 请求

```http
INFO sip:161128022553273720@192.168.40.66:7100 SIP/2.0
Via: SIP/2.0/UDP 192.168.40.55:7100;rport;branch=z9hG4bK1764044774
From: <sip:120105110228023020@192.168.40.55:7100>;tag=4105413651
To: <sip:00000000001310018021@192.168.40.66:7100>;tag=4232579586
Call-ID: 2259139548
CSeq: 21 INFO
Contact: <sip:120105110228023020@192.168.40.55:7100>
Content-Type: Application/MANSRTSP
Max-Forwards: 70
User-Agent: NCG V2.6.0.299938
Content-Length:    49

PLAY MANSRTSP/1.0
CSeq: 59367
Scale: 0.000000                       // Scale：回播速度控制    例：Scale: 8.000000   快进x8
```

> Gb28181标准中，明确说明历史视音频的回复控制命令应采用监控报警联网系统实时流协议(MANSRTSP),并采用SIP消息INFO消息体携带传输。（GBT 28181-2016 4.3.5）

#### 响应

```http
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.40.55:7100;rport=7100;branch=z9hG4bK1764044774
From: <sip:120105110228023020@192.168.40.55:7100>;tag=4105413651
To: <sip:00000000001310018021@192.168.40.66:7100>;tag=4232579586
Call-ID: 2259139548
CSeq: 21 INFO
Contact: <sip:161128022553273720@192.168.40.66:7100>
User-Agent: NCG V2.6.0.299938
Content-Length: 0
```





### ACK

```http
ACK sip:34020000001320000003@3402000000 SIP/2.0
Via: SIP/2.0/UDP 39.100.155.146:15063;rport;branch=z9hG4bK34208805
From: sip:34020000002000000001@39.100.155.146:15063;tag=512358805
To: sip:34020000001320000003@3402000000
Call-ID: e484c728-dfe5-4a4d-8b2f-2561fb7578ca0
CSeq: 20 ACK
Max-Forwards: 70
User-Agent: FFmpeg GB28181 v1.0
Content-Length: 0
```

- `CSeq`：Command Sequence Number，是一个序列号，用于唯一标识一个请求及其响应。

  - 是一个递增的计数器，确保每个请求都是唯一的
  - 与对应的响应相匹配。后面跟着的`ACK`表明这个序列号对应的是一个ACK消息。

- `Call-ID`：是一个全局唯一的标识符，用于标识一次特定的会话或通话

  - 即使有多个相同`From`和`To`标签的对话，Call-ID也会不同，确保每个对话都能被唯一识别
  - 通常由随机生成的字符串组成

  

### BYE

#### 请求

```http
BYE sip:34020000001320000003@3402000000 SIP/2.0
Via: SIP/2.0/UDP 39.100.155.146:15063;rport;branch=z9hG4bK34208805
From: sip:34020000002000000001@3402000000;tag=512358805
To: sip:34020000001320000003@3402000000;tag=1083111311
Call-ID: 200008805                  // // Call-ID：该字段判断请求端口哪一路视频
CSeq: 7 BYE
Max-Forwards: 70
User-Agent: FFmpeg GB28181 v1.0
Content-Length: 0
```

#### 响应

```http
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.40.55:7100;rport=7100;branch=z9hG4bK1981844232
From: <sip:120105110228023020@192.168.40.55:7100>;tag=2249831759
To: <sip:00000000001310018021@192.168.40.66:7100>;tag=2885333649
Call-ID: 821763613
CSeq: 21 BYE
User-Agent: NCG V2.6.0.299938
Content-Length: 0
```





## 功能流程

​		会话通道中

- **注册、实时视音频点播、历史视音频的回放**的会话控制采用SIP协议IETF RFC3261中规定的`REGISTER`、`INVITE`请求和响应实现
- **历史视音频回放控制**采用`SIP`扩展协议IETF RFC29765规定的`INFO`方法实现
- **前端设备控制、信息查询、报警事件通知和分发**等应用的会话控制采用`SIP`扩展协议IETF RFC34287规定的`MESSAGE`方法实现

![img](https://raw.githubusercontent.com/Mocearan/picgo-server/main/917645-20180423091003505-1189103411.png)

### 注册

​		注册指的是设备或系统进入联网系统时向SIP服务器（SIP UAS）进行注册登记的工作模式。

- 使用**REGISTER**方法进行注册和注销；
- 注册和注销应进行认证，认证方式应支持**数字摘要**认证方式，高安全级别的宜支持**数字证书**认证；
- 注册成后，SIP代理在注册过期时间到来之前，应向注册服务器进行刷新注册；
- 若注册失败，应在不短于60s的时间间隔内重新发起注册；
- 系统、设备注册过期时间可配置；
- SIP代理是否注册成功决定SIP服务器在离线状态；
- 对于处于**开启网络地址转换(NAT)功能的路由器**内侧的SIP代理，应该支持使用TCP发起SIP注册，并在注册成功后保持TCP连接不关闭，SIP代理及服务器在该TCP通道里发送所有请求及响应SIP消息。若TCP通道断开，则认为SIP代理异常掉线，SIP代理应在一定时间间隔内重新发起注册；

- 设备（或者下级平台）向上级平台发送注册信息，携带上级平台和自己的国标ID等信息
- 上级平台收到注册信息后
  - 首先校验其中的上级平台国标ID是否正确，如果不正确，则拒绝接入
  - 校验其中的设备（或者下级平台）国标ID，是否已经在平台中添加
    - 如果已经添加，则允许接入
    - 如果没有添加过，则拒绝连接
- 注销流程也一致，请求中的Expires为0表示注销



#### 设备身份认证

- 低安全级别：数字摘要认证
- 高安全级别：数字证书认证

​		高安全级别下：

- 网络层宜采用IPSec或传输层宜采用TLS对SIP消息实现逐跳安全加密（逐跳安全加密【链路加密】是指在离开一个节点【网络中的中继节点】进入信道时加密，在离开信道通过节点时解密，因此数据在信道中呈现密文形式，在节点中呈现明文形式）
- 宜在应用层采用S/MIME机制的端到端加密（在源端进行加密，在传输过程中不解密，一直到达目的端才进行解密因此对于中继节点来说，用户数据是不可知的密文）
- 会话密钥宜采用RSA算法加密，传输内容宜采用DES、3DES、AES128算法加密
- 数据存储宜采用3DES、AES(128位)、SM1等算法进行加密



#### 摘要认证

​		GB28181协议中基于数字摘要的挑战应答式安全技术进行注册：

![sip监控域是什么 监控区域什么意思_字段_06](https://s2.51cto.com/images/blog/202403/20192524_65fac7a47e6d996244.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)



#### 数字整数认证

![sip监控域是什么 监控区域什么意思_字段_07](https://s2.51cto.com/images/blog/202403/20192524_65fac7a4901f674536.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)




#### SIP信令认证

​		保证信令来源安全。

​		注册成功后，信令交互时采用数字摘要方式，对除 `Register`消息以外的每一条消息都做数字摘要。

- 启用了 Date字段信令消息的头域
  -  Date比对有效时间范围可设,初设值为10min,应在校时精度范围内
  - Date精确到秒
- 在头域中增加 Note字段
  - 值为 Digest，有两个参数 nonce、algorithm
  - Note=(Digest nonce="",algorithm =)
    - nonce的值为algorithm[From+to+CallID+Date+seed+消息体]数字摘要经过BASE64编码后 的值
    - algorithm 的值为数字摘要的算法名称,“+”为字符串连接运算
- 当跨域访问时
  - 若该信令是由本域的用户发起
    - 信令安全路由网关宜将发送到外域的信令添加` Monitor-User-Identity`头域
    - 其取值为信令安全路由网关ID 和用户的身份信息
  - 若该信令不是由本域 的用户发起
    - 只在原有` Monitor-User-Identity`域值前添加信令安全路由网关ID
    - 各段分隔符为`-`
  -  用户的身份为用户ID以及用户身份属性信息

![sip监控域是什么 监控区域什么意思_服务器_12](https://s2.51cto.com/images/blog/202403/20192525_65fac7a52cea526772.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)



#### 设备配置

1. 本地SIP端口：默认5060，相机针对GB28181协议开放的通信端口；
2. 传输协议：支持UDP和TCP协议；
3. 勾选“启动”按钮，启用GB28181-2016协议；
4. SIP服务器ID：服务器标识，详见GB28181协议定义；
5. SIP服务域：SIP服务器ID的前10位；
6. SIP服务器地址：**SIP服务所在机器的IP地址**；
7. SIP服务端口：**SIP服务端口**；

​		启用GB28181后，设备定期对外发送REGISTER命令，如无服务端连接，由ICMP协议返回464目标不可达。



#### 基本注册流程

- 1:`SIP  `代理向 `SIP  `服务器发送 `REGISTER  `请求

  - 通过添加`Authenticate`字段增加 `SIPUA `安全能力

  ```http
  REGISTER sip:130909115229300920@10.64.49.44:7100 SIP/2.0
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport;branch=z9hG4bK4162288924
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=382068091
  To: <sip:130909113319427420@10.64.49.218:7100>
  Call-ID: 143225205
  CSeq: 1 REGISTER
  Contact: <sip:130909113319427420@10.64.49.218:7100>
  Max-Forwards: 70
  User-Agent: Hikvision
  Expires: 7200
  Content-Length: 0
  ```

- 2:`SIP  `服务器向 `SIP UA`发送响应`401`，表示未认证

  - Authorization`的值为 `Capability`
  - 参数`algorithm `的值分为三部分
    - 第一部分为非对称算法描述，取值为 RSA
    - 第 二 部分为摘要算法描述，取值为 MD5/SHA-1/SHA-256中的一个或者多个
    - 第三部分为对称算法的描述，取值为 DES/3DES/ SM1中的一个或者多个

  ```http
  SIP/2.0 401 Unauthorized
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport=7100;branch=z9hG4bK4162288924
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=382068091
  To: <sip:130909113319427420@10.64.49.218:7100>;tag=916944766
  Call-ID: 143225205
  CSeq: 1 REGISTER
  WWW-Authenticate: Digest realm="hik", nonce="a8afe6fcbee6331d89d3eb0d3d19ce39", opaque="a853e4f25298413f9bf3a9aa6767857d", algorithm=MD5
  User-Agent: Hikvision
  Expires: 7200
  Content-Length: 0
  ```


- 3:`SIP UA `重新向 SIP 服务器发送 `REGISTER  `请求，在请求的 `Authorization`字段给出认证信息

  - `SIPUA `收到`401`响应后，得到`nonce`中的`a`和`b`两部分

    - a为SIP服务做的摘要，b为SIPUA的公钥加密的报文

  - 首先用`SIPUA `私钥解密`b`，得到结果`c`

  - 对结果`c`用`401`响应中`algorithm `指定的算法做摘要，得到结果`d`

  - 用`sip`服务器公钥解密`a`，得到结果`d`

  - 结果`d`进行匹配，如果相匹配则信任该结果，否则丢弃

  - `SIPUA `重新向 `SIP`服务器发送 `Register`请求

    - `Authorization`取值为 `Asymmetric`

    - 参数`nonce`的值与上面`2:`中的相同

    - `response`的值为用本消息中`algorithm `指明的算法对`[c+nonce]`做摘要的结果

  ```http
  REGISTER sip:130909115229300920@10.64.49.44:7100 SIP/2.0
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport;branch=z9hG4bK3997518011
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=382068091
  To: <sip:130909113319427420@10.64.49.218:7100>
  Call-ID: 143225205
  CSeq: 2 REGISTER
  Contact: <sip:130909113319427420@10.64.49.218:7100>
  Authorization: Digest username="admin", realm="hik", nonce="a8afe6fcbee6331d89d3eb0d3d19ce39", uri="sip:130909115229300920@10.64.49.44:7100", response="907ddb1bcc25174d7de4a96c947fb066", algorithm=MD5, opaque="a853e4f25298413f9bf3a9aa6767857d"
  Max-Forwards: 70
  User-Agent: Hikvision
  Expires: 7200
  Content-Length: 0
  ```



- 4:`SIP  `服务器对请求进行验证，如果检查出 `SIP UA`身份合法，向 `SIP  UA`发送成功响`200`，如果身份不合法则发送拒绝服务应答

  ```http
  SIP/2.0 200 OK
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport=7100;branch=z9hG4bK3997518011
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=382068091
  To: <sip:130909113319427420@10.64.49.218:7100>;tag=705514612
  Call-ID: 143225205
  CSeq: 2 REGISTER
  Contact: <sip:130909113319427420@10.64.49.218:7100>
  User-Agent: Hikvision
  Date: 2013-09-10T16:01:51
  Content-Length: 0
  ```



### 注销

- SIP代理向SIP服务器发送REGISTER请求，**Expires字段的值为0，表示SIP代理要注销**；

  ```http
  REGISTER sip:130909115229300920@10.64.49.44:7100 SIP/2.0
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport;branch=z9hG4bK1670314216
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=1928169842
  To: <sip:130909113319427420@10.64.49.218:7100>
  Call-ID: 3187228566
  CSeq: 1 REGISTER
  Contact: <sip:130909113319427420@10.64.49.218:7100>
  Max-Forwards: 70
  User-Agent: Hikvision
  Expires: 0
  Content-Length: 0
  ```

- SIP服务器向SIP代理响应401(未认证)，返回的消息头里给出适合SIP代理的认证体制和参数；

  ```http
  SIP/2.0 401 Unauthorized
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport=7100;branch=z9hG4bK1670314216
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=1928169842
  To: <sip:130909113319427420@10.64.49.218:7100>;tag=1002632848
  Call-ID: 3187228566
  CSeq: 1 REGISTER
  WWW-Authenticate: Digest realm="hik", nonce="42dc1acbe02b15743942c0af9314768b", opaque="8e3da4136ac9ab537de09a9932c2a9a3", algorithm=MD5
  User-Agent: Hikvision
  Expires: 0
  Content-Length: 0
  ```

- SIP代理重新向SIP服务器发送REGISTER请求，在请求的Authorization中给出信任书，包括认证信息，Expires字段的值为0；

  ```http
  REGISTER sip:130909115229300920@10.64.49.44:7100 SIP/2.0
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport;branch=z9hG4bK317693249
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=1928169842
  To: <sip:130909113319427420@10.64.49.218:7100>
  Call-ID: 3187228566
  CSeq: 2 REGISTER
  Contact: <sip:130909113319427420@10.64.49.218:7100>
  Authorization: Digest username="admin", realm="hik", nonce="42dc1acbe02b15743942c0af9314768b", uri="sip:130909115229300920@10.64.49.44:7100", response="7328353ed26e3f2edf3ff57e834d5665", algorithm=MD5, opaque="8e3da4136ac9ab537de09a9932c2a9a3"
  Max-Forwards: 70
  User-Agent: Hikvision
  Expires: 0
  Content-Length: 0
  ```

- SIP服务对请求进行认证，如检测SIP代理身份合法，向SIP代理响应200 OK，如检测不合法发送拒绝服务应答；

  ```http
  SIP/2.0 200 OK
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport=7100;branch=z9hG4bK317693249
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=1928169842
  To: <sip:130909113319427420@10.64.49.218:7100>;tag=409851991
  Call-ID: 3187228566
  CSeq: 2 REGISTER
  Contact: <sip:130909113319427420@10.64.49.218:7100>
  User-Agent: Hikvision
  Date: 2013-09-10T14:04:41
  Content-Length: 0
  ```




### 注册重定向

​		注册重定向是2022新增内容

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/60839df81f13a9fbb854c9114957db87.png)

#### 重定向流程

1. 设备或系统段的SIP代理向SIP重定向服务器发送REGISTER请求；
2. SIP重定向服务器向SIP代理响应401(未认证)，返回的消息头里给出适合SIP代理的认证体制和参数；
3. SIP代理重新向SIP重定向服务器发送REGISTER请求，在请求的Authorization中给出信任书，包括认证信息；
4. **SIP重定向服务器验证请求，如检测SIP代理身份合法，SIP重定向服务器根据内部策略选择设备需注册的SIP服务器A，并回复注册请求响应302，响应消息携带Contact头域和Expires，Contact格式为sip:SIP服务器A编码@目的IP地址端口，在此头域中携带SIP服务A的地址**；
5. SIP代理收到302重定向请求后，向SIP服务器A发起注册；
6. 6~8：完成注册重定向流程后，后续所有请求和响应动作由SIP服务器A和设备直接完成；
7. **重定向后，如果SIP代理检测SIP服务器A离线或注册被SIP服务器拒绝，SIP代理应重新执行注册重定向流程，向SIP重定向服务器发起注册请求**；

### 保活

- 当UA发现工作异常时， 应立即向本SIP监控域的SIP服务器发送状态信息
- 无异常时，定时向本SIP监控域的SIP服务器发送状态信息
- SIP设备宜在状态信息中携带故障子设备描述信息
- 通过周期性的状态信息报送，实现注册服务器与原设备之间的状态检测，即心跳机制
  - 心跳发送方、接收方需统一配置间隔，默认心跳间隔`60s`
  - 心跳发送方、接收方需统一配置超时次数，连续超时达到“超时次数认为对方下线，默认超时次数`3`次
  - 心跳接收方在心跳发送方上线状态下，检测到连续超时达到超时次数认为心跳发送方离线
  - 心跳发送方在心跳接收方上线状态下，检测到心跳响应消息连续超时达到超时次数认为心跳接收方离线

- 状态信息报送采用IETF RFC3427中定义的方法`MESSAGE`实现

![img](https://raw.githubusercontent.com/Mocearan/picgo-server/main/v2-a6e9bfc7b299c7b6f0bd0692cb3f1881_1440w.webp)



#### 保活信令xml格式

```xml
<! -- 命令类型:设备状态信息报送(必选)--> 
<elementname="CmdType"fixed="Keepalive"/> 
<! -- 命令序列号(必选)--> 
<elementname="SN" type="integer"minInclusivevalue= "1"/> 
<! -- 源设备的设备/系统编码(必选)--> 
<elementname="DeviceID" type="tg:deviceIDType"/> 
<! -- 是否正常工作(必选)--> 
<elementname="Status"type="tg:resultType"/> 
<! --故障设备列表-->
<elementname="Info">     
    <complexType>         
        <sequence>             
            <elementname="DeviceID"type="tg:deviceIDType" minOccurs="0" maxOccurs="unbounded"/>         
        </sequence>     
    </complexType> 
</element>
```



#### 保活信令流程

- 源设备向SIP服务器发送设备状态信息报送命令
  - 设备状态信息报送命令采用`MESSAGE`方法携带
    - `Content-type: Application/MANSCDP+xml`
    - 状态信息报送命令采用`MANSCDP`协议格式定义， 详细描述见`GB/T 28181—2016`中`A.2.5`状态信息报送
  
  ```http
  MESSAGE sip:130909115229300920@10.64.49.44:7100 SIP/2.0
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport;branch=z9hG4bK2672759896
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=308835751
  To: <sip:130909115229300920@10.64.49.44:7100>
  Call-ID: 63810466
  CSeq: 20 MESSAGE
  Content-Type: Application/MANSCDP+xml
  Max-Forwards: 70
  User-Agent: Hikvision
  Content-Length:   150
  
  <?xml version="1.0"?>
  <Notify>
      <CmdType>Keepalive</CmdType>
      <SN>2749</SN>
      <DeviceID>130909113319427420</DeviceID>
      <Status>OK</Status>
  </Notify>
  ```
- SIP服务器收到命令后返回`200 OK`

  ```http
  SIP/2.0 200 OK
  Via: SIP/2.0/UDP 10.64.49.218:7100;rport=7100;branch=z9hG4bK2672759896
  From: <sip:130909113319427420@10.64.49.218:7100>;tag=308835751
  To: <sip:130909115229300920@10.64.49.44:7100>;tag=1578583786
  Call-ID: 63810466
  CSeq: 20 MESSAGE
  User-Agent: Hikvision
  Content-Length: 0
  ```



### 设备查询

- 源设备向目标设备发送信息查询命令，目标设备将结果通过查询应答命令返回给源设备；
- 设备信息查询命令包括：
  - 设备目录
  - 设备信息
  - 设备状态信息
  - 设备配置
  - 预置位、看守位
  - 巡航轨迹列表
  - 巡航轨迹
  - PTZ精准状态
  - 存储卡状态等
- 信息查询的范围：本地SIP监控域、跨SIP监控域；
- 网络设备信息查询命令均采用**`MESSAGE`**方法；
- 目录查询应答命令支持多响应消息传输；
- 源设备：
  - SIP客户端
  - 网关或联网系统
- 目标设备：
  - SIP设备端
  - 网关或联网系统

![在这里插入图片描述](https://i-blog.csdnimg.cn/blog_migrate/dda2a75501c8e5ae8913c4524e44cf75.png)

​		设备查询使用同一套流程，根据查询的命令不同，请求和相应荷载的XML结构不同。

#### 设备查询流程

- SIP服务器向目标设备转发设备查询命令

  ```http
  MESSAGE sip:130909113319427420@10.64.49.218:7100 SIP/2.0
  Via: SIP/2.0/UDP 10.64.49.44:7100;rport;branch=z9hG4bK32925498
  From: <sip:130909115229300920@10.64.49.44:7100>;tag=1307626839
  To: <sip:130909113319427420@10.64.49.218:7100>
  Call-ID: 2367611040
  CSeq: 20 MESSAGE
  Content-Type: Application/MANSCDP+xml    // 设备信息查询命令采用MANSCDP协议格式；
  Max-Forwards: 70
  User-Agent: Hikvision
  Content-Length:   124
  
  <?xml version="1.0" encoding="GB2312"?>
  <Query>
      <CmdType>Catalog</CmdType>
      <SN>471</SN>
      <DeviceID>130909113319427420</DeviceID>
  </Query>
  ```

- 目标设备收到命令后返回200OK;

  ```http
  SIP/2.0 200 OK
  Via: SIP/2.0/UDP 10.64.49.44:7100;rport=7100;branch=z9hG4bK32925498
  From: <sip:130909115229300920@10.64.49.44:7100>;tag=1307626839
  To: <sip:130909113319427420@10.64.49.218:7100>;tag=1981225076
  Call-ID: 2367611040
  CSeq: 20 MESSAGE
  User-Agent: Hikvision
  Content-Length: 0
  ```

- 目标设备向SIP服务器发送设备查询响应命令

  ```http
  MESSAGE sip:51000000002000000001@5100000000 SIP/2.0
  Via: SIP/2.0/UDP 10.18.44.86:5060;rport;branch=z9hG4bK897441835
  From: <sip:62010201001320000393@5100000000>;tag=1617705135
  To: <sip:51000000002000000001@5100000000>
  Call-ID: 17524357
  CSeq: 20 MESSAGE
  Content-Type: Application/MANSCDP+xml  			// 设备信息查询应答命令采用MANSCDP协议格式；
  Max-Forwards: 70
  User-Agent: IP Camera
  Content-Length:   586
  
  <?xml version="1.0" encoding="GB2312"?>
  <Response>
  <CmdType>Catalog</CmdType>
  <SN>1708</SN>
  <DeviceID>62010201001320000393</DeviceID>
  <SumNum>1</SumNum>
  <DeviceList Num="1">
  <Item>
  <DeviceID>62010201001320000393</DeviceID>
  <Name>Camera 01</Name>
  <Manufacturer>Hikvision</Manufacturer>
  <Model>IP Camera</Model>
  <Owner>Owner</Owner>
  <CivilCode>5100000000</CivilCode>
  <Address>Address</Address>
  <Parental>0</Parental>
  <ParentID>51000000002000000001</ParentID>
  <SafetyWay>0</SafetyWay>
  <RegisterWay>1</RegisterWay>
  <Secrecy>0</Secrecy>
  <Status>ON</Status>
  </Item>
  </DeviceList>
  </Response>
  ```

- SIP服务器收到命令后返回200OK;

  ```http
  SIP/2.0 200 OK
  Via: SIP/2.0/UDP 10.64.49.44:7100;rport=7100;branch=z9hG4bK32925498
  From: <sip:130909115229300920@10.64.49.44:7100>;tag=1307626839
  To: <sip:130909113319427420@10.64.49.218:7100>;tag=1981225076
  Call-ID: 17524357
  CSeq: 20 MESSAGE
  User-Agent: Hikvision
  Content-Length: 0
  ```

  







#### 目录检索

​		先要询问设备的视频通道的列表，为点播做准备。

![image.png](https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8299b91f643440f5a5e20517d85de941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFuYm94:q75.awebp?rk3s=f64ab15b&x-expires=1728027543&x-signature=XR5aAJ8GgwlymbIV3PfDd2kxNOY%3D)



##### 目录检索请求格式

```xml
<?xml version="1.0" encoding="GB2312"?>
<Query>
    <! -- 命令类型:设备信息查询(必选)-->
    <CmdType>Catalog</CmdType>
    <! -- 命令序列号(必选)，消息中的SN值用于与请求命令的匹配处理,响应命令中的SN值应使用请求命令中的SN值。--> 
    <SN>1708</SN>
    <! -- 目标设备的设备编码(必选)-->
    <DeviceID>62010201001320000393</DeviceID>
</Query>
```

##### 目录检索响应格式

```xml
<?xml version="1.0" encoding="GB2312"?>
<Response>
    <! -- 命令类型:设备目录查询(必选)-->
    <CmdType>Catalog</CmdType>
    <SN>1708</SN>
    <! -- 目标设备/区域/系统的编码,取值与目录查询请求相同(必选)-->
    <DeviceID>62010201001320000393</DeviceID>
    <! -- 查询结果总数(必选)-->
    <SumNum>1</SumNum>
    <! -- 设备目录项列表,Num 表示目录项个数，注意双引号-->
    <DeviceList Num="1">
        <Item>
            <! -- 设备/区域/系统编码(必选)-->
            <DeviceID>62010201001320000393</DeviceID>
            <! -- 设备/区域/系统名称(必选)-->
            <Name>Camera 01</Name>
            <! -- 当为设备时,设备厂商(必选)-->
            <Manufacturer>Hikvision</Manufacturer>
            <! -- 当为设备时,设备型号(必选)-->
            <Model>IP Camera</Model>
            <! -- 当为设备时,设备归属(必选)-->
            <Owner>Owner</Owner>
            <! -- 行政区域(必选)-->
            <CivilCode>5100000000</CivilCode>
            <! -- 当为设备时,安装地址(必选)-->
            <Address>Address</Address>
            <! -- 当为设备时,是否有子设备(必选)1有,0没有-->
            <Parental>0</Parental>
            <! -- 父设备/区域/系统ID(必选)-->
            <ParentID>51000000002000000001</ParentID>
            <! -- 信令安全模式(可选)缺省为0; 0:不采用;2:S/MIME 签名方式;3:S/ MIME加密签名同时采用方式;4:数字摘要方式-->
            <SafetyWay>0</SafetyWay>
            <! -- 注册方式(必选)缺省为1;1:符合IETFRFC3261标准的认证注册模 式;2:基于口令的双向认证注册模式;3:基于数字证书的双向认证注册模式-->
            <RegisterWay>1</RegisterWay>
            <! -- 保密属性(必选)缺省为0;0:不涉密,1:涉密-->
            <Secrecy>0</Secrecy>
            <! -- 设备状态(必选)-->
            <Status>ON</Status>
            ... 其他请参考协议文档
        </Item>
    </DeviceList>
</Response>
```



#### 设备信息

​		包括设备ID等信息。

##### 设备信息查询请求格式

```xml
<?xml version="1.0" encoding="GB2312"?>
<Query>
    <! -- 命令类型:设备信息查询(必选)-->
    <CmdType>DeviceInfo</CmdType>
    <! -- 命令序列号(必选)，消息中的SN值用于与请求命令的匹配处理,响应命令中的SN值应使用请求命令中的SN值。--> 
    <SN>1708</SN>
    <! -- 目标设备的设备编码(必选)-->
    <DeviceID>62010201001320000393</DeviceID>
</Query>
```



##### 设备信息查询响应格式

```xml
<?xml version="1.0" encoding="GB2312"?>
<Response>
    <! -- 命令类型:设备目录查询(必选)-->
    <CmdType>Catalog</CmdType>
    <SN>1708</SN>

    <! -- 设备/区域/系统编码(必选)-->
    <DeviceID>62010201001320000393</DeviceID>
    <! -- 设备/区域/系统名称(必选)-->
    <Name>Camera 01</Name>
    <! -- 当为设备时,设备厂商(必选)-->
    <Manufacturer>Hikvision</Manufacturer>
    <! -- 当为设备时,设备型号(必选)-->
    <Model>IP Camera</Model>
    <! -- 当为设备时,设备归属(必选)-->
    <Owner>Owner</Owner>
    <! -- 行政区域(必选)-->
    <CivilCode>5100000000</CivilCode>
    <! -- 当为设备时,安装地址(必选)-->
    <Address>Address</Address>
    <! -- 当为设备时,是否有子设备(必选)1有,0没有-->
    <Parental>0</Parental>
    <! -- 父设备/区域/系统ID(必选)-->
    <ParentID>51000000002000000001</ParentID>
    <! -- 信令安全模式(可选)缺省为0; 0:不采用;2:S/MIME 签名方式;3:S/ MIME加密签名同时采用方式;4:数字摘要方式-->
    <SafetyWay>0</SafetyWay>
    <! -- 注册方式(必选)缺省为1;1:符合IETFRFC3261标准的认证注册模 式;2:基于口令的双向认证注册模式;3:基于数字证书的双向认证注册模式-->
    <RegisterWay>1</RegisterWay>
    <! -- 保密属性(必选)缺省为0;0:不涉密,1:涉密-->
    <Secrecy>0</Secrecy>
    <! -- 设备状态(必选)-->
    <Status>ON</Status>
    ... 其他请参考协议文档

</Response>
```



#### 设备状态

##### 设备状态请求格式

```xml
<?xml version="1.0" encoding="GB2312"?>
<Query>
    <! -- 命令类型:设备信息查询(必选)-->
    <CmdType>DeviceStatus</CmdType>
    <! -- 命令序列号(必选)，消息中的SN值用于与请求命令的匹配处理,响应命令中的SN值应使用请求命令中的SN值。--> 
    <SN>1708</SN>
    <! -- 目标设备的设备编码(必选)-->
    <DeviceID>62010201001320000393</DeviceID>
</Query>
```



##### 设备状态响应格式

```xml
<?xml version="1.0" encoding="GB2312"?>
<Response>
    <! -- 命令类型:设备目录查询(必选)-->
    <CmdType>Catalog</CmdType>
    <SN>1708</SN>

    <DeviceID>xxx</DeviceID>
	<Result>OK</Result>
	<Online>ONLINE</Online>
	<Status>OK</Status>
	<DeviceTime>2023-09-15T21:30:15</DeviceTime>
	<Alarmstatus Num="0">
	</Alarmstatus>
	<Encode>ON</Encode>
	<Record>OFF</Record>

</Response>
```





### 设备控制



#### 无应答

![img](https://i0.hdslb.com/bfs/new_dyn/b3dd3c7f06c9000d8f6dfb0c85bcb11a407536888.png@1256w_632h_!web-article-pic.webp)

​		`GB28181`的设备控制应满足以下基本要求:

- 源设备向目标设备发送控制命令

  > 控制命令的类型包括:
  >
  > ​		 摄像机云台控制、远程启动、录像控制报警布防/撤防、报警复位、强制关键顿、拉框放大、拉框缩小、看守位控制、PTZ 精准控制、存储卡格式化、目标跟踪、软件升级、设备配置等

- 设备配置的内容包括基本参数、视频参数范围、SVAC 编码、SVAC 解码视频参数属性、录像计划、报警录像、视频画面遮挡、画面翻转、报警上报开关、前端 OSD、图像抓拍配置

- 控制应采用 `IETF RFC3428` 中的 `MESSAGE `方法实现;

- 源设备向目标设备发送摄像机云台控制、远程启动、强制关键帧、拉框放大、拉框缩小、PTZ 精准控制、存储卡格式化、目标跟踪命令后,目标设备不发送应答命令

- 源设备向目标设备发送录像控制、报警布防/撤防、报警复位、看守位控制、软件升级、设备配置命令后

  - 目标设备应发送应答命令表示执行的结果

- 源设备包括 SIP 客户端网关或者联网系统，目标设备包括 SIP 设备网关或者联网系统。

​		控制命令流程描述如下：

- 1:源设备向`SIP  `服务器发送设备控制命令
  - 设备控制命令采用 `MESSAGE  `方法携带
- 2:SIP服务器收到命令后返回`200 OK`
- 3:SIP服务器向目标设备发送设备控制命令
  - 设备控制命令采用` MESSAGE  `方法携带
- 4:目标设备收到命令后返回`200 OK`



#### 有应答

![sip监控域是什么 监控区域什么意思_信令_16](https://s2.51cto.com/images/blog/202403/20192525_65fac7a5e3e1675497.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

​		请求和响应是通过XML报文中的SN序号进行标识的



### 实时预览

​		实时视音频点播采用SIP协议中的`INVITE`方法实现会话连接，采用`RTP/RTCP`协议(`IETF RFC3550`)实现媒体传输。

​		实时视音频点播需要上述的媒体流保活机制。

#### 客户端发起

​		`SIP`服务器采用`B2BUA`（背靠背用户代理）方式建立媒体服务器与接收者，媒体服务器与发送者之间的媒体流信令过程。

​		流程较为复杂，因为实际视频监控系统中，用户不直接跟前端监控设备交互，而是与监控管理平台交互。

- 媒体接收者，通常是用户的客户端
- SIP服务器，是单独的信令服务器，是监控管理平台
- 媒体服务器，通常是监控系统中的媒体网关
- 媒体流发送者，是前端的摄像机、录像机

![img](https://raw.githubusercontent.com/Mocearan/picgo-server/main/v2-c9f0de1bcc6cb2fba6c5896e22adbd16_1440w.webp)

> - 信令`1、8、9、10、11、12`为 `SIP`服务器接收到客户端的呼叫请求后，通过 `B2BUA  `方式建立 媒体流接收者与媒体服务器之间的媒体流信令过程
>   - 由SIP服务器作为中继，将媒体流接收者和媒体服务器之间的信令代理转发，称为背靠背用户代理
> - 信令`2～7`为 `SIP`服务器通过三方呼叫控制，建立媒体服务器与媒体流发送者之间的媒体流信令过程
>   - 媒体服务器与媒体流发送者之间没有直接的信令交互，由SIP服务器作为第三方来控制呼叫
> - 信令`13～16 `为媒体流接收者断开与媒体服务器之间的媒体流信令过程
> - 信令`17～20 `为 `SIP  `服务器断开媒体服务器与媒体流发送者之间的媒体流信令过程

​		命令流程描述如下：

- 1: 媒体流接收者向SIP服务器发送 `Invite  `消息

--> `SIP`服务器通过三方呼叫控制，建立媒体服务器与媒体流发送者之间的媒体流信令过程

- 2:SIP服务器收到 `Invite  `请求，通过三方呼叫控制建立媒体服务器和媒体流发送者之间的媒体连接
  - 向媒体服务器发送 `Invite`  消息，此消息不携带 `SDP `消息体
- 3:媒体服务器以`200 OK  `响应`SIP `服务器的 `Invite  `请求
  - 携带 `SDP  `消息体，描述媒体服务器接收媒体流的IP、端口、媒体格式等
- 4:`SIP  `服务器向媒体流发送者发送 `Invite  `请求
  - 携带 消息`3 `中`200 OK `响应消息体
  - `s `字段为Play`”代表实时点播
  - 增加`y`字段描述 `SSRC `值 ，`f` 字段描述媒体参数
- 5:媒体流发送者以`200 OK  `响应SIP 服务器的 `Invite `请求
  - 携带 `SDP `消息体，描述了媒体流发送者发送媒体流的 IP、端口、媒体格式、SSRC 字段等内容
- 6:`SIP  `服务器向媒体服务器发送 `ACK `请求
  - 携带消息`5`中`200 OK  `响应消息体，完成与媒体服务器的 Invite  会话建立过程
- 7:`SIP` 服务器向媒体流发送者发送` ACK  `请求
  - 不携带消息体，完成`SIP`服务器与媒体流发送者的 `Invite `会话建立过程
  - 媒体流发送者向媒体服务器发送实时媒体流

---> 完成三方呼叫控制后，`SIP  `服务器通过`B2BUA  `代理方式建立媒体流接收者和媒体服务器之间的媒体连接。

-  8: `SIP`服务器向媒体服务器发送`Invate`请求
   - 携带消息1中`SDP`
   - 增加 `SSRC `值，转发给媒体服务器
-  9:媒体服务器回复`200 OK` 响应
   - 携带 SDP 消息体，消息体中描述了媒体服务器发送媒体流的 IP、端口、媒体格式、SSRC  值等内容。
-  10:`SIP`服务器将消息`9`转发给媒体流接收者
-  11:媒体流接收者发送`ACK `消息，完成与 `SIP  `服务器的 `Invite  `会话建立过程
-  12:`SIP `服务器将消息`11`转发给媒体服务器，完成与媒体服务器的 `Invite  `会话建立过程

---> 媒体服务器向媒体接收者发送实时媒体流。

----> 媒体接收者断开媒体流。

- 13: 媒体流接收者向 `SIP  `服务器发送 `BYE `消息
  - 断开消息1、10、11建立的同媒体流接收者的`Invite  `会话
- 14:`SIP `服务器收到 `BYE `消息后回复`200 OK  `响应，会话断开
- 15:`SIP  `服务器收到 `BYE  `消息后向媒体服务器发送 `BYE  `消息
  - 断开消息8、9、12 建立的同媒体服务器的 `Invite  `会话
- 16:媒体服务器收到 `BYE  `消息后回复`200 OK` 响应，会话断开
- 17:`SIP   `服务器向媒体服务器发送 `BYE  `消息
  - 断开消息2、3、6建立的同媒体服务器的 `Invite`会话
- 18:媒体服务器收到 `BYE `消息后回复`200 OK `响应，会话断开
- 19:`SIP   `服务器向媒体流发送者发送` BYE ` 消息
  - 断开消息4、5、7建立的同媒体流发送者的`Invite  `会话
- 20:媒体流发送者收到 `BYE  `消息后回复`200 OK  `响应，会话断开



#### 第三方呼叫

![sip监控域是什么 监控区域什么意思_服务器_14](https://s2.51cto.com/images/blog/202403/20192525_65fac7a59bc8c39386.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

​		命令流程描述如下:

- 1:`SIP`服务器向媒体服务器发送`Invite`消息
  - 此消息不携带`SDP`消息体
- 2:媒体服务器收到`SIP`服务器的`Invite`请求后，回复`200OK` 响应
  - 携带`SDP`消息体，消息体中描述了媒体服务器接收媒体流的IP、端口、媒体格式等内容
- 3:SIP服务器收到媒体服务器返回的`200OK` 响应后,向媒体流发送者发送Invite请求,请求中携带消息2中媒体服务器回复的200OK 响应消息体,s字段为“Play”代表实时点播,增加y 字段描述SSRC值,f字段描述媒体参数
- 4:媒体流发送者收到SIP服务器的Invite请求后,回复200OK 响应,携带SDP消息体,消息 体中描述了媒体流发送者发送媒体流的IP、端口、媒体格式、SSRC字段等内容
- 5:SIP服务器收到媒体流发送者返回的200OK 响应后,向媒体服务器发送 ACK 请求,请求 中携带消息4中媒体流发送者回复的200OK 响应消息体,完成与媒体服务器的Invite会话 建立过程
- 6:SIP服务器收到媒体流发送者返回的200OK 响应后,向媒体流发送者发送 ACK 请求,请 求中不携带消息体,完成与媒体流发送者的Invite会话建立过程
- 7:SIP服务器向媒体流接收者发送Invite消息,此消息不携带SDP消息体
- 8:媒体流接收者收到SIP服务器的Invite请求后,回复200OK 响应,携带SDP消息体,消息 体中描述了媒体流接收者接收媒体流的IP、端口、媒体格式等内容
- 9:SIP服务器收到媒体流接收者返回的200OK 响应后,向媒体服务器发送Invite请求,请求 中携带消息8中媒体流接收者回复的200OK 响应消息体,s字段为“Play”代表实时点播,增 加y字段描述SSRC值
- 10:媒体服务器收到SIP服务器的Invite请求后,回复200OK 响应,携带SDP消息体,消息体 中描述了媒体服务器发送媒体流的IP、端口、媒体格式、SSRC字段等内容
- 11:SIP服务器收到媒体服务器返回的200OK 响应后,向媒体流接收者发送 ACK 请求,请求 中携带消息10中媒体服务器回复的200OK 响应消息体,完成与媒体流接收者的Invite会话 建立过程
- 12:SIP服务器收到媒体服务器返回的200OK 响应后,向媒体服务器发送 ACK 请求,请求中 不携带消息体,完成与媒体服务器的Invite会话建立过程
- 13:SIP服务器向媒体流接收者发送 BYE 消息,断开消息7、8、11建立的同媒体流接收者的 Invite会话
- 14:媒体流接收者收到 BYE消息后回复200OK 响应,会话断开
- 15:SIP服务器向媒体服务器发送 BYE 消息,断开消息9、10、12建立的同媒体服务器的Invite 会话
- 16:媒体服务器收到 BYE消息后回复200OK 响应,会话断开
- 17:SIP服务器向媒体服务器发送 BYE 消息,断开消息1、2、5建立的同媒体服务器的Invite 会话
- 18:媒体服务器收到 BYE消息后回复200OK 响应,会话断开
- 19:SIP 服务器向媒体流发送者发送 BYE 消息,断开消息3、4、6建立的同媒体流发送者的 Invite会话
- 20:媒体流发送者收到 BYE消息后回复200OK 响应,会话断开

注：invite不携带SDP时，响应的SDP数据包含的ip和端口为接收媒体流的端口。



### 录像回放

​		选择开始结束时间进行视音频文件下载，满足以下基本要求：

- SIP服务器接收到媒体接收者发送的文件下载请求后，向媒体流发送者发送媒体文件下载命令
  - `Gb28181`标准中，明确说明历史视音频的回复控制命令应采用`MANSRTSP`，并采用`INFO`消息体携带传输
    - `GBT 28181-2016 4.3.5`
  - 采用RTP传输，媒体流直接保存为媒体文件
  - 媒体回放控制命令引用 `MANSRTSP`协议中的` Play、Pause、Teardown`的请求消息和应答消息
  - 媒体流接收者可以是用户客户端或联网系统，媒体流发送者可以是媒体设备或联网系统
- 媒体流接收者或 `SIP`服务器可通过配置查询等方式获取媒体流发送者支持的下载发送倍速，并在请求的 `SDP `消息体中携带指定下载倍速。
  - 媒体流发送者可在 `Invite `请求对应的`200 OK `响应` SDP  `消息体中，扩展携带下载文件的大小参数以便于媒体流接收者计算下载进度，当媒体流发送者不能提供文件大小参数时
  - 媒体流接收者应支持根据码流中取得的时间计算下载进度
- 视音频文件下载采用媒体流保活机制



![img](https://i0.hdslb.com/bfs/new_dyn/acdbcd53137d438889f057dff4fde261407536888.png@1256w_1648h_!web-article-pic.webp)

> - 信令1、8、9、10、11、12为 SIP 服务器接收到客户端的呼叫请求后通过B2BUA  代理方式建立 媒体流接受者与媒体服务器之间的媒体链接信令过程
> - 信令2～7为 SIP  服务器通过三方呼叫控制建立 媒体服务器与媒体流之间的媒体链接信令过程
> - 信令13～16 为媒体流发送者回放、下载到文件结束向 媒体接收者发送下载完成的通知消息过程
> - 信令17～20为断开媒体流接收者断开与媒体服务器之间的 媒体链接信令过程
> - 信令21～24 为 SIP  服务器断开媒体服务器与媒体流发送者之间的媒体链接信令过程 



​		命令流程描述如下：

- 1:媒体流接收者向SIP  服务器发送 Invite  消息，消息头域中携带 Subject  字段，表明点播的视 频源 ID、发送方媒体流序列号、媒体流接收者 ID、接收端媒体流序列号标识等参数，SDP  消息 体中s 字段为“Download”  代表文件下载，u 字段代表下载通道 ID 和下载类型，t 字段代表下载 时间段，可扩展a 字段携带下载倍速参数，规定此次下载设备发流倍速，若不携带则默认为1倍速
- 2:SIP  服务器收到 Invite  请求后，通过三方呼叫控制建立媒体服务器和媒体流发送者之间的媒体连接。向媒体服务器发送 Invite  消息，此消息不携带 SDP  消息体
- 3:媒体服务器收到 SIP  服务器的 Invite  请求后，回复200 OK  响应，携带 SDP 消息体，消息体中描述了媒体服务器接收媒体流的IP、端口、媒体格式等内容
- 4:SIP  服务器收到媒体服务器返回的200 OK  响应后，向媒体流发送者发送 Invite  请求，请求 中携带消息3中媒体服务器回复的200 OK 响应消息体，s 字段为“Download” 代表文件下 载，u 字段代表下载通道 ID 和下载类型，t 字段代表下载时间段，增加 y 字段描述 SSRC  值 ，f字段描述媒体参数，可扩展a 字段携带下载倍速，将倍速参数传递给设备
- 5:媒体流发送者收到 SIP  服务器的 Invite  请求后，回复200 OK  响应，携带 SDP  消息体，消息 体中描述了媒体流发送者发送媒体流的 IP、端口、媒体格式、SSRC 字段等内容，可扩展 a 字段携带文件大小参数
- 6:SIP  服务器收到媒体流发送者返回的200 OK  响应后，向媒体服务器发送 ACK  请求，请求 中携带消息5中媒体流发送者回复的200 OK  响应消息体，完成与媒体服务器的 Invite  会话建立过程
- 7:SIP  服务器收到媒体流发送者返回的200 OK  响应后，向媒体流发送者发送 ACK  请求，请求中不携带消息体，完成与媒体流发送者的 Invite  会话建立过程
- 8:完成三方呼叫控制后，SIP  服务器通过 B2BUA  代理方式建立媒体流接收者和媒体服务器之间的媒体连接。在消息1中增加 SSRC 值，转发给媒体服务器
- 9:媒体服务器收到 Invite  请求，回复200 OK  响应，携带 SDP  消息体，消息体中描述了媒体服务器发送媒体流的 IP、端口、媒体格式、SSRC 值等内容
- 10:SIP   服务器将消息9转发给媒体流接收者，可扩展a 字段携带文件大小参数
- 11: 媒体流接收者收到200 OK 响应后，回复 ACK 消息，完成与 SIP 服务器的 Invite  会话建立过程
- 12:SIP  服务器将消息11转发给媒体服务器，完成与媒体服务器的 Invite  会话建立过程
- 13:   媒体流发送者在文件下载结束后发送会话内 Message  消息，通知 SIP  服务器回放已结束，消息体格式应符合 A.2.5.4  媒体通知的要求
- 14:SIP  服务器收到消息17后转发给媒体流接收者
- 15:媒体流接收者收到消息18后回复200 OK 响应，进行链路断开过程
- 16:SIP  服务器将消息19转发给媒体流发送者
- 17:媒体流接收者向 SIP 服务器发送 BYE 消息，断开消息1、10、11建立的同媒体流接收者的Invite  会话
- 18:SIP   服务器收到 BYE 消息后回复200 OK  响应，会话断开
- 19:SIP  服务器收到 BYE  消息后向媒体服务器发送 BYE  消息，断开消息8、9、12 建立的同媒体服务器的 Invite  会话
- 20:媒体服务器收到 BYE 消息后回复200 OK 响应，会话断开
- 21:SIP  服务器向媒体服务器发送 BYE  消息，断开消息2、3、6建立的同媒体服务器的 Invite会话
- 22:媒体服务器收到 BYE  消息后回复200 OK  响应，会话断开
- 23:SIP   服务器向媒体流发送者发送 BYE  消息，断开消息4、5、7建立的同媒体流发送者的Invite  会话
- 24:媒体流发送者收到 BYE  消息后回复200 OK  响应，会话断开
- 25:SIP服务器向媒体服务器发送BYE消息，断开消息2、3、6建立的同媒体服务器的Invite会话
- 26:媒体服务器收到 BYE消息后回复200OK 响应,会话断开
- 27:SIP服务器向媒体流发送者发送 BYE 消息,断开消息4、5、7建立的同媒体流发送者的 Invite会话
- 28:媒体流发送者收到 BYE消息后回复200OK 响应，会话断开



### 断流

​		发送`BYE`消息来结束流。

- `Call-ID`：该字段判断请求端口哪一路视频



#### SIP服务侧断流

​		主动停止命令的下达或是无人点播等事件的触发

- SIP服务会向指定设备发送BYE消息
- 设备侧收到SIP服务发送的BYE消息后，设备会立即停止正在进行的视频流推送，并向SIP服务回复一个200OK消息
- IP服务收到设备返回的200OK响应，确认推流已经成功停止，向收流媒体告知端口取消监听等资源释放流程

#### 设备侧断流

​		设备侧连不到服务侧端口或者设备侧算力不足等原因

- 设备侧会向SIP服务发送BYE消息
- SIP服务收到设备侧发送的BYE消息后，向收流媒体告知端口取消监听等资源释放流程，并向设备侧回复一个200OK消息
- 设备侧收到设备返回的200OK响应，设备会立即停止正在进行的视频流推送（此流程也可在第一步操作）



### 语音广播

​		语音广播功能实现，用户通过语音输入设备，向前端语音输出设备的语音广播。

- 语音流发送者：语音输入设备，联网系统，SIP服务器
- 语音流接收者：语音输出设备，联网系统

![sip监控域是什么 监控区域什么意思_服务器_18](https://s2.51cto.com/images/blog/202403/20192526_65fac7a6395b056567.png?x-oss-process=image/watermark,size_16,text_QDUxQ1RP5Y2a5a6i,color_FFFFFF,t_30,g_se,x_10,y_10,shadow_20,type_ZmFuZ3poZW5naGVpdGk=/format,webp/resize,m_fixed,w_1184)

命令流程描述如下:

a) 1:SIP服务器向语音流接收者发送语音广播通知消息,消息中通过 To头域标明作为目的地址 的语音流接收者ID,消息采用 Message方法携带。

b) 2:语音流接收者收到语音广播通知消息后,向SIP服务器发送200OK 响应。

c) 3:语音流接收者向SIP服务器发送语音广播应答消息,消息中通过 To头域标明作为目的地 址的SIP服务器ID,消息采用 Message方法携带。

d) 4:SIP服务器收到语音广播应答消息后,向语音流接收者发送200OK 响应。

e) 5:语音流接收者向SIP服务器发送Invite消息,消息中通过 To头域标明作为目的地址的语音 流发送者ID,消息头域中携带Subject字段,表明请求的语音流发送者ID、发送方媒体流序列 号、语音流接收者ID、接收方媒体流序列号等参数,SDP消息体中s字段为“Play”代表实时点 播,m 字段中媒体参数标识为“audio”表示请求语音媒体流。

f) 6:SIP服务器收到Invite请求后,通过三方呼叫控制建立媒体服务器和语音流发送者之间的 媒体连接。向媒体服务器发送Invite消息,此消息不携带SDP消息体。

g) 7:媒体服务器收到SIP服务器的Invite请求后,回复200OK 响应,携带SDP消息体,消息体 中描述了媒体服务器接收媒体流的IP、端口、媒体格式等内容。

h) 8:SIP服务器收到媒体服务器返回的200OK 响应后,向语音流发送者发送Invite请求,消息 中通过 To头域标明作为目的地址的语音流发送者ID,消息头域中携带 Subject字段,表明请 求的语音流发送者ID、发送方媒体流序列号、语音流接收者ID、接收方媒体流序列号等参数, 请求中携带消息7中媒体服务器回复的200OK 响应消息体,s字段为“Play”代表实时点播, m 字段中媒体参数标识为“audio”表示请求语音媒体流,增加y字段描述SSRC值,f字段描述 媒体参数。

i) 9:语音流发送者收到SIP服务器的Invite请求后,回复200OK 响应,携带SDP消息体,消息 体中描述了媒体流发送者发送媒体流的IP、端口、媒体格式、SSRC 字段等内容,s字段为 “Play”代表实时点播,m 字段中媒体参数标识为“audio”表示请求语音媒体流。

j) 10:SIP服务器收到语音流发送者返回的200OK 响应后,向媒体服务器发送 ACK 请求,请求 中携带消息9中语音流发送者回复的200OK 响应消息体,完成与媒体服务器的Invite会话 建立过程。

k) 11:SIP服务器收到语音流发送者返回的200OK 响应后,向语音流发送者发送 ACK 请求,请 求中不携带消息体,完成与语音流发送者的Invite会话建立过程。

l) 12:完成三方呼叫控制后,SIP服务器通过 B2BUA 代理方式建立语音流接收者和媒体服务器 之间的媒体连接。在消息5中增加SSRC值,转发给媒体服务器。

m)13:媒体服务器收到Invite请求,回复200OK 响应,携带SDP消息体,消息体中描述了媒体服 务器发送媒体流的IP、端口、媒体格式、SSRC值等内容,s字段为“Play”代表实时点播,m 字段 中媒体参数标识为“audio”表示请求语音媒体流。

n) 14:SIP服务器将消息13转发给语音流接收者。

o) 15:语音流接收者收到200OK 响应后,回复 ACK 消息,完成与SIP服务器的Invite会话建立 过程。

p) 16:SIP服务器将消息15转发给媒体服务器,完成与媒体服务器的Invite会话建立过程。

q) 17:SIP服务器向语音流接收者发送 BYE消息,断开消息5、14、15建立的Invite会话。

r) 18:语音流接收者收到 BYE消息后回复200OK 响应,会话断开。

s) 19:SIP服务器向媒体服务器发送 BYE 消息,断开消息 12、13、16 建立的同媒体服务器的 Invite会话。

t) 20:媒体服务器收到 BYE消息后回复200OK 响应,会话断开。

u) 21:SIP服务器向媒体服务器发送 BYE消息,断开消息6、7、10建立的同媒体服务器的Invite 会话。

v) 22:媒体服务器收到 BYE消息后回复200OK 响应,会话断开。

w)23:SIP服务器向语音流发送者发送 BYE 消息,断开消息8、9、11建立的同语音流发送者的 Invite会话。

x) 24:语音流发送者收到 BYE消息后回复200OK 响应,会话断开。



### 语音对讲

​		语音对讲功能实现中心用户与前端用户之间的一对一语音对讲功能。 

​		语音对讲功能由下述两个独立的流程组合实现:

- 通过实时视音频点播功能，中心用户获得前端设备的实时视音频媒体流
- 通过语音广播功能，中心用户向前端对讲设备发送实时音频媒体流
  - 语音流的封装格式见C.2.4音频流的 RTP封装定义



## MANSCDP

​		监控报警联网系统控制描述协议，Monitoringand Alarming Network System Control Description Protocol。

​		状态信息报送命令应包括命令类型(CmdType)、设备/系统编码(DeviceID)、是否正常工作(Status)等， 采用`MESSAGE`方法的消息体携带。

- 请求命令
  - `Control`，一个控制动作
  - `Query`，一个查询动作
  - `Notify`，一个通知动作
- 应答命令
  - `Response`，表示一个请求动作的应答



## MANSRTSP

​		联网系统实时流协议



## 平台检测

​		针对国标28181的权威检测机构有公安一所（北京）和公安三所（上海），平台全项检测项目包括：上联、下联、IPC接入、NVR接入、解码器接入等内容。

​		具体过程如下：

1．受检单位向检测中心提出检验申请，填写型式检验申请表及产品委托检验协议。

2．检测中心对受检单位提交的资料进行审核并确定检测费。

3．受检单位缴纳检测费后，中心在5个工作日内安排现场抽（封）样或受检单位将产品按母体数要求送检测中心抽（封）样。

4．抽（封）样工作完成后，由综合部负责将任务下达到各检验部。

5．检验员对受试样品按照相关标准进行检验。检验完成后，检验员编制检验报告，经各检验部审核及中心负责人批准后，盖章并即日起生效。

6．检验报告一式两份，检测中心、受检单位各持一份（原件），可另行交费增加检测报告份数。

7．检验周期一般为20天，若受检单位因业务需要，可向检测中心申请加急业务。





## RTP payload

[全网最全GB/T 28181剖析4️⃣RTP包封装音视频流在这里我们详细剖析一下所谓的国标流具体是什么样子，即RTP包的 - 掘金 (juejin.cn)](https://juejin.cn/post/7418367857018290230)



##  demuxer

### ffmpeg demuxer

​		在FFmpeg中实现了GB28181协议的demuxer

- SIP stack模块，负责SIP协议功能
  - 提供单一功能的SIP接口，比如发送回复消息，发送INVITE/BYE/ACK请求
- GB28181 demuxer模块，负责调用SIP接口与前端设备IPC进行交互，同时解析IPC通过RTP发送过来的MPEG2-PS流
  - 按照FFmpeg上层接口调用顺序与IPC进行相关的交互，同时创建与设备之间的RTP链接
  - 在拿到MPEG2-PS流后进行解析
  - 得到音视频数据流后以packet的形式返回给lavf上层
  - 再依次往FFmpeg上层传

![img](https://raw.githubusercontent.com/Mocearan/picgo-server/main/v2-a90115e324c36142eecca99fa9b81a72_1440w.webp)

> ​		由于FFmpeg只有解析PS流封装的本地视频demuxer，并没有解析PS流的demuxer。因此本文也在本地PS流封装视频demuxer的基础之上实现了PS流的demuxer。
>
> ​		核心思路是
>
> - 从RTP包中解析PS头信息，再根据PS头信息找到PES头，从PES头中取出每个[PES包](https://zhida.zhihu.com/search?content_id=175655808&content_type=Article&match_order=6&q=PES包&zhida_source=entity)的长度。
> - 由于RTP长度限制，一个PES包会被切分成很多份分成多个[RTP包](https://zhida.zhihu.com/search?content_id=175655808&content_type=Article&match_order=3&q=RTP包&zhida_source=entity)传输过来
> - 因此PS demuxer需要缓存这些PES切片，等一个完整的PES包凑齐后再解析取出音视频流
> - 并以packet格式返回上FFmpeg上层模块。
>
> ​		由于IETF RFC22509并没有规定PS流应该如何封装到RTP中，因此PES头可能出现在RTP包的任何位置，demuxer也需要针对不同的情况做处理。

​	ffmpeg gb28181 demuxer只能对单一设备进行管理和拉流。需要管理SIP域中众多设备，需要实现gb28181 server。

- 作为SIP server，管理多设备的注册、保活监控、拉流/停止拉流信令交互；
- 作为[media server](https://zhida.zhihu.com/search?content_id=175655808&content_type=Article&match_order=1&q=media+server&zhida_source=entity)，对外提供HTTP接口，用户可以获取设备信息、对指定设备进行拉流并转推RTMP、停止拉流等操作。

![img](https://raw.githubusercontent.com/Mocearan/picgo-server/main/v2-def1a7de367fb728a052a8412fd22836_1440w.webp)



