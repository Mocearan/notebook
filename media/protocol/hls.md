# hls

---

​		HLS全称为 HTTP Live Streaming，是由苹果公司提出基于HTTP的流媒体网络传输协议。

​		基本原理：

- 将直播的流式数据通过切割成一个个小文件
- 将这些小文件名记录到一个索引文件中
- 播放器先请求索引文件
- 然后再取到对应的切片的文件
- 通过请求一个个小文件实现连续的播放

![图片](https://i0.hdslb.com/bfs/article/4d837cb046568d2a1b4ff855ff2c7f990800527b.png@1256w_488h_!web-article-pic.webp)



​		HLS有两个版本，主要区别在于使用的封装容器不同。

- HLS-mpegts
  - 基于mpegts封装，mpegts因为有出色的纠错能力，常用于广播电视卫星传输
- HLS-fmp4
  - 2017年8月正式进入ISO RFC8216标准，fMP4(分段式MP4)的封装格式正式被HLS支持
  - fMP4不是一种新的封装格式，而是在传统MP4格式基础上增加若干新特性。
    - 传统的MP4因为文件结构所限，所有的索引和数据都是放在一起的，在播放时两者缺一不可，无法实现流式直播。
    - fMP4主要是将MP4文件切割成更细的粒度，播放器可以加载一小部分数据之后就可以进行播放，这样就可以实现直播。 

## 现状

​		传统直播技术使用的传输协议主要是RTMP/HTTP-FLV。 

![图片](https://i0.hdslb.com/bfs/article/622c8e53273522795efd207d8b5f0a25474be8b2.png@1256w_368h_!web-article-pic.webp)

- RTMP/FLV标准已经超过10年没有更新，在兼容性层面已经面临着很大挑战

  - 对h265的支持，当前业界是通过hack的方式进行追加
    - 但如ffmpeg都需要打补丁之后才能支持，各种系统工具支持性较差
    - 甚至也会出现各家hack的方式不同，导致系统无法对接
    - 涉及到出海的业务，由于无法对齐国际标准，难以与海外公司展开技术合作

- 主流的浏览器原生不支持FLV

  - 需要在web端进行一次额外的转封装操作
  - 会有额外开销
  - 在用户设备负载较高时，可能会影响观看体验

- 在流式协议上构建P2P成本较高，通常也会牺牲标准的兼容性

  - 在直播场景中，非常适合p2p的应用，可以极大降低带宽成本

    > [【更新】B站直播P2P上传逻辑及屏蔽 - 哔哩哔哩 (bilibili.com)](https://www.bilibili.com/read/cv36570963/?jump_opus=1)
    >
    > [直播P2P技术1-技术入门 - Sunlnx - 博客园 (cnblogs.com)](https://www.cnblogs.com/Sunlnx/p/5929611.html)



- HLS(fmp4)标准一直处于MPEG标准的维护中

  - 对各种编码器和新技术， 如AV1，VVC支持度非常完善

  - 主流浏览器也支持fmp4格式，省去了中间转封装的开销，可以减少播放端处理压力

- CDN部署更容易

  - 因为HLS是基于文件传输
  - 传统的静态文件CDN只需要少量配置更改就可以支持相关业务，对传输内容不敏感

- HLS(fmp4)在DRM支持性上非常好，可以对版权内容做更好的保护

- 利用切片文件实现P2P较为方便

  - 文件P2P方案在业界成熟
  -  也可以做到比较好的分享率
  - 在直播场景中P2P可以有效节省带宽成本

> 缺点：
>
> ​		hls相对rtmp及httpflv的优点，我想仅仅是能够html5播放，仅此而已，hls本身有很多不好的设计，比如ts文件，ts文件是不停的在http请求，这就相当于http和长连接的区别，不仅带来服务器的资源消耗，还有http报文头一堆冗余信息。这对流媒体直播那金贵流量费来说，这不不是一个好选择。hls还有个致命的问题，那就是延时，本身就是分文件块传输的，延时自然比rtmp高出许多。如果将hls的ts文件缩小，或许稍许降低延时。但hsl真的不是面向大众直播的第一选择。



## m3u8索引文件

​		也称m3u8播放列表。

​		随着直播流的进行，播放列表中的切片文件会进行不停更新，播放器不停的请求索引文件和切片文件下载到媒体数据，进行解码播放，这样就实现了画面直播。

![图片](https://i0.hdslb.com/bfs/article/0c044b8c5def2e364e5d7ef7f05c3a30a886fcb9.png@1256w_1190h_!web-article-pic.webp)