# MQTT

​	[MQTT 协议入门：基础知识和快速教程 | EMQ (emqx.com)](https://www.emqx.com/zh/blog/the-easiest-guide-to-getting-started-with-mqtt)

---

​		MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的"轻量级"通讯协议，该协议构建于TCP/IP协议上，由IBM在1999年发布。适用于资源受限的设备和低带宽、高延迟或不稳定的网络环境。它在物联网应用中广受欢迎，能够实现传感器、执行器和其它设备之间的高效通信。

​		MQTT 所具有的适用于物联网特定需求的特点和功能，使其成为物联网领域最佳的协议之一。

- 轻量级

  ​	采用二进制编码和可变长度编码，使得**消息头的大小尽可能小**，能够在低带宽环境下进行高效的数据传输。在有限的能力下也能实现高效的通信。

- 双向通信

  - MQTT 的发布-订阅模式为设备之间提供了无缝的双向通信方式。

  - 客户端既可以向主题发布消息，也可以订阅接收特定主题上的消息

    > 实现了物联网生态系统中的高效数据交换，而无需直接将设备耦合在一起。这种模式也简化了新设备的集成，同时保证了系统易于扩展。

- 连续、有状态的会话

  - 提供了客户端与 Broker 之间保持有状态会话的能力

  - 系统即使在断开连接后也能记住订阅和未传递的消息。

    > 客户端还可以在建立连接时指定一个保活间隔，这会促使 Broker 定期检查连接状态。如果连接中断，Broker 会储存未传递的消息（根据 QoS 级别确定），并在客户端重新连接时尝试传递它们。这个特性保证了通信的可靠性，降低了因间断性连接而导致数据丢失的风险。

- 可靠性

  - MQTT 支持多种 QoS 等级、会话感知和持久连接，即使在困难的条件下也能保证消息的可靠传递
  - 支持消息的持久化和存储，能够保证消息的可靠传输和传输后的可靠存储

- 安全性

  - MQTT 提供传输层安全（TLS）和安全套接层（SSL）加密功能。
  - MQTT 还通过用户名/密码凭证或客户端证书提供身份验证和授权机制，以保护网络及其资源的访问。
  - 安全对于物联网网络至关重要，因为其经常涉及敏感数据的传输。

- **大规模物联网设备支持**

  > 物联网系统往往涉及大量设备，需要一种能够处理大规模部署的协议。MQTT 的轻量级特性、低带宽消耗和对资源的高效利用使其成为大规模物联网应用的理想选择。
  >
  > 通过采用发布-订阅模式，MQTT 实现了发送者和接收者的解耦，从而有效地减少了网络流量和资源使用。此外，协议对不同 QoS 等级的支持使得消息传递可以根据需求进行定制，确保在各种场景下获得最佳的性能表现。

- 语言支持

  ​	物联网系统包含使用各种编程语言开发的设备和应用。MQTT 具有广泛的语言支持，使其能够轻松与多个平台和技术进行集成，从而实现了物联网生态系统中的无缝通信和互操作性



## 设计规范
​		由于物联网的环境是非常特别的，所以MQTT遵循以下设计原则：
（1）精简，不添加可有可无的功能；
（2）发布/订阅（Pub/Sub）模式，方便消息在传感器之间传递；
（3）允许用户动态创建主题，零运维成本；
（4）把传输量降到最低以提高传输效率；
（5）把低带宽、高延迟、不稳定的网络等因素考虑在内；
（6）支持连续的会话控制；
（7）理解客户端计算能力可能很低；
（8）提供服务质量管理；
（9）假设数据不可知，不强求传输数据的类型与格式，保持灵活性。



## 特性

​		MQTT协议工作在低带宽、不可靠的网络的远程传感器和控制设备通讯而设计的协议，它具有以下主要的几项特性：

- 使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合。

  > 这一点很类似于XMPP，但是MQTT的信息冗余远小于XMPP，,因为XMPP使用XML格式文本来传递数据。

- 对负载内容屏蔽的消息传输。

- 使用TCP/IP提供网络连接。

  > 主流的MQTT是基于TCP连接进行数据推送的，但是同样有基于UDP的版本，叫做MQTT-SN。这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。

- 三种消息发布服务质量：

  - 至多一次

    > 消息发布完全依赖底层TCP/IP网络。会发生消息丢失或重复。
    >
    > 这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。这一种方式主要普通APP的推送，倘若你的智能设备在消息推送时未联网，推送过去没收到，再次联网也就收不到了。

  - 至少一次

    > 确保消息到达，但消息重复可能会发生。

  - 只有一次

    > 确保消息到达一次。
    >
    > 在一些要求比较严格的计费系统中，可以使用此级别。在计费系统中，消息重复或丢失会导致不正确的结果。
    >
    > 这种最高质量的消息发布服务还可以用于即时通讯类的APP的推送，确保用户收到且只会收到一次。

- 小型传输，开销很小（固定长度的头部是2字节），协议交换最小化，以降低网络流量。

  > 非常适合"在物联网领域，传感器与服务器的通信，信息的收集"，要知道嵌入式设备的运算能力和带宽都相对薄弱，使用这种协议来传递消息再适合不过了。

- 使用`Last Will`和`Testament`特性通知有关各方客户端异常中断的机制。

  - Last Will：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。
  - Testament：遗嘱机制，功能类似于Last Will。



## 发布订阅模式

​		MQTT是一个基于客户端-服务器的消息发布/订阅传输协议，用于**解耦消息的发送者和接收者之间的关系。**

**1. 主题（To[pi](https://www.elecfans.com/tags/pi/)c）**：主题是MQTT中消息的标识符，用于指定消息的内容和接收者。主题由一个或多个主题等级（Topic Level）组成，主题等级之间用斜杠（/）分隔。

例如，topic/a/b/c就是一个由三个主题等级组成的主题。

**2. 客户端（Client）**：MQTT中的客户端是指连接到MQTT代理服务器的设备或应用程序，它可以是发布者（Publisher）或订阅者（Subscriber）。

**3. 代理服务器（Broker）**：MQTT中的代理服务器是指负责接收、路由和转发消息的中间件。代理服务器会维护一个或多个主题，客户端可以向代理服务器发布消息或订阅主题。

**4. 发布者（Publisher）**：MQTT中的发布者是指发布消息的客户端。发布者将消息发送到代理服务器，代理服务器会根据消息的主题将其路由到订阅了相应主题的订阅者。

**5. 订阅者（Subscriber）**：MQTT中的订阅者是指订阅主题的客户端。订阅者向代理服务器订阅特定的主题，代理服务器会将订阅者订阅的主题和相关[信息](https://m.hqchip.com/ic/0)保存在订阅列表中。当有新消息发布到订阅者订阅的主题时，代理服务器会将消息发送给订阅者。

​		发布者和订阅者之间是解耦的，它们不需要知道对方的存在和身份，只需要知道相应的主题即可。

​		这种设计模式使得MQTT具有高度的灵活性和扩展性，能够适应不同的应用场景和需求。同时，MQTT还支持多种质量等级，可以根据应用的需求选择不同的质量等级，以实现消息传输的可靠性和效率。

​		MQTT会构建底层网络传输：它将建立客户端到服务器的连接，提供两者之间的一个有序的、无损的、基于字节流的双向传输。

​		当应用数据通过MQTT网络发送时，MQTT会把与之相关的服务质量（QoS）和主题名（Topic）相关连。

- MQTT客户端（应用程序或者设备，它总是建立到服务器的网络连接）

  - 发布其他客户端可能会订阅的信息
  - 订阅其它客户端发布的消息
  - 退订或删除应用程序的消息
  - 断开与服务器连接

- MQTT服务器（"消息代理"（Broker），应用程序或设备。位于消息发布者和订阅者之间）

  - 接受来自客户的网络连接
  - 接受客户发布的应用信息
  - 处理来自客户端的订阅和退订请求
  - 向订阅的客户转发应用程序消息

- 订阅（Subscrip[ti](https://bbs.elecfans.com/zhuti_715_1.html)on）

  - 主题筛选器（Topic Filter）

  - 最大服务质量（QoS）

  - 订阅会与一个会话（Session）关联。

    ​	一个会话可以包含多个订阅。每一个会话中的每个订阅都有一个不同的主题筛选器。

- 会话（Session）

  - 每个客户端与服务器建立连接后就是一个会话，客户端和服务器之间有状态交互。
  - 会话存在于一个网络之间，也可能在客户端和服务器之间跨越多个连续的网络连接。

- 主题名（Topic Name）

  - 连接到一个应用程序消息的标签，该标签与服务器的订阅相匹配。
  - 服务器会将消息发送给订阅所匹配标签的每个客户端。

- 主题筛选器（Topic Filter）

  - 一个对主题名通配符筛选器，在订阅表达式中使用，表示订阅所匹配到的多个主题。

## QoS

​		很多时候，使用 MQTT 协议的设备都运行在网络受限的环境下，而只依靠底层的 TCP 传输协议，并不能完全保证消息的可靠到达。因此，MQTT 提供了 QoS 机制，其核心是设计了多种消息交互机制来提供不同的服务质量，来满足用户在各种场景下对消息可靠性的要求。

​		MQTT 定义了三个 QoS 等级，分别为：

- QoS 0，最多交付一次。
- QoS 1，至少交付一次。
- QoS 2，只交付一次。

[MQTT QoS 0, 1, 2 介绍 | EMQ (emqx.com)](https://www.emqx.com/zh/blog/introduction-to-mqtt-qos)



## 协议格式

### 方法

​		MQTT协议中定义了一些方法（也被称为动作），来于表示对确定资源所进行操作。

​		资源可以代表预先存在的数据或动态生成数据，这取决于服务器的实现。通常来说，资源指服务器上的文件或输出。

- Connect	等待与服务器建立连接
- Disconnect  等待MQTT客户端完成所做的工作，并与服务器断开TCP/IP会话
- Subscribe   等待完成订阅
- UnSubscribe   等待服务器取消客户端的一个或多个topics订阅
- Publish   MQTT客户端发送消息请求

### 结构

​		MQTT数据包由：固定头（Fixed header）、可变头（Variable header）、消息体（payload）三部分构成。

- 固定头（Fixed header）

  ​	数据包类型及数据包的分组类标识。

  - 数据包类型：Byte 1中bits 7-4， 4位的无符号值

  - 标识位：Byte 1中bits 3-0

    ​	在不使用标识位的消息类型中，标识位被作为保留位。如果收到无效的标志时，接收端必须关闭网络连接：

    - DUP：发布消息的副本。

      ​	用来在保证消息的可靠传输，如果设置为1，则在下面的变长中增加MessageId，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。

    - QoS：发布消息的服务质量，即：保证消息传递的次数

      - `00`：最多一次，即：`<=1`
      - `01`：至少一次，即：`>=1`
      - `10`：一次，即：`=1`
      - `11`：预留

    - RETAIN： 发布保留标识，表示服务器要保留这次推送的信息，如果有新的订阅者出现，就把这消息推送给它，如果设有那么推送至当前订阅者后释放。

  -  剩余长度（Remaining Length）：Byte 2

    ​	固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的。这一字节是可以扩展，其保存机制，前7位用于保存长度，后一部用做标识。当最后一位为1时，表示长度不足，需要使用二个字节继续保存。

- 可变头（Variable header）

  ​	数据包类型决定了可变头是否存在及其具体内容。

  ​	可变头的内容因数据包类型而不同，较常的应用是作为包的标识

  ​	很多类型数据包中都包括一个2字节的数据包标识字段，这些类型的包有：PUBLISH (QoS > 0)、PUBACK、PUBREC、PUBREL、PUBCOMP、SUBSCRIBE、SUBACK、UNSUBSCRIBE、UNSUBACK。

- 消息体（Payload）

  具体内容，包含CONNECT、SUBSCRIBE、SUBACK、UNSUBSCRIBE四种类型的消息：
  （1）CONNECT，消息体内容主要是：客户端的ClientID、订阅的Topic、Message以及用户名和密码。
  （2）SUBSCRIBE，消息体内容是一系列的要订阅的主题以及QoS。
  （3）SUBACK，消息体内容是服务器对于SUBSCRIBE所申请的主题及QoS进行确认和回复。
  （4）UNSUBSCRIBE，消息体内容是要订阅的主题。



## 流程

在了解了 MQTT 的基本组件之后，让我们来看看它的一般工作流程：

1. **客户端使用 TCP/IP 协议与 Broker 建立连接**，可以选择使用 TLS/SSL 加密来实现安全通信。客户端提供认证信息，并指定会话类型（Clean Session 或 Persistent Session）。
2. **客户端既可以向特定主题发布消息，也可以订阅主题以接收消息**。当客户端发布消息时，它会将消息发送给 MQTT Broker；而当客户端订阅消息时，它会接收与订阅主题相关的消息。
3. **MQTT Broker 接收发布的消息**，并将这些消息转发给订阅了对应主题的客户端。它根据 QoS 等级确保消息可靠传递，并根据会话类型为断开连接的客户端存储消息。



## 应用模式

**1. 点对点模式（Point-to-Point）**：在点对点模式下，MQTT客户端直接连接到MQTT代理服务器，通过MQTT协议进行消息的传输。

这种模式适用于直接连接的物联网设备和应用程序之间的通信，如[传感器](https://m.elecfans.com/v/tag/117/)和[控制器](https://m.hqchip.com/app/1716)之间的通信。

**2. 发布/订阅模式（Publish/Subscribe）**：在发布/订阅模式下，MQTT客户端通过订阅主题（Topic）来接收感兴趣的消息，通过发布主题来发送消息。

这种模式适用于需要解耦消息发送者和接收者之间的关系的应用场景，如物联网中的实时数据传输、远程控制和状态监测等。

**3. 请求/响应模式（Request/Response）**：在请求/响应模式下，MQTT客户端通过请求主题（Request Topic）向MQTT代理服务器发送请求消息，MQTT代理服务器将请求消息路由到相应的处理程序，并返回响应消息。

这种模式适用于需要请求和响应交互的应用场景，如物联网中的远程管理和控制等。

**4. 点对多模式（Point-to-Multipoint）**：在点对多模式下，一个MQTT客户端可以同时连接到多个MQTT代理服务器，通过MQTT协议进行消息的传输。这种模式适用于需要同时连接多个MQTT代理服务器的应用场景，如物联网中的分布式处理和数据存储等。