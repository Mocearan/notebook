#	IP协议

---



- 不可靠
- 无连接

​		网络传输中，数据都是按照**big endian**来传输。

> 即，高地址字节先发送，低地址字节后发送。
>
> ```c
> 0000 0000 | 0000 0000 | 0000 0000 | 0000 0001 // 1
>   高地址                               低地址
> ```
>
> 而linux等操作系统，按照**little endian**来进行数据存储
>
> ```c
> 0000 0001 | 0000 0000 | 0000 0000 | 0000 0000 // 1
>   高地址                               低地址
>     
>     
> union Test {
>   char u[4],
>   int  i
> };
> 
> bool isLittel()
> {
>     Test t;
>     t.i = 1;
>     return t.u == 1;
> }
> 
> // linux 可以判断 __BYTE_ORDER__ == __LITTLE_ENDIAN__
> ```

​		不同传输媒介导致IP帧类型不同，如以太网帧、令牌环帧。

## 网络地址

- IPv4， 四字节地址族
- IPv6， 16字节地址族

![image-20220316224943855](https://gitee.com/masstsing/picgo-picserver/raw/master/image-20220316224943855.png)

## 报文格式

![image-20230422205553544](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20230422205553544.png)

![image-20230422205233045](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20230422205233045.png)

![image-20230422205330239](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20230422205330239.png)

-   版本

    4位，指定IP协议的版本。对于IPv4来说，其值是4.IPv6字段值为6

-   首部长度

    4位（最大值为15），表示有多少个4字节，所以首部长度最大为60个字节。

-   服务类型TOS

    8位，包括一个3位的优先权字段（现已忽略），4位的TOS字段和1位的保留字段（必须置0）

    >   4位的TOS字段分别表示：最小延时，最大吞吐量，最高可靠性和最小费用。
    >
    >   ![image-20210902171143686](https://gitee.com/masstsing/picgo-picserver/raw/master/20210902171143.png)

-   总长度

    16位，指整个IP数据报的长度，包含IP头部长度和数据部分长度，以字节为单位，因此IP数据报的最大长度为65535字节。

    >   但由于MTU的限制，长度超过MTU的数据报都将被分片传输，所以实际传输的IP数据报的长度都远远没有达到最大值

-   标识

    16位，唯一地标识主机发送地每一个数据报。其初始值由系统随机生成，每发送一个数据报，其值就加1.

    >   ​		该值在数据报分片时被复制到每个分片中，因此同一个数据报地所有分片都具有相同地标识。

-   标志

    3位

    -   第一位保留

    -   第二位表示"禁止分片"  DF

        >   ​		如果设置了这个位，IP模块将不对数据报进行分片。在这种情况下，如果IP数据报长度超过MTU的话，IP模块将丢弃该数据报并返回一个ICMP差错报文。

    -   第三位表示“更多分片” MF

        >   ​		除了数据报的最后一个分片外，其他分片都为1， 表示后续有分片。

-   片偏移

    13位，分片偏移是分片相对原始IP数据报开始处(仅指数据部分)的偏移。通过片偏移移植接收端可以重新组装IP包

    >   实际的偏移值是该值左移3位（乘8）后得到的。由于这个原因，除了最后一个IP分片外，每个IP分片的数据部分的长度必须是8的整数倍(这样才能保证后面的IP分片拥有一个合适的偏移量)。

-   TTL

    8位，TTL（Time To Live）表示数据包最多可经过的路由器的数量。

    >   TTL值被发送端设置(常见值位64)。数据报在转发过程中每经过一个路由，该值就被路由器减1。当TTL值减为0时，路由器将丢弃数据报，并向源端发送一个ICMP差错报文。TTL值可以防止数据报陷入路由循环。

-   协议类型

    8位，区分IP层上承载的上层协议。在封装与分用过程中，协议栈知道该交给哪个层的协议处理。

    >   /etc/protocols文件定义了所有上层协议对应的protocol字段的数值。其中ICMP是1，2 IGMP，TCP是6，UDP是17。

-   头部校验和

    16位，由发送端填充，保证数据报头部的数据完整性，接收端对其使用CRC算法以检验IP数据报头部在传输过程中是否损坏。但不包括数据部分。

    >   这样做的目的：
    >
    >   -   所有将数据封装在IP数据包中的高层协议均含有覆盖整个数据的校验和。因此IP数据报没有必要再对其所承载的数据部分进行校验。
    >   -   每经过一个路由器，IP数据报的头部要发生改变，而数据部分不变，这样只对发生改变的头部进行校验，显然不会浪费太多的时间。为了减少计算时间，一般不用CRC校验码，而是采用更简单的网际校验和。

-   源IP地址

    32位，发送数据的主机IP地址。

-   目的IP地址

    32位，接收数据的主机IP地址。

>   一般情况下，这两个地址在整个数据报的传递过程中保持不变，而不论它中间经过多少个中转路由器。

-   选项与填充

    4的整数倍字节，否则用0填充。这部分最多包含40个字节，因为IP头部最长是60字节（其中还包含前面讨论的20字节的固定部分）。可用的IP选项包括：

    -   安全和处理限制

    -   路径记录

        >   记录所经历路由器的IP地址

    -   时间戳

        >   记录所经历路由器的IP地址和时间

    -   宽松源站路由

        >   指定数据报文必须经历的IP地址，可以经过没有指定的IP地址

    -   严格源站路由

        >   指定数据报文必须经历的IP地址，不能经过没有指定的IP地址。



> [IP协议详解 - Red_Code - 博客园 (cnblogs.com)](https://www.cnblogs.com/red-code/p/7132023.html)
>
> [(100条消息) IP协议详解（一）_至尊灬宝的博客-CSDN博客_ip协议](https://blog.csdn.net/qq_42058590/article/details/82918678)
>
> [(100条消息) IP协议详解_CC_YXK的博客-CSDN博客_ip协议](https://blog.csdn.net/qq_41727218/article/details/82461089)
>
> [图解IP协议（一） IP协议原理与实践 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/29287795)



## MTU

​		MTU（max transmit unit）最大传输单元，是帧最多能携带的上层协议数据。通常受网络类型的限制。

​		以太网帧的MTU是1500字节，过长的上层协议数据可能造成IP数据包分片传输（fragment）。

## 网际校验和 

​		Internet Checksum

​		发送方将要发送的数据划分为许多16位序列（如果数据字节数为奇数，则在末尾补一字节0凑成偶数）。对这些序列反码求和，便得到校验和。

>   ![image-20210902175805666](https://gitee.com/masstsing/picgo-picserver/raw/master/20210902175805.png)

​		如果数据在传输过程中没有发生任何差错，那么接收方计算校验和的结果应该为全1，如果结果不是全1，即校验和错误。





## 路由

- 搜索匹配的主机地址

- 搜索网络地址

- 搜索默认表项

![image-20210902231523236](https://gitee.com/masstsing/picgo-picserver/raw/master/image-20210902231523236.png)

