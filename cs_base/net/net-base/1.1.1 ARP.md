# ARP

---

​		ARP协议实现任意网络层地址到任意物理地址的转换，一般是从IP地址到以太网地址（MAC地址）的转换。

​		工作原理是：

- 主机向自己所在的网络广播一个ARP请求，请求包含目标机器的网络地址
- 网络上的其他机器都将收到这个请求，但只有被其你去的目标机器会回应一个ARP应答，其中包含自己的物理地址

![image-20230422210517303](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20230422210517303.png)

- 硬件类型：定义物理地址的类型
  - `1`，MAC地址
- 协议类型：表示要映射的协议地址类型
  - `0x800`，IP地址
- 硬件地址长度：MAC地址长度为6，单位字节
- 协议地址长度：IP地址长度为4，单位字节
- 操作字段：
  - `1`，ARP请求
  - `2`，ARP应答
  - `3`，RARP请求
  - `4`，RARP应答
- 其余四个字段指定通信双方以太网地址和IP地址
  - 发送端填充除目的端以太网地址外的其他三个字段，构建ARP请求
  - 接收端填充自己的以太网地址，交换目的端和发送端的两个地址，修改操作字段为`2`，构建ARP应答

​		ARP报文长度为28字节，加上以太网帧头部和尾部18字节，共46字节。部分实现要求至少46字节，则需要增加填充字节，达到64字节。



## ARP高速缓存

​		ARP维护一个高速缓存，其中包含经常访问或最近访问的机器IP地址到物理地址的映射（如网关地址），避免重复的ARP请求，提高发送数据包的速度。

```shell
# 查看ARP缓存
[root@VM-4-7-centos ~]# arp -a
gateway (10.0.4.1) at fe:ee:8f:bf:86:99 [ether] on eth0 # 网关地址
? (169.254.128.2) at fe:ee:8f:bf:86:99 [ether] on eth0

# 删除ARP缓存
[root@VM-4-7-centos ~]# arp -d 169.254.0.83

# 添加ARP缓存
[root@VM-4-7-centos ~]# arp -s 169.254.0.83 fe:ee:8f:bf:86:99
```



## ARP通信

- 清除ARP缓存中对应的项

  `sudo arp -d 192.168.1.109`

- 抓包

  ​	`sudo tcpdump -i eth0 -ent '{dst 192.168.1.109 and src 192.168.1.108} or {dst 192.168.1.108 and src 192.168.1.109}'`

  - 抓到的数据包中最靠前的两条和ARP通信有关
  - `tcpdump`抓取的数据包本质上是以太网帧，通过该命令的众多选项来控制帧的过滤（`dst / src`过滤）和显示（`-e`开启以太网帧头部信息的显示）

- `telnet`登录对端

  ​	`telnet 192.168.1.109 echo`

  - tcp连接后，telnet输出`Connected to 192.168.1.109`
  - 输入`Ctrl+]`调出telnet程序的命令提示符
  - 输入`quit`退出`telnet client`，ARP通信在TCP连接建立之前就已经完成了

- ![image-20230524221156750](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20230524221156750.png)

  - ` * > *`表示源端的物理地址到目标端的物理地址，是以太网的广播地址，表示整个LAN。该LAN上所有的机器都会收到并处理这样的帧。
  - `0x806`数值是以太网帧头部的类型字段的值，表示分用的目标是ARP模块
  - `42`表示以太网帧的长度，实际上是46字节，tcpdump未统计以太网帧尾部4字节的CRC字段
  - 数据部分长度为28字节
  - `Request`表示为ARP请求，`Reply`表示为一个ARP应答
    - `who-has * tell *`表示前者要查询后者的IP地址
    - `* is-at *`表示目标报告物理地址

![image-20230524221859239](https://raw.githubusercontent.com/Mocearan/picgo-server/main/image-20230524221859239.png)

- 两次传输的以太网帧按照以太网帧封装格式在下方展示
- ARP请求和应答是从以太网驱动程序发出的，而并非图中从ARP模块直接发送到以太网上，故用虚线
  - 体现携带ARP数据的以太网帧和其他如携带IP数据报的以太网帧的区别
- 路由器也将收到以太网帧I，因为该帧是一个广播帧。路由器并不回应其中的ARP请求。